# b3-発注詳細 - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b3-発注詳細 |
| **界面编号** | b3 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b3-発注詳細 是订单详情页面，提供订单详细信息展示、月间运行指示书的编辑和发送功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- 輸送パートナー情報表示
- 状態進捗表示
- 月間運行指示書編集
- アクション履歴表示
- メッセージ交流

### 1.5 适用范围
- 前端开发人员（详情页面组件实现）
- 后端开发人员（订单/指示书API开发）
- 测试工程师（详情功能测试）

---

## 2. 页面元素

### 2.1 元素清单

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | 輸送パートナー情報 | 表示区域 | 輸送パートナーID/名 | - |
| ⑵ | 状態表示 | 表示区域 | 会社コード/ステータス/version/指示書送付/承諾 | - |
| ⑶ | 月間運行指示書 | テーブル | 指示书表格 | 編集/保存/送付 |
| ⑷ | アクション履歴 | リスト | 行为历史 | 表示 |
| ⑸ | メッセージ | パネル | 消息交流 | 表示/入力/送信 |

### 2.2 version字段说明
| 场景 | 元素类型 | 说明 |
|------|----------|------|
| 状態区域version | Text（只读） | 显示月度运行指示书的最新version（数字） |
| 指示书表格上方version选择 | Select（下拉选择） | プルダウン选择不同的version进行查看/编辑 |

### 2.3 指示書送付和承諾字段
| 字段 | 元素类型 | 说明 |
|------|----------|------|
| 指示書送付 | Text（只读） | 輸送パートナーへ指示書を送付した日時を表示する |
| 承諾 | Text（只读） | 輸送パートナーが承諾した日時を表示する（未承諾の場合は空白） |

### 2.2 月間運行指示書字段

| 字段 | 元素类型 | 功能说明 | 交互 |
|------|----------|----------|------|
| version | Select | 月間運行指示書のversion選択 | プルダウン选择 |
| チェックボックス | Checkbox | 选择指示 | 一括操作 |
| 支点/営業所 | Select | 分支选择 | プルダウン |
| ステータス | Tag | 承認状態 | 表示/切换 |
| 線便 | Text | 线路编号 | 表示 |
| AM/発 | Button | 日期切换 | 〇/空栏切换 |
| 着 | Button | 日期切换 | 〇/空栏切换 |
| 系統 | Text | 系统 | 表示 |
| 線便名 | Text | 线路名称 | 表示 |
| 入庫場所 | Text | 入库场所 | 表示 |
| 入庫時間 | Text | 入库时间 | 表示 |
| 使用車両 | Text | 使用车辆 | 表示 |
| 火/水/木/金/土/日 | Button | 日期标记 | 〇/空栏切换 |
| 指示書送付 | Text | 送付日時 | 表示（只读） |
| 承諾 | 承諾日時 | 承諾状态 | 表示（只读） |

---

## 3. 交互流程

### 3.1 页面加载流程
| 步骤 | 行为 | 系统响应 |
|------|------|----------|
| 1 | 页面初始化 | 获取订单ID |
| 2 | 获取订单详情 | 查询数据库 |
| 3 | 获取指示书 | 显示指示书表格 |
| 4 | 获取アクション履歴 | 显示历史记录 |

### 3.2 指示书编辑流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击編集按钮 | 进入编辑模式 |
| 2 | 点击日期格子 | 显示吹き出し |
| 3 | 输入変更内容 | 背景強調表示 |
| 4 | 点击変更を保存 | 保存数据 |
| 5 | 保存成功 | 显示成功提示 |

### 3.3 送付流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击送付按钮 | 显示确认对话框 |
| 2 | 确认发送 | 执行发送 |
| 3 | 发送成功 | 更新状态 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | 多区域组合 | - | 信息+表格+面板 |

### 4.2 表格规范
| 属性 | 值 |
|------|-----|
| **行高** | 固定高度 |
| **列宽** | 根据内容自适应 |
| **边框** | 1px solid #E0E0E0 |
| **斑马纹** | 偶数行浅灰色背景 |

### 4.3 状态颜色
| 状态 | 颜色 | 说明 |
|------|------|------|
| 承認済 | 绿色 | 已承认 |
| 未承認 | 橙色 | 未承认 |
| 差戻し | 红色 | 退回 |
| 強調 | 黄色背景 | 变更内容 |

---

## 5. API接口设计

### 5.1 订单详情API

```yaml
# 获取订单详情
GET /api/v1/orders/{orderId}
Authorization: Bearer {token}
```

### 5.2 指示书API
```yaml
# 获取指示书列表
GET /api/v1/orders/{orderId}/instructions
Authorization: Bearer {token}

# 保存指示书变更
PUT /api/v1/orders/{orderId}/instructions
Authorization: Bearer {token}
Body: { changes: [...] }

# 送付指示書
POST /api/v1/orders/{orderId}/send
Authorization: Bearer {token}
```

### 5.3 アクション履歴API
```yaml
# 获取历史记录
GET /api/v1/orders/{orderId}/history
Authorization: Bearer {token}
```

### 5.4 メッセージAPI
```yaml
# 获取消息列表
GET /api/v1/orders/{orderId}/messages
Authorization: Bearer {token}

# 发送消息
POST /api/v1/orders/{orderId}/messages
Authorization: Bearer {token}
Body: { content: string, attachments: [...] }
```

---

## 5.5 画面-接口-数据库关系映射

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|--------------|--------------|----------|
| **页面加载** | GET /api/v1/orders/{orderId} | 获取订单详情（基本信息、状态） | t_order, m_partner | order_id → t_order.id; partner_id → m_partner.partner_id |
| **輸送パートナー情報** | GET /api/v1/orders/{orderId} | 显示运输伙伴ID和名称 | m_partner | partner_id, partner_name, sub_account |
| **狀態表示** | GET /api/v1/orders/{orderId} | 显示公司代码、状态、version、送付日期、承諾日期 | t_order, t_order_status | company_code, status, version, sent_date, accepted_date |
| **version选择** | GET /api/v1/orders/{orderId}/instructions | 获取指定version的指示书列表 | t_instruction | order_id, version |
| **指示书表格** | GET /api/v1/orders/{orderId}/instructions | 获取指示书明细数据（日期标记、线路信息等） | t_instruction_detail | instruction_id, line_no, station_code, line_code, mon/tue/wed/thu/fri/sat/sun |
| **指示书编辑** | PUT /api/v1/orders/{orderId}/instructions | 保存指示书变更（日期标记、状态等） | t_instruction_detail, t_instruction | 更新 mon/tue/wed/thu/fri/sat/sun, status; 记录 version |
| **送付指示書** | POST /api/v1/orders/{orderId}/send | 发送指示书给运输伙伴，更新送付日期和状态 | t_order, t_action_log | 更新 sent_date, status; 插入操作日志 |
| **アクション履歴** | GET /api/v1/orders/{orderId}/history | 获取操作历史记录 | t_action_log, m_user | order_id → t_action_log; user_id → m_user.user_id; action_type, action_time, action_content |
| **メッセージ表示** | GET /api/v1/orders/{orderId}/messages | 获取消息列表 | t_message, m_user | order_id → t_message; sender_id → m_user.user_id; content, is_read, created_at |
| **メッセージ送信** | POST /api/v1/orders/{orderId}/messages | 发送消息到订单 | t_message | 插入 order_id, sender_id, content, attachments, is_read: false |
| **代理承諾** | POST /api/v1/orders/{orderId}/accept | 代理承諾，更新承諾日期和状态 | t_order, t_action_log | 更新 accepted_date, status; 插入操作日志 |

#### 关系说明

1. **页面加载流程**
   - 前端调用 `GET /api/v1/orders/{orderId}`
   - 查询 `t_order` 表获取订单基本信息
   - 关联查询 `m_partner` 表获取运输伙伴信息
   - 关联查询 `t_order_status` 表获取订单状态
   - 返回：order_id, company_code, status, version, sent_date, accepted_date, partner_name

2. **指示书加载流程**
   - 前端调用 `GET /api/v1/orders/{orderId}/instructions`
   - 查询 `t_instruction` 表获取指示书主信息
   - 关联查询 `t_instruction_detail` 表获取指示书明细（每行数据）
   - 返回：指示书表格数据（支点、线路、日期标记、状态等）

3. **指示书编辑流程**
   - 用户点击日期格子或状态按钮
   - 前端收集变更内容
   - 调用 `PUT /api/v1/orders/{orderId}/instructions`
   - 后端更新 `t_instruction_detail` 表的相关字段
   - 如果是新版本，插入新的 `t_instruction` 记录
   - 插入 `t_action_log` 记录编辑操作

4. **送付指示書流程**
   - 用户点击送付按钮
   - 前端调用 `POST /api/v1/orders/{orderId}/send`
   - 后端更新 `t_order.sent_date` 为当前时间
   - 更新 `t_order.status` 为"送付済"
   - 插入 `t_action_log` 记录送付操作
   - 发送邮件通知（异步任务）

5. **アクション履歴显示**
   - 前端调用 `GET /api/v1/orders/{orderId}/history`
   - 查询 `t_action_log` 表获取操作记录
   - 关联 `m_user` 表获取操作人姓名
   - 返回：action_time, user_name, action_type, action_content

6. **メッセージ流程**
   - 显示：调用 `GET /api/v1/orders/{orderId}/messages`，查询 `t_message` 表
   - 发送：调用 `POST /api/v1/orders/{orderId}/messages`，插入 `t_message` 记录

#### 数据流示意

```
前端 (b3-発注詳細)
    │
    ├─ [页面加载] ───────────────→ GET /api/v1/orders/{orderId}
    │                              │
    │                              ├─→ 查询 t_order (order_id, company_code, status, version, sent_date, accepted_date)
    │                              ├─→ 查询 m_partner (partner_id, partner_name, sub_account)
    │                              └─→ 查询 t_order_status (status_name)
    │
    ├─ [指示书加载] ───────────→ GET /api/v1/orders/{orderId}/instructions
    │                              │
    │                              ├─→ 查询 t_instruction (instruction_id, version, created_at)
    │                              └─→ 查询 t_instruction_detail (line_no, station_code, line_code, am/dep, arr, system, line_name, storage_place, storage_time, vehicle, mon/tue/wed/thu/fri/sat/sun)
    │
    ├─ [指示书编辑] ───────────→ PUT /api/v1/orders/{orderId}/instructions
    │                              │
    │                              ├─→ 更新 t_instruction_detail (日期标记, status)
    │                              └─→ 插入 t_action_log (编辑操作)
    │
    ├─ [送付指示書] ───────────→ POST /api/v1/orders/{orderId}/send
    │                              │
    │                              ├─→ 更新 t_order (sent_date, status)
    │                              ├─→ 插入 t_action_log (送付操作)
    │                              └─→ 发送邮件通知
    │
    ├─ [代理承諾] ─────────────→ POST /api/v1/orders/{orderId}/accept
    │                              │
    │                              ├─→ 更新 t_order (accepted_date, status)
    │                              └─→ 插入 t_action_log (承諾操作)
    │
    ├─ [アクション履歴] ───────→ GET /api/v1/orders/{orderId}/history
    │                              │
    │                              ├─→ 查询 t_action_log (action_id, order_id, user_id, action_type, action_time, action_content)
    │                              └─→ 关联 m_user (user_name)
    │
    ├─ [メッセージ表示] ───────→ GET /api/v1/orders/{orderId}/messages
    │                              │
    │                              ├─→ 查询 t_message (message_id, order_id, sender_id, content, is_read, created_at)
    │                              └─→ 关联 m_user (sender_name)
    │
    └─ [メッセージ送信] ───────→ POST /api/v1/orders/{orderId}/messages
                                   │
                                   └─→ 插入 t_message (order_id, sender_id, content, attachments, is_read: false)
```

#### 核心数据表结构

**t_order (订单主表)**
```sql
id BIGSERIAL PRIMARY KEY
order_id VARCHAR(20) UNIQUE NOT NULL
company_code VARCHAR(20) NOT NULL
partner_id VARCHAR(20) NOT NULL
year_month VARCHAR(7) NOT NULL  -- YYYY-MM
status VARCHAR(20) NOT NULL
version INTEGER NOT NULL
sent_date TIMESTAMP
accepted_date TIMESTAMP
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (partner_id) REFERENCES m_partner(partner_id)
```

**t_instruction (指示书主表)**
```sql
id BIGSERIAL PRIMARY KEY
instruction_id VARCHAR(20) UNIQUE NOT NULL
order_id VARCHAR(20) NOT NULL
version INTEGER NOT NULL
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (order_id) REFERENCES t_order(order_id)
```

**t_instruction_detail (指示书明细表)**
```sql
id BIGSERIAL PRIMARY KEY
detail_id VARCHAR(20) UNIQUE NOT NULL
instruction_id VARCHAR(20) NOT NULL
line_no INTEGER NOT NULL
station_code VARCHAR(20)
line_code VARCHAR(20)
am_dep CHAR(1)  -- '〇' or ''
arr CHAR(1)
system VARCHAR(50)
line_name VARCHAR(200)
storage_place VARCHAR(100)
storage_time VARCHAR(10)
vehicle VARCHAR(100)
mon CHAR(1)
tue CHAR(1)
wed CHAR(1)
thu CHAR(1)
fri CHAR(1)
sat CHAR(1)
sun CHAR(1)
status VARCHAR(20)
FOREIGN KEY (instruction_id) REFERENCES t_instruction(instruction_id)
```

**t_action_log (操作日志表)**
```sql
id BIGSERIAL PRIMARY KEY
log_id VARCHAR(20) UNIQUE NOT NULL
order_id VARCHAR(20) NOT NULL
user_id VARCHAR(100) NOT NULL
action_type VARCHAR(50) NOT NULL  -- CREATE/UPDATE/DELETE/SEND/ACCEPT
action_content TEXT
action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (order_id) REFERENCES t_order(order_id)
FOREIGN KEY (user_id) REFERENCES m_user(user_id)
```

**t_message (消息表)**
```sql
id BIGSERIAL PRIMARY KEY
message_id VARCHAR(20) UNIQUE NOT NULL
order_id VARCHAR(20) NOT NULL
sender_id VARCHAR(100) NOT NULL
content TEXT NOT NULL
attachments JSONB
is_read BOOLEAN DEFAULT FALSE
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (order_id) REFERENCES t_order(order_id)
FOREIGN KEY (sender_id) REFERENCES m_user(user_id)
```

---

## 6. 前端实现

### 6.1 指示书表格组件
```typescript
// 指示书表格组件
import { Table, Button, Tag, Tooltip } from 'antd';
import { EditOutlined, SaveOutlined } from '@ant-design/icons';

export const InstructionTable: React.FC = () => {
  const [editing, setEditing] = useState(false);
  const [data, setData] = useState([]);

  const handleCellClick = (record, field) => {
    if (!editing) return;
    // 显示吹き出し编辑
  };

  return (
    <Table
      dataSource={data}
      columns={columns}
      rowKey="lineNo"
      pagination={false}
    />
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 正确显示订单详情
- [ ] 正确显示指示书表格
- [ ] 编辑功能正常
- [ ] 保存功能正常
- [ ] 送付功能正常
- [ ] 代理承諾功能正常
- [ ] メッセージ功能正常

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] 表格显示正确
- [ ] 状态颜色正确

### 7.3 性能验收
- [ ] 页面加载 < 3秒
- [ ] 表格渲染 < 2秒
- [ ] 保存操作 < 1秒

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10| v1.0.1 | 添加画面-接口-数据库关系映射表 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b2-発注検索 | [../b2-発注検索/05_设计规范.md](../b2-発注検索/05_设计规范.md) | 列表页面设计规范 |

### A.2 与p3-発注詳細对比
| 特性 | b3-発注詳細 | p3-発注詳細 |
|------|-------------|-------------|
| **用户类型** | ベース | 輸送パートナー |
| **设备支持** | PCのみ | PC/SP |

---

**文档编制**: -  
**编制时间**: 2026-02-XX 
**适用范围**: 別紙_画面一覧_v151.xlsx - b3-発注詳細  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
