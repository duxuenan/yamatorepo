# p0-共通ナビゲーション - 设计规范

## API接口设计

### 1. 获取导航配置

```typescript
// GET /api/v1/navigation/config
interface NavigationConfigResponse {
  success: boolean;
  data: {
    menuItems: MenuItem[];
    userPermissions: string[];
  };
}

interface MenuItem {
  id: string;
  label: string;
  icon: string;
  targetPage: string;
  order: number;
}
```

### 2. 登出接口

```typescript
// POST /api/v1/auth/logout
interface LogoutRequest {
  userId: string;
  sessionToken: string;
}

interface LogoutResponse {
  success: boolean;
  message: string;
}
```

## 前端组件设计

### 1. 页面组件结构

```
p0-CommonNavigation/
├── index.tsx                    # 主导航组件
├── components/
│   ├── NavigationMenu.tsx       # PC端导航菜单
│   ├── MobileMenu.tsx           # SP端汉堡菜单
│   └── MenuItem.tsx            # 菜单项组件
├── hooks/
│   ├── useNavigation.ts        # 导航hook
│   └── useDeviceType.ts        # 设备类型hook
├── types/
│   └── navigation.ts          # 类型定义
└── utils/
    └── menuConfig.ts           # 菜单配置
```

### 2. 组件代码示例

```tsx
// index.tsx (PC端)
import React from 'react';
import { Menu } from 'antd';
import { useNavigate } from 'react-router-dom';

const menuItems = [
  {
    key: 'orders',
    label: '受注管理',
    onClick: () => navigate('/p2'),
  },
  {
    key: 'results',
    label: '実績確認',
    onClick: () => navigate('/p4'),
  },
  {
    key: 'billing',
    label: '請求確認',
    onClick: () => navigate('/p5'),
  },
  {
    key: 'logout',
    label: 'ログアウト',
    onClick: () => handleLogout(),
  },
];

export const NavigationMenu: React.FC = () => {
  const navigate = useNavigate();

  return (
    <Menu
      mode="inline"
      items={menuItems}
      selectedKeys={[currentPage]}
    />
  );
};
```

```tsx
// MobileMenu.tsx (SP端)
import React, { useState } from 'react';
import { Drawer, List, Button } from 'antd';
import { MenuOutlined } from '@ant-design/icons';

export const MobileMenu: React.FC = () => {
  const [visible, setVisible] = useState(false);

  const showDrawer = () => setVisible(true);
  const onClose = () => setVisible(false);

  return (
    <>
      <Button
        type="text"
        icon={<MenuOutlined />}
        onClick={showDrawer}
      />
      <Drawer
        title="メニュー"
        placement="right"
        onClose={onClose}
        open={visible}
      >
        <List
          dataSource={menuItems}
          renderItem={(item) => (
            <List.Item onClick={item.onClick}>
              {item.label}
            </List.Item>
          )}
        />
      </Drawer>
    </>
  );
};
```

## 后端服务设计

### 1. Controller

```java
@RestController
@RequestMapping("/api/v1/navigation")
@RequiredArgsConstructor
public class NavigationController {

    private final NavigationService navigationService;

    @GetMapping("/config")
    public ResponseEntity<NavigationConfigResponse> getNavigationConfig(
            @AuthenticationPrincipal User user) {
        NavigationConfigResponse response = navigationService.getConfig(user);
        return ResponseEntity.ok(response);
    }
}

@RestController
@RequestMapping("/api/v1/auth")
@RequiredArgsConstructor
public class AuthController {

    private final AuthService authService;

    @PostMapping("/logout")
    public ResponseEntity<LogoutResponse> logout(
            @AuthenticationPrincipal User user) {
        authService.logout(user);
        return ResponseEntity.ok(LogoutResponse.builder()
                .success(true)
                .message("ログアウトしました")
                .build());
    }
}
```

## 数据库表设计

### 1. navigation_menu 表

```sql
CREATE TABLE navigation_menu (
    menu_id VARCHAR(50) PRIMARY KEY,
    menu_label VARCHAR(100) NOT NULL,
    menu_icon VARCHAR(100),
    target_page VARCHAR(100) NOT NULL,
    display_order INT DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE INDEX idx_navigation_order ON navigation_menu(display_order);
```

## 性能优化建议

### 1. 静态资源优化

```typescript
// 导航菜单配置可以缓存
const NAVIGATION_CACHE_KEY = `nav_config:${user.partnerId}`;
const NAVIGATION_CACHE_TTL = 3600; // 1小时
```

### 2. 设备检测优化

```typescript
// 使用服务端设备检测
const deviceType = getDeviceTypeFromUserAgent(req.headers['user-agent']);
```

## 安全考虑

### 1. 权限验证

```typescript
// 根据用户权限动态生成菜单
const getVisibleMenuItems = (userPermissions: string[]): MenuItem[] => {
  return allMenuItems.filter(item =>
    item.requiredPermissions.every(perm =>
      userPermissions.includes(perm)
    )
  );
};
```

### 2. CSRF保护

```typescript
// 登出操作需要CSRF token
const handleLogout = async () => {
  await fetch('/api/v1/auth/logout', {
    method: 'POST',
    headers: {
      'X-CSRF-Token': getCsrfToken(),
    },
  });
};
```

### 3. 会话管理

```typescript
// 登出时清除所有会话数据
const clearSession = () => {
  localStorage.clear();
  sessionStorage.clear();
  cookies.remove('sessionToken');
};
```
