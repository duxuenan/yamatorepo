# p6-情報アップロード - 详细分析

## 1. 页面概述

### 1.1 页面定位

p6-情報アップロード 是合作伙伴（パートナー）侧的信息上传页面，与b8-CSVアップロード（ベース侧）相对应。合作伙伴通过此页面上传CSV或Excel格式的业务数据文件，用于更新运输信息、业绩数据或其他业务相关信息。

### 1.2 核心功能

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 文件上传 | CSV/Excel文件上传 | P0-必须 |
| 文件验证 | 格式、大小、内容验证 | P0-必须 |
| 上传历史 | 显示历史上传记录 | P0-必须 |
| 状态跟踪 | 实时显示上传处理状态 | P1-建议 |
| 错误处理 | 详细错误信息和重试机制 | P1-建议 |

### 1.3 与b8的差异

| 特性 | b8-CSVアップロード | p6-情報アップロード |
|------|------------------|-------------------|
| **用户角色** | ベース（总部） | 輸送パートナー（合作伙伴） |
| **上传内容** | 指示书、业绩数据等 | 合作伙伴业务数据 |
| **文件格式** | CSV（特定格式） | CSV/Excel（多种格式） |
| **处理权限** | 全系统数据更新 | 仅限于合作伙伴数据 |
| **验证规则** | 严格格式验证 | 合作伙伴特定验证 |

---

## 2. 页面结构层次

### 2.1 整体结构

```
輸送パートナーシステム
├── p6-情報アップロード（信息上传页）
│   ├── 页面头部
│   │   └── 页面标题 + 帮助链接
│   ├── 文件上传区域
│   │   ├── 文件选择区域
│   │   │   ├── 拖拽上传区域
│   │   │   ├── 文件选择按钮
│   │   │   └── 文件信息显示
│   │   ├── 上传选项区域
│   │   │   ├── 覆盖模式选择
│   │   │   ├── 通知设置
│   │   │   └── 备注输入
│   │   └── 操作按钮区域
│   │       ├── アップロードボタン
│   │       ├── キャンセルボタン
│   │       └── テンプレートダウンロード
│   ├── 上传历史区域
│   │   ├── 历史筛选条件
│   │   │   ├── 日期范围
│   │   │   ├── 状态筛选
│   │   │   └── 文件类型
│   │   └── 历史记录表格
│   │       ├── アップロード日
│   │       ├── ファイル名
│   │       ├── ファイルタイプ
│   │       ├── ファイルサイズ
│   │       ├── ステータス
│   │       ├── レコード数
│   │       ├── 処理時間
│   │       └── 操作（詳細/ダウンロード/削除）
│   └── 帮助信息区域
│       ├── 支持的文件格式
│       ├── テンプレート说明
│       └── 常见问题链接
```

### 2.2 区域详细说明

#### 区域1：文件上传区域

| 元素 | 类型 | 说明 | 交互 |
|------|------|------|------|
| 拖拽上传区域 | DragDrop Zone | 拖拽文件上传 | 拖放文件 |
| ファイル選択ボタン | Button | 点击选择文件 | 打开文件选择对话框 |
| 選択済みファイル | Text | 已选择文件信息 | 显示文件名、大小 |
| ファイルプレビュー | Preview | 文件内容预览（可选） | 显示前几行数据 |

#### 区域2：上传选项区域

| 元素 | 类型 | 选项 | 说明 |
|------|------|------|------|
| アップロードモード | Radio | 追加/上書き | 数据追加或覆盖 |
| エラー処理 | Select | 停止/継続 | 遇到错误时的处理方式 |
| 通知設定 | Checkbox | 邮件/系统通知 | 处理完成后的通知方式 |
| 備考入力 | TextArea | 自由输入 | 上传备注信息 |

#### 区域3：操作按钮区域

| 元素 | 类型 | 颜色 | 状态 | 说明 |
|------|------|------|------|------|
| アップロード | Primary Button | 蓝色 | 有文件时可用 | 开始上传 |
| キャンセル | Default Button | 灰色 | 有选择文件时可用 | 取消选择 |
| テンプレートDL | Link Button | 链接色 | 常时可用 | 下载模板文件 |

#### 区域4：上传历史区域

| 元素 | 类型 | 筛选条件 | 说明 |
|------|------|----------|------|
| 日付範囲 | DateRangePicker | 开始-结束日期 | 按上传日期筛选 |
| ステータス | MultiSelect | 成功/失敗/処理中 | 按状态筛选 |
| ファイルタイプ | Select | CSV/Excel | 按文件类型筛选 |
| 検索ボタン | Button | - | 执行筛选 |

#### 区域5：历史记录表格

| 列 | 类型 | 格式 | 说明 |
|----|------|------|------|
| アップロード日 | DateTime | YYYY/MM/DD HH:mm | 上传时间 |
| ファイル名 | Link | 文字列 | 点击查看详情 |
| ファイルタイプ | Tag | CSV/Excel | 文件类型标签 |
| ファイルサイズ | Text | 10.5 MB | 格式化大小 |
| ステータス | Tag | 色付き | 处理状态 |
| レコード数 | Number | 1,000件 | 处理记录数 |
| 処理時間 | Duration | 2分30秒 | 处理耗时 |
| 操作 | Button组 | 詳細/DL/削除 | 操作按钮 |

---

## 3. 字段详细分析

### 3.1 文件上传字段

| 字段标识 | 字段名称 | 数据类型 | 必填 | 最大长度 | 验证规则 |
|----------|----------|----------|------|----------|----------|
| file | ファイル | File | 是 | 10MB | 格式、大小验证 |
| upload_mode | アップロードモード | Enum | 是 | - | ADD/OVERWRITE |
| error_handling | エラー処理 | Enum | 否 | - | STOP/CONTINUE |
| notification | 通知設定 | Boolean[] | 否 | - | EMAIL/SYSTEM |
| memo | 備考 | String | 否 | 500字 | 备注信息 |

### 3.2 上传历史字段

| 字段标识 | 字段名称 | 数据类型 | 格式 | 说明 |
|----------|----------|----------|------|------|
| upload_id | アップロードID | String | UPL-XXXX | 上传唯一标识 |
| file_name | ファイル名 | String | 文字列 | 原始文件名 |
| file_type | ファイルタイプ | Enum | CSV/Excel | 文件格式 |
| file_size | ファイルサイズ | Number | Bytes | 文件大小 |
| record_count | レコード数 | Number | 整数 | 处理记录数 |
| success_count | 成功件数 | Number | 整数 | 成功处理数 |
| failed_count | 失敗件数 | Number | 整数 | 失败处理数 |
| status | ステータス | Enum | 6种状态 | 处理状态 |
| error_message | エラーメッセージ | Text | 文字列 | 错误详情 |
| uploaded_by | アップロード者 | String | 文字列 | 上传用户 |
| uploaded_at | アップロード日 | DateTime | ISO格式 | 上传时间 |
| processed_at | 処理完了日 | DateTime | ISO格式 | 处理完成时间 |
| processing_time | 処理時間 | Number | 秒 | 处理耗时 |

### 3.3 状态枚举值

| 状态值 | 显示名称 | 颜色 | 说明 |
|--------|----------|------|------|
| PENDING | 待機中 | 蓝色 | 上传完成，等待处理 |
| VALIDATING | 検証中 | 青色 | 文件验证中 |
| PROCESSING | 処理中 | 橙色 | 数据处理中 |
| SUCCESS | 完了 | 绿色 | 处理成功 |
| PARTIAL_SUCCESS | 部分成功 | 黄色 | 部分记录处理成功 |
| FAILED | 失敗 | 红色 | 处理失败 |
| CANCELLED | キャンセル | 灰色 | 已取消 |

### 3.4 文件格式规格

| 项目 | CSV格式 | Excel格式 |
|------|---------|-----------|
| 编码 | UTF-8 | UTF-8 |
| 分隔符 | 逗号 (,) | - |
| 文本限定符 | 双引号 (") | - |
| 扩展名 | .csv | .xlsx, .xls |
| 最大大小 | 10MB | 10MB |
| 最大行数 | 100,000行 | 100,000行 |
| 支持Sheet | - | 首个Sheet |

---

## 4. 交互流程详细说明

### 4.1 文件选择流程

```
┌─────────────────────────────────────────────────────────────┐
│  文件选择流程                                              │
├─────────────────────────────────────────────────────────────┤
│  1. 用户点击「ファイル選択」按钮                              │
│     ↓                                                        │
│  2. 打开系统文件选择对话框                                    │
│     ↓                                                        │
│  3. 用户选择CSV/Excel文件                                    │
│     ↓                                                        │
│  4. 前端文件验证                                            │
│     - 格式验证（.csv, .xlsx, .xls）                         │
│     - 大小验证（≤10MB）                                     │
│     - 文件读取测试                                           │
│     ↓                                                        │
│  5. 验证通过                                                │
│     ↓                                                        │
│  6. 显示文件信息                                            │
│     - 文件名、大小、类型                                      │
│     - 预计处理时间                                           │
│     ↓                                                        │
│  7. 启用上传按钮                                            │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 拖拽上传流程

```
┌─────────────────────────────────────────────────────────────┐
│  拖拽上传流程                                              │
├─────────────────────────────────────────────────────────────┤
│  1. 用户拖拽文件到上传区域                                    │
│     ↓                                                        │
│  2. 区域视觉反馈（高亮显示）                                  │
│     ↓                                                        │
│  3. 用户释放文件                                            │
│     ↓                                                        │
│  4. 获取拖拽文件列表                                         │
│     ↓                                                        │
│  5. 验证文件                                                │
│     - 数量验证（仅支持单文件）                               │
│     - 格式验证                                              │
│     - 大小验证                                              │
│     ↓                                                        │
│  6. 验证通过                                                │
│     ↓                                                        │
│  7. 显示文件信息                                            │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 文件上传流程

```
┌─────────────────────────────────────────────────────────────┐
│  文件上传流程                                              │
├─────────────────────────────────────────────────────────────┤
│  1. 用户点击「アップロード」按钮                              │
│     ↓                                                        │
│  2. 显示确认对话框（可选）                                    │
│     内容：「ファイルをアップロードします。よろしいですか？」       │
│     ↓                                                        │
│  3. 用户确认                                                │
│     ↓                                                        │
│  4. 显示上传进度                                            │
│     - 进度条显示（0% → 100%）                                │
│     - 剩余时间估算                                           │
│     ↓                                                        │
│  5. 分块上传（大文件）                                        │
│     - 文件分块（1MB/块）                                      │
│     - 并行上传（最多3个并行）                                 │
│     - 断点续传支持                                           │
│     ↓                                                        │
│  6. 上传完成                                                │
│     ↓                                                        │
│  7. 服务器处理开始                                          │
│     ↓                                                        │
│  8. 显示处理状态                                            │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 服务器处理流程

```
┌─────────────────────────────────────────────────────────────┐
│  服务器处理流程                                            │
├─────────────────────────────────────────────────────────────┤
│  1. 文件接收完成                                            │
│     ↓                                                        │
│  2. 文件验证阶段                                            │
│     - 格式深度验证                                          │
│     - 编码验证                                              │
│     - 结构验证（列数、标题）                                 │
│     ↓                                                        │
│  3. 数据处理阶段                                            │
│     - 读取文件内容                                          │
│     - 数据转换（编码、格式）                                 │
│     - 业务规则验证                                          │
│     - 数据库操作                                            │
│     ↓                                                        │
│  4. 结果汇总阶段                                            │
│     - 成功/失败计数                                         │
│     - 错误信息收集                                          │
│     - 处理日志记录                                          │
│     ↓                                                        │
│  5. 状态更新阶段                                            │
│     - 更新处理状态                                          │
│     - 发送通知（如设置）                                     │
│     ↓                                                        │
│  6. 处理完成                                                │
└─────────────────────────────────────────────────────────────┘
```

### 4.5 实时状态更新流程

```
┌─────────────────────────────────────────────────────────────┐
│  实时状态更新流程                                          │
├─────────────────────────────────────────────────────────────┤
│  1. 上传/处理开始时建立WebSocket连接                        │
│     ↓                                                        │
│  2. 服务器推送状态更新                                       │
│     - 验证进度（10%, 30%, 50%...）                          │
│     - 处理进度（记录数/总记录数）                            │
│     - 当前状态（VALIDATING, PROCESSING等）                  │
│     ↓                                                        │
│  3. 前端接收并更新UI                                        │
│     - 更新进度条                                            │
│     - 更新状态标签                                          │
│     - 显示当前处理信息                                       │
│     ↓                                                        │
│  4. 处理完成时关闭连接                                       │
│     ↓                                                        │
│  5. 显示最终结果                                            │
│     - 成功/失败统计                                         │
│     - 详细错误信息（如失败）                                 │
│     - 操作建议                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.6 历史记录操作流程

```
┌─────────────────────────────────────────────────────────────┐
│  历史记录查看流程                                          │
├─────────────────────────────────────────────────────────────┤
│  1. 用户点击历史记录中的「詳細」按钮                          │
│     ↓                                                        │
│  2. 显示详情模态框                                          │
│     - 基本情報（文件、时间、状态）                            │
│     - 処理結果（成功/失败统计）                              │
│     - エラー詳細（如失败）                                   │
│     - 処理ログ（时间线）                                    │
│     ↓                                                        │
│  3. 用户点击「ダウンロード」按钮                              │
│     ↓                                                        │
│  4. 下载原始文件或处理结果文件                                │
│     ↓                                                        │
│  5. 用户点击「削除」按钮（如允许）                            │
│     ↓                                                        │
│  6. 显示确认对话框                                          │
│     ↓                                                        │
│  7. 确认后删除记录                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 业务规则

### 5.1 文件验证规则

#### 格式验证
- 支持扩展名：.csv, .xlsx, .xls
- CSV必须UTF-8编码，逗号分隔
- Excel必须.xlsx格式（优先），兼容.xls

#### 大小限制
- 单个文件最大10MB
- 总行数不超过100,000行
- 列数不超过50列

#### 内容验证
- 必须有标题行
- 标题必须与模板匹配
- 必填字段不能为空
- 数据格式必须正确（日期、数字等）

### 5.2 数据业务规则

#### 数据范围限制
- 只能上传本合作伙伴相关的数据
- 日期范围限制（如不能上传未来日期）
- 金额范围限制（如最大值限制）

#### 数据关系验证
- 关联数据必须存在（如订单ID）
- 数据唯一性验证
- 业务状态验证（如只能更新待处理状态）

### 5.3 处理规则

#### 并发控制
- 同一合作伙伴同时只能处理一个文件
- 同一数据不能同时被多个文件更新
- 处理队列管理（先进先出）

#### 错误处理策略
- 停止模式：遇到第一个错误即停止
- 继续模式：跳过错误行继续处理
- 错误行记录到错误文件

#### 数据更新策略
- 追加模式：新增数据，不删除现有
- 覆盖模式：删除旧数据，插入新数据
- 更新模式：根据主键更新现有数据

### 5.4 权限规则

#### 上传权限
- 仅认证合作伙伴可上传
- 每日上传次数限制（如10次/天）
- 总上传数据量限制（如100MB/天）

#### 操作权限
- 只能查看自己的上传历史
- 只能下载自己上传的文件
- 删除权限限制（如只能删除失败记录）

---

## 6. 错误处理

### 6.1 前端错误

| 错误类型 | 原因 | 处理方式 | 用户提示 |
|----------|------|----------|----------|
| 文件格式错误 | 不支持的文件类型 | 阻止上传 | "サポートされていないファイル形式です" |
| 文件过大 | 超过10MB限制 | 阻止上传 | "ファイルサイズは10MB以下にしてください" |
| 文件读取错误 | 文件损坏或权限问题 | 阻止上传 | "ファイルの読み込みに失敗しました" |
| 网络错误 | 上传中断 | 自动重试（3次） | "ネットワークエラーが発生しました" |

### 6.2 服务器错误

| 错误类型 | 原因 | 处理方式 | 用户提示 |
|----------|------|----------|----------|
| 验证错误 | 格式、编码等问题 | 返回详细错误 | "ファイル形式が正しくありません" |
| 业务规则错误 | 数据违反业务规则 | 记录错误行 | "行{行番号}: {エラー内容}" |
| 数据库错误 | 数据库操作失败 | 回滚事务 | "データベースエラーが発生しました" |
| 系统错误 | 服务器内部错误 | 记录日志，通知管理员 | "システムエラーが発生しました" |

### 6.3 错误信息格式

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "ファイル検証エラー",
    "details": [
      {
        "row": 5,
        "column": "order_id",
        "error": "必須項目が空です",
        "value": ""
      },
      {
        "row": 10,
        "column": "amount",
        "error": "数値形式が正しくありません",
        "value": "abc"
      }
    ],
    "suggestion": "テンプレートをダウンロードして形式を確認してください"
  }
}
```

---

## 7. 性能要求

### 7.1 前端性能

| 指标 | 要求 | 说明 |
|------|------|------|
| 页面加载时间 | <2秒 | 首屏渲染 |
| 文件验证时间 | <1秒 | 10MB文件 |
| 进度更新频率 | 1秒/次 | 实时反馈 |

### 7.2 上传性能

| 指标 | 要求 | 说明 |
|------|------|------|
| 上传速度 | ≥1MB/秒 | 普通网络环境 |
| 分块大小 | 1MB | 大文件分块 |
| 并行上传 | 3个并行 | 提高速度 |

### 7.3 处理性能

| 指标 | 要求 | 说明 |
|------|------|------|
| CSV处理速度 | ≥1000行/秒 | 10列数据 |
| Excel处理速度 | ≥500行/秒 | 10列数据 |
| 数据库写入 | ≥500行/秒 | 批量插入 |

---

## 8. 安全考虑

### 8.1 文件安全

- 文件类型白名单验证
- 文件内容扫描（防病毒）
- 文件大小限制防止DoS
- 文件名净化（防止路径遍历）

### 8.2 数据安全

- 数据范围限制（只能操作自己的数据）
- SQL注入防护（参数化查询）
- XSS防护（输出转义）
- 敏感数据脱敏（日志记录）

### 8.3 访问安全

- 认证必须（JWT Token）
- 频率限制（防暴力上传）
- IP限制（可选）
- 操作日志记录

---

## 9. 兼容性要求

### 9.1 浏览器支持

| 浏览器 | 版本 | 说明 |
|--------|------|------|
| Chrome | 90+ | 完全支持 |
| Firefox | 88+ | 完全支持 |
| Safari | 14+ | 完全支持 |
| Edge | 90+ | 完全支持 |

### 9.2 移动端适配

- 拖拽功能替代为文件选择
- 表格响应式显示
- 触摸操作优化
- 屏幕尺寸适配

### 9.3 文件编码支持

- UTF-8（必须）
- Shift-JIS（可选）
- EUC-JP（可选）
- 自动编码检测

---

## 10. 扩展功能

### 10.1 批量上传

- 支持多个文件同时上传
- 批量处理队列
- 批量结果汇总

### 10.2 定时上传

- 预设上传时间
- 自动处理
- 结果通知

### 10.3 数据预览

- 上传前数据预览
- 数据统计信息
- 问题行高亮显示

### 10.4 API上传

- REST API接口
- 程序化上传
- 系统集成支持

---

**文档编制**: -  
**编制时间**: 2026-02-XX 
**适用范围**: p6-情報アップロード 合作伙伴信息上传页面