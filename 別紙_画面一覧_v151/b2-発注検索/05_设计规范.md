# b2-発注検索 - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b2-発注検索 |
| **界面编号** | b2 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b2-発注検索 是登录成功后的系统TOP页面，提供订单搜索和列表展示功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- 登录成功后自动显示
- 订单信息搜索功能
- 订单列表展示
- 详情页面跳转

### 1.5 适用范围
- 前端开发人员（搜索列表组件实现）
- 后端开发人员（查询API开发）
- 测试工程师（搜索功能测试）

---

## 2. 页面元素

### 2.1 元素清单

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | information | 通知区域 | 显示系统通知 | 点击→详情页面 |
| ⑵ | 年月選択 | プルダウン | 选择対象年月 | 选择触发 |
| ⑶ | 輸送パートナーID | 入力 | 輸入ID | 文本输入 |
| ⑷ | 会社コード | 入力 | 会社コード | 文本输入 |
| ⑸ | 検索 | ボタン | 执行搜索 | 点击→执行查询 |
| ⑹ | 会社コード | リンク | 公司代码 | 点击→b3-発注詳細 |
| ⑺ | 会社名 | テキスト | 公司名称 | 显示 |
| ⑻ | サブアカウント | テキスト | サブアカウント | 显示 |
| ⑼ | メッセージ | テキスト/タグ | 未読状態 | 显示/筛选 |
| ⑽ | ステータス | テキスト/フィルタ | 承諾状態 | 显示/筛选 |

### 2.2 搜索条件详细说明

#### ⑵ 年月選択
| 项目 | 内容 |
|------|------|
| **元素类型** | プルダウン |
| **功能描述** | 选择搜索対象年月 |
| **默认选项** | 当前年月 |

#### ⑶ 輸送パートナーID
| 项目 | 内容 |
|------|------|
| **元素类型** | 入力（テキスト） |
| **功能描述** | 輸入輸送パートナーID |
| **输入验证** | 格式校验 |

#### ⑷ 会社コード
| 项目 | 内容 |
|------|------|
| **元素类型** | 入力（テキスト） |
| **功能描述** | 輸入輸送パートナーの会社コード |
| **输入验证** | 格式校验 |

### 2.3 列表字段详细说明

#### ⑹ 会社コード
| 项目 | 内容 |
|------|------|
| **元素类型** | リンク |
| **功能描述** | 輸送パートナーのコード |
| **跳转目标** | b3-発注詳細 |
| **显示格式** | S00001等 |

#### ⑺ 会社名
| 项目 | 内容 |
|------|------|
| **元素类型** | テキスト |
| **功能描述** | 輸送パートナーの名称 |

#### ⑻ サブアカウント
| 项目 | 内容 |
|------|------|
| **元素类型** | テキスト |
| **功能描述** | 保有サブアカウント名 |

#### ⑼ メッセージ
| 项目 | 内容 |
|------|------|
| **元素类型** | テキスト/タグ |
| **功能描述** | 未読状態表示 |
| **显示规则** | 未読あり / - |

#### ⑽ ステータス
| 项目 | 内容 |
|------|------|
| **元素类型** | テキスト/フィルタ |
| **功能描述** | 承諾状態表示 |
| **筛选选项** | 全承諾 / 未承諾 |

---

## 3. 交互流程

### 3.1 页面加载流程
| 步骤 | 行为 | 系统响应 |
|------|------|----------|
| 1 | 页面初始化 | 检查登录状态 |
| 2 | 获取計画表状态 | 判断数据是否存在 |
| 3 | 状态判断结果 | 有数据→显示列表；无数据→显示提示 |

### 3.2 搜索流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 输入搜索条件 | 年月選択/ID/会社コード |
| 2 | 点击検索按钮 | 执行查询 |
| 3 | 显示结果 | 列表展示匹配数据 |

### 3.3 筛选流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 选择ステータス | 全承諾/未承諾 |
| 2 | 选择メッセージ | 未読あり |
| 3 | 更新列表 | 显示筛选结果 |

### 3.4 详情跳转流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击会社コード | 获取订单ID |
| 2 | 页面跳转 | 打开b3-発注詳細 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | 上部搜索+下部列表 | - | 经典列表布局 |

### 4.2 列表字段顺序
| 顺序 | 字段 | 宽度 | 对齐 |
|------|------|------|------|
| 1 | 会社コード | 固定 | 左 |
| 2 | 会社名 | 自动 | 左 |
| 3 | サブアカウント | 固定 | 左 |
| 4 | メッセージ | 固定 | 中 |
| 5 | ステータス | 固定 | 中 |
| 6 | 最終データ更新日時 | 固定 | 中 |
| 7 | version | 固定 | 中 |
| 8 | 一斉メール送信 | 固定 | 中 |
| 9 | 承諾状況 | 固定 | 中 |

### 4.3 数据显示规则
| 字段 | 规则 |
|------|------|
| メッセージ | 未読あり / - |
| 一斉メール送信 | 日付 / - |
| ステータス | 全承諾 / 未承諾 |

---

## 5. API接口设计

### 5.1 订单查询API

```yaml
# 订单搜索查询
GET /api/v1/orders/search
Authorization: Bearer {token}

# Query Parameters
- year_month: string (YYYY-MM)
- partner_id: string
- company_code: string
- status: string (all/uncommitted)
- message: string (unread_only)
- page: integer
- page_size: integer
```

### 5.2 详情跳转API
```yaml
# 获取订单详情
GET /api/v1/orders/{orderId}
Authorization: Bearer {token}
```

### 5.3 画面-接口-数据库关系映射

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|--------------|--------------|----------|
| **页面加载** | GET /api/v1/orders/search | 查询订单列表（检查計画表是否存在） | t_order, m_partner | year_month, partner_id, company_code; 关联查询 m_partner |
| **information通知** | GET /api/v1/orders/search | 显示系统通知信息 | t_notification | is_active, start_date, end_date, content |
| **年月選択** | GET /api/v1/orders/search | 查询指定年月的订单数据 | t_order | year_month (YYYY-MM) |
| **輸送パートナーID** | GET /api/v1/orders/search | 按运输伙伴ID筛选订单 | t_order | partner_id |
| **会社コード** | GET /api/v1/orders/search | 按公司代码筛选订单 | t_order | company_code |
| **検索ボタン** | GET /api/v1/orders/search | 执行综合条件查询 | t_order, m_partner, t_order_status | year_month, partner_id, company_code, status, message_unread |
| **ステータス筛选** | GET /api/v1/orders/search | 按承诺状态筛选（全承諾/未承諾） | t_order, t_order_status | status, accepted_date |
| **メッセージ筛选** | GET /api/v1/orders/search | 筛选有未読消息的订单 | t_message, t_order_message | is_read: false, order_id |
| **会社コードリンク** | GET /api/v1/orders/{orderId} | 获取订单详情（跳转b3前预加载） | t_order, m_partner, t_instruction | order_id, company_code, version, status, sent_date, accepted_date |
| **最終データ更新日時** | GET /api/v1/orders/search | 显示订单最后更新时间 | t_order | updated_at |
| **version** | GET /api/v1/orders/search | 显示指示书版本号 | t_instruction | order_id, version (MAX version) |
| **一斉メール送信** | GET /api/v1/orders/search | 显示批量邮件发送日期 | t_action_log | action_type: 'BATCH_EMAIL_SEND', action_time |
| **承諾状況** | GET /api/v1/orders/search | 显示承诺数量统计 | t_order_detail | COUNT(accepted_line_no) / COUNT(total_line_no) |

#### 关系说明

1. **页面加载流程**
   - 前端调用 `GET /api/v1/orders/search` (首次加载不带筛选条件)
   - 查询 `t_order` 表获取指定年月的订单列表
   - 关联查询 `m_partner` 表获取运输伙伴信息
   - 关联查询 `t_instruction` 表获取最新version
   - 如果查询结果为空，显示"数据不存在"提示
   - 如果有数据，显示订单列表

2. **搜索流程**
   - 用户输入搜索条件：年月選択、輸送パートナーID、会社コード
   - 点击「検索」按钮
   - 前端调用 `GET /api/v1/orders/search?year_month=2026-02&partner_id=P001&company_code=S00001`
   - 后端根据条件查询 `t_order` 表
   - 应用WHERE条件：`year_month = ? AND partner_id LIKE ? AND company_code LIKE ?`
   - 返回匹配的订单列表

3. **筛选流程（ステータス）**
   - 用户选择ステータス：全承諾 / 未承諾
   - 全承諾：`status = 'ACCEPTED'`
   - 未承諾：`status IN ('PENDING', 'REJECTED')` 或 `accepted_date IS NULL`
   - 前端调用 `GET /api/v1/orders/search?status=uncommitted`
   - 后端查询 `t_order` 表并应用状态过滤

4. **筛选流程（メッセージ）**
   - 用户选择"未読あり"筛选
   - 前端调用 `GET /api/v1/orders/search?message=unread_only`
   - 后端关联查询 `t_message` 表
   - 筛选存在未读消息的订单：`EXISTS (SELECT 1 FROM t_message WHERE order_id = t_order.order_id AND is_read = false)`
   - 返回有未读消息的订单列表

5. **详情跳转流程**
   - 用户点击列表中的会社コード
   - 前端获取对应的 `order_id`
   - 可选：预加载订单详情 `GET /api/v1/orders/{orderId}`
   - 跳转到 b3-発注詳細 页面
   - b3页面会重新调用 `GET /api/v1/orders/{orderId}` 获取完整数据

#### 数据流示意

```
前端 (b2-発注検索)
    │
    ├─ [页面加载] ───────────────→ GET /api/v1/orders/search
    │                              │
    │                              ├─→ 查询 t_order (order_id, company_code, partner_id, year_month, status, version, updated_at)
    │                              ├─→ 关联 m_partner (partner_id, partner_name, sub_account)
    │                              ├─→ 关联 t_instruction (MAX version)
    │                              └─→ 关联 t_action_log (最新邮件发送时间)
    │
    ├─ [年月選択] ─────────────→ GET /api/v1/orders/search?year_month=2026-02
    │                              │
    │                              └─→ 查询 t_order (WHERE year_month = '2026-02')
    │
    ├─ [輸送パートナーID] ──────→ GET /api/v1/orders/search?partner_id=P001
    │                              │
    │                              └─→ 查询 t_order (WHERE partner_id = 'P001')
    │
    ├─ [会社コード] ────────────→ GET /api/v1/orders/search?company_code=S00001
    │                              │
    │                              └─→ 查询 t_order (WHERE company_code = 'S00001')
    │
    ├─ [検索ボタン] ────────────→ GET /api/v1/orders/search?year_month=2026-02&partner_id=P001&company_code=S00001
    │                              │
    │                              └─→ 查询 t_order (复合条件筛选)
    │
    ├─ [ステータス筛选] ────────→ GET /api/v1/orders/search?status=uncommitted
    │                              │
    │                              ├─→ 查询 t_order (WHERE status IN ('PENDING', 'REJECTED'))
    │                              └─→ 或 WHERE accepted_date IS NULL
    │
    ├─ [メッセージ筛选] ────────→ GET /api/v1/orders/search?message=unread_only
    │                              │
    │                              └─→ 关联 t_message (WHERE EXISTS 未读消息)
    │
    └─ [点击会社コード] ───────→ GET /api/v1/orders/{orderId} (可选预加载)
                                   │
                                   └─→ 跳转 b3-発注詳細
```

#### 核心数据表结构

**t_order (订单主表)**
```sql
id BIGSERIAL PRIMARY KEY
order_id VARCHAR(20) UNIQUE NOT NULL
company_code VARCHAR(20) NOT NULL
partner_id VARCHAR(20) NOT NULL
year_month VARCHAR(7) NOT NULL  -- YYYY-MM
status VARCHAR(20) NOT NULL  -- ACCEPTED/PENDING/REJECTED/SENT
version INTEGER NOT NULL
sent_date TIMESTAMP
accepted_date TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (partner_id) REFERENCES m_partner(partner_id)
INDEX idx_year_month (year_month)
INDEX idx_partner_id (partner_id)
INDEX idx_company_code (company_code)
```

**m_partner (运输伙伴表)**
```sql
partner_id VARCHAR(20) PRIMARY KEY
partner_name VARCHAR(100) NOT NULL
company_code VARCHAR(20) UNIQUE NOT NULL
sub_account VARCHAR(100)
is_active BOOLEAN DEFAULT TRUE
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
```

**t_instruction (指示书主表)**
```sql
id BIGSERIAL PRIMARY KEY
instruction_id VARCHAR(20) UNIQUE NOT NULL
order_id VARCHAR(20) NOT NULL
version INTEGER NOT NULL
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (order_id) REFERENCES t_order(order_id)
INDEX idx_order_version (order_id, version)
```

**t_order_status (订单状态表)**
```sql
id BIGSERIAL PRIMARY KEY
order_id VARCHAR(20) NOT NULL
status VARCHAR(20) NOT NULL
status_name VARCHAR(50) NOT NULL
display_order INTEGER DEFAULT 0
FOREIGN KEY (order_id) REFERENCES t_order(order_id)
```

**t_message (消息表)**
```sql
id BIGSERIAL PRIMARY KEY
message_id VARCHAR(20) UNIQUE NOT NULL
order_id VARCHAR(20) NOT NULL
sender_id VARCHAR(100) NOT NULL
content TEXT NOT NULL
is_read BOOLEAN DEFAULT FALSE
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (order_id) REFERENCES t_order(order_id)
FOREIGN KEY (sender_id) REFERENCES m_user(user_id)
INDEX idx_order_read (order_id, is_read)
```

**t_action_log (操作日志表)**
```sql
id BIGSERIAL PRIMARY KEY
log_id VARCHAR(20) UNIQUE NOT NULL
order_id VARCHAR(20)
user_id VARCHAR(100) NOT NULL
action_type VARCHAR(50) NOT NULL  -- CREATE/UPDATE/DELETE/SEND/ACCEPT/BATCH_EMAIL_SEND
action_content TEXT
action_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
FOREIGN KEY (order_id) REFERENCES t_order(order_id)
FOREIGN KEY (user_id) REFERENCES m_user(user_id)
INDEX idx_order_action (order_id, action_type)
```

**t_notification (系统通知表)**
```sql
id BIGSERIAL PRIMARY KEY
notification_id VARCHAR(20) UNIQUE NOT NULL
title VARCHAR(200) NOT NULL
content TEXT
is_active BOOLEAN DEFAULT TRUE
start_date TIMESTAMP
end_date TIMESTAMP
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
```

---

## 6. 前端实现

### 6.1 搜索组件
```typescript
// b2搜索组件
import { Select, Input, Button, Table } from 'antd';

export const B2SearchPage: React.FC = () => {
  const [searchParams, setSearchParams] = useState({
    yearMonth: moment(),
    partnerId: '',
    companyCode: ''
  });

  const handleSearch = () => {
    // 执行搜索
  };

  return (
    <div className="b2-search-container">
      <div className="search-section">
        <Select
          value={searchParams.yearMonth}
          onChange={(value) => setSearchParams({...searchParams, yearMonth: value})}
        />
        <Input
          placeholder="輸送パートナーID"
          value={searchParams.partnerId}
          onChange={(e) => setSearchParams({...searchParams, partnerId: e.target.value})}
        />
        <Input
          placeholder="会社コード"
          value={searchParams.companyCode}
          onChange={(e) => setSearchParams({...searchParams, companyCode: e.target.value})}
        />
        <Button onClick={handleSearch}>検索</Button>
      </div>
      <Table
        dataSource={orderList}
        columns={columns}
        rowKey="companyCode"
      />
    </div>
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 登录成功后正确显示
- [ ] 搜索条件可正常输入
- [ ] 検索按钮可正常执行搜索
- [ ] 列表正确显示搜索结果
- [ ] 点击公司代码跳转到详情页
- [ ] 无数据显示正确提示

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] 列表字段顺序正确
- [ ] 数据显示规则正确

### 7.3 性能验收
- [ ] 搜索响应时间 < 1秒
- [ ] 列表渲染时间 < 1秒

### 7.4 安全验收
- [ ] 未登录不能访问
- [ ] 权限控制正确

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10| v1.0.1 | 添加画面-接口-数据库关系映射表 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b0-导航菜单 | [../b0-共通ナビゲーション/05_设计规范.md](../b0-共通ナビゲーション/05_设计规范.md) | 导航菜单设计规范 |
| b3-発注詳細 | [b3-発注詳細/05_设计规范.md](./b3-発注詳細/05_设计规范.md) | 详情页面设计规范 |

### A.2 与p2-発注検索对比
| 特性 | b2-発注検索 | p2-発注検索 |
|------|-------------|-------------|
| **用户类型** | ベース | 輸送パートナー |
| **设备支持** | PCのみ | PC/SP |
| **数据来源** | BOSS系统 | - |

---

**文档编制**: -  
**编制时间**: 2026-02-XX 
**适用范围**: 別紙_画面一覧_v151.xlsx - b2-発注検索  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
