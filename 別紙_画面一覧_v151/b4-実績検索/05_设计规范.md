# b4-実績検索 - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b4-実績検索 |
| **界面编号** | b4 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b4-実績検索 是业绩搜索页面，提供业绩信息的检索和列表展示功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- 业绩信息搜索
- 业绩列表展示
- 详情页面跳转

### 1.5 适用范围
- 前端开发人员（搜索列表组件实现）
- 后端开发人员（查询API开发）
- 测试工程师（搜索功能测试）

---

## 2. 页面元素

### 2.1 元素清单

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | 年月選択 | プルダウン | 选择対象年月 | 选择触发 |
| ⑵ | 輸送パートナーID | 入力 | 輸送パートナーID | 文本输入 |
| ⑶ | 実績ID | 入力 | 対象の実績ID | 文本输入 |
| ⑷ | 作業区分 | チェックボックス | 作業区分筛选 | 多选 |
| ⑸ | 状態 | チェックボックス | 承諾状態筛选 | 多选 |
| ⑹ | 検索 | ボタン | 执行搜索 | 点击→执行查询 |
| ⑺ | 会社コード | リンク | 公司代码 | 点击→b5-実績詳細 |
| ⑻ | 会社名 | テキスト | 公司名称 | 显示 |
| ⑼ | サブアカウント | テキスト | サブアカウント | 显示 |
| ⑽ | 作業区分 | タグ | 作业区分 | 显示 |
| ⑾ | メッセージ | テキスト | 未読状態 | 显示 |
| ⑿ | ステータス | タグ | 承諾状態 | 显示 |

---

## 3. 交互流程

### 3.1 页面加载流程
| 步骤 | 行为 | 系统响应 |
|------|------|----------|
| 1 | 页面初始化 | 检查登录状态 |
| 2 | 加载搜索条件 | 显示搜索表单 |
| 3 | 等待用户输入 | - |

### 3.2 搜索流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 输入搜索条件 | 多条件输入 |
| 2 | 点击検索按钮 | 执行查询 |
| 3 | 显示结果 | 列表展示匹配数据 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | 上部搜索+下部列表 | - | 经典列表布局 |

### 4.2 列表字段顺序
| 顺序 | 字段 | 宽度 | 说明 |
|------|------|------|------|
| 1 | 会社コード | 固定 | 链接 |
| 2 | 会社名 | 自动 | 名称 |
| 3 | サブアカウント | 固定 | 子账户 |
| 4 | 作業区分 | 固定 | 标签 |
| 5 | メッセージ | 固定 | 状态 |
| 6 | ステータス | 固定 | 状态 |
| 7 | 最終データ更新日時 | 固定 | 日期 |
| 8 | version | 固定 | 版本 |
| 9 | 一斉メール送信 | 固定 | 日期 |
| 10 | 月間運行指示書 | 固定 | 承诺数 |
| 11 | 日別傭車費一覧 | 固定 | 承诺数 |

---

## 5. API接口设计

### 5.1 业绩查询API

```yaml
# 业绩搜索查询
GET /api/v1/completed-orders/search
Authorization: Bearer {token}

# Query Parameters
- year_month: string (YYYY-MM)
- partner_id: string
- completed_order_id: string
- work_type: string (運行/回送/横持/センター/物流/合計)
- status: string (all/uncommitted)
- page: integer
- page_size: integer
```

### 5.2 详情跳转API
```yaml
# 获取业绩详情
GET /api/v1/completed-orders/{completedOrderId}
Authorization: Bearer {token}
```

### 5.3 画面-API-数据库关系映射

#### 5.3.1 关系总览表

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|-------------|-------------|----------|
| **搜索条件区** | | | | |
| ⑴ 年月選択 | GET /api/v1/completed-orders/search | 按年月筛选实绩数据 | t_completed_order | year_month → completed_date |
| ⑵ 輸送パートナーID | GET /api/v1/completed-orders/search | 按运输合作伙伴筛选 | t_completed_order | partner_id → transport_partner_id |
| | | | m_partner | partner_id → partner_id, partner_name |
| ⑶ 実績ID | GET /api/v1/completed-orders/search | 按实绩ID精确查询 | t_completed_order | completed_order_id → completed_order_id |
| ⑷ 作業区分 | GET /api/v1/completed-orders/search | 按作业类型筛选 | t_completed_order | work_type → work_type (運行/回送/横持/センター/物流/合計) |
| ⑸ 状態 | GET /api/v1/completed-orders/search | 按承诺状态筛选 | t_completed_order | status → status (all/uncommitted) |
| ⑹ 検索ボタン | GET /api/v1/completed-orders/search | 执行多条件组合查询 | t_completed_order | 全部搜索条件 AND 组合 |
| **实绩结果列表区** | | | | |
| 列表数据获取 | GET /api/v1/completed-orders/search | 分页查询实绩列表 | t_completed_order | id, company_code, company_name, sub_account, work_type, status, last_data_update_datetime, version, mass_mail_sent_datetime, monthly_operation_instruction_count, daily_vehicle_cost_list_count |
| | | | m_partner | partner_id → partner_name |
| | | | t_message | completed_order_id → unread_message_count, latest_message_content |
| ⑦ 会社コード | GET /api/v1/completed-orders/search | 显示并支持点击跳转 | t_completed_order | company_code |
| ⑧ 会社名 | GET /api/v1/completed-orders/search | 显示公司名称 | t_completed_order | company_name |
| ⑨ サブアカウント | GET /api/v1/completed-orders/search | 显示子账户 | t_completed_order | sub_account |
| ⑩ 作業区分 | GET /api/v1/completed-orders/search | 显示作业类型标签 | t_completed_order | work_type |
| ⑪ メッセージ | GET /api/v1/completed-orders/search | 显示未读消息状态 | t_message | unread_message_count (若>0则显示未读标识) |
| ⑫ ステータス | GET /api/v1/completed-orders/search | 显示承诺状态 | t_completed_order | status |
| 最終データ更新日時 | GET /api/v1/completed-orders/search | 显示最后数据更新时间 | t_completed_order | last_data_update_datetime |
| version | GET /api/v1/completed-orders/search | 显示版本号 | t_completed_order | version |
| 一斉メール送信 | GET /api/v1/completed-orders/search | 显示批量邮件发送时间 | t_completed_order | mass_mail_sent_datetime |
| 月間運行指示書 | GET /api/v1/completed-orders/search | 显示月间运行指示书承诺数 | t_completed_order | monthly_operation_instruction_count |
| 日別傭車費一覧 | GET /api/v1/completed-orders/search | 显示日别佣车费一览承诺数 | t_completed_order | daily_vehicle_cost_list_count |
| **详情页面跳转** | | | | |
| 点击会社コード | GET /api/v1/completed-orders/{completedOrderId} | 跳转到b5-実績詳細页面 | t_completed_order | completed_order_id |
| | | | m_company | company_code, company_name |
| | | | t_completed_order_detail | completed_order_id → detail records |
| | | | t_operation | completed_order_id → operation records |

#### 5.3.2 关系说明

**1. 搜索流程关系**

```
用户输入搜索条件 (⑴⑵⑶⑷⑸)
         ↓
点击検索ボタン (⑹)
         ↓
前端调用: GET /api/v1/completed-orders/search
         ↓
后端查询: t_completed_order (多条件 AND)
         ↓
关联查询: m_partner (获取partner_name)
         ↓
关联查询: t_message (获取未读消息数)
         ↓
返回JSON结果给前端
         ↓
前端渲染: 列表展示 (⑦⑧⑨⑩⑪⑫等)
```

**2. 数据表关系**

```
t_completed_order (主表)
    ├─ id (主键)
    ├─ completed_order_id (实绩ID，业务主键)
    ├─ year_month (年月，用于搜索)
    ├─ partner_id (运输合作伙伴ID，外键)
    │      └─→ m_partner.partner_id (关联合作伙伴信息)
    ├─ company_code (公司代码)
    ├─ company_name (公司名称)
    ├─ sub_account (子账户)
    ├─ work_type (作业类型)
    ├─ status (状态)
    ├─ last_data_update_datetime (最后数据更新时间)
    ├─ version (版本号)
    ├─ mass_mail_sent_datetime (批量邮件发送时间)
    ├─ monthly_operation_instruction_count (月间运行指示书承诺数)
    ├─ daily_vehicle_cost_list_count (日别佣车费一览承诺数)
    │
    ├─→ t_message.completed_order_id (一对多)
    │      └─ unread_message_count (未读消息数)
    │      └─ latest_message_content (最新消息内容)
    │
    └─→ t_operation.completed_order_id (一对多)
           └─ operation_datetime (操作时间)
           └─ operation_type (操作类型)
```

**3. 字段映射关系**

| 画面元素 | 数据库表 | 源字段 | 目标字段 | 转换逻辑 |
|----------|---------|--------|---------|---------|
| 年月選択 | t_completed_order | year_month | - | YYYY-MM格式 |
| 輸送パートナーID | m_partner | partner_id | partner_name | 关联查询 |
| 実績ID | t_completed_order | completed_order_id | - | 精确匹配 |
| 作業区分 | t_completed_order | work_type | - | 多选OR条件 |
| 状態 | t_completed_order | status | - | 多选OR条件 |
| 会社コード | t_completed_order | company_code | - | 直接映射 |
| 会社名 | t_completed_order | company_name | - | 直接映射 |
| サブアカウント | t_completed_order | sub_account | - | 直接映射 |
| 作業区分（标签） | t_completed_order | work_type | - | 标签样式 |
| メッセージ | t_message | unread_message_count | - | >0显示未读标识 |
| ステータス | t_completed_order | status | - | 标签样式 |
| 最終データ更新日時 | t_completed_order | last_data_update_datetime | - | 日期时间格式化 |
| version | t_completed_order | version | - | 直接映射 |
| 一斉メール送信 | t_completed_order | mass_mail_sent_datetime | - | 日期时间格式化 |
| 月間運行指示書 | t_completed_order | monthly_operation_instruction_count | - | 直接映射 |
| 日別傭車費一覧 | t_completed_order | daily_vehicle_cost_list_count | - | 直接映射 |

#### 5.3.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        b4-実績検索 画面                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐               │
│  │ 年月選択    │  │ 輸送パートナー│  │ 実績ID      │               │
│  │ (⑴)        │  │ ID入力(⑵)    │  │ 入力(⑶)     │               │
│  └─────────────┘  └──────────────┘  └─────────────┘               │
│         ↓                ↓                 ↓                       │
│  ┌─────────────┐  ┌──────────────┐                                │
│  │ 作業区分    │  │ 状態          │                                │
│  │ チェック(⑷) │  │ チェック(⑸)   │                                │
│  └─────────────┘  └──────────────┘                                │
│         ↓                ↓                                         │
│  ┌─────────────┐                                                   │
│  │ 検索ボタン  │                                                   │
│  │     (⑹)     │                                                   │
│  └──────┬──────┘                                                   │
│         ↓                                                          │
│  ┌──────────────────────────────┐                                 │
│  │ GET /api/v1/completed-orders/ │                                 │
│  │        search                 │                                 │
│  └──────────────┬───────────────┘                                 │
│                 ↓                                                  │
│         ┌───────────────┐                                          │
│         │  Spring Boot   │                                          │
│         │   Controller    │                                          │
│         └───────┬───────┘                                          │
│                 ↓                                                  │
│         ┌───────────────┐                                          │
│         │   Service      │                                          │
│         └───────┬───────┘                                          │
│                 ↓                                                  │
│    ┌────────────┼────────────┐                                    │
│    ↓            ↓            ↓                                    │
│┌────────┐  ┌────────┐  ┌────────┐                                 │
│t_      │  │m_      │  │t_      │                                 │
│completed│  │partner  │  │message │                                 │
│_order  │  │        │  │        │                                 │
└───┬────┘  └───┬────┘  └───┬────┘                                 │
│            │            │                                         │
│            ↓            ↓                                         │
│      (关联查询)    (统计未读)                                      │
│            │            │                                         │
│            └─────┬──────┘                                         │
│                  ↓                                                 │
│          ┌───────────────┐                                         │
│          │  组装JSON响应  │                                         │
│          └───────┬───────┘                                         │
│                  ↓                                                 │
│         ┌───────────────┐                                         │
│         │   Frontend    │                                         │
│         │  Table Render │                                         │
│         └───────┬───────┘                                         │
│                 ↓                                                 │
│  ┌────────────────────────────────────────┐                       │
│  │         实绩结果列表                    │                       │
│  │  ⑦ ⑧ ⑨ ⑩ ⑪ ⑫ + 其他字段              │                       │
│  └────────────────────────────────────────┘                       │
│                   ↓                                                │
│          点击会社コード(⑦) → b5-実績詳細                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 5.3.4 核心数据库表结构

**t_completed_order（实绩表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| completed_order_id | VARCHAR(50) | 实绩ID（业务主键） | UNIQUE |
| year_month | VARCHAR(7) | 年月（YYYY-MM） | 用于搜索 |
| partner_id | VARCHAR(20) | 运输合作伙伴ID | → m_partner.partner_id |
| company_code | VARCHAR(20) | 公司代码 | - |
| company_name | VARCHAR(100) | 公司名称 | - |
| sub_account | VARCHAR(50) | 子账户 | - |
| work_type | VARCHAR(20) | 作业类型 | 運行/回送/横持/センター/物流/合計 |
| status | VARCHAR(20) | 状态 | all/uncommitted |
| last_data_update_datetime | TIMESTAMP | 最后数据更新时间 | - |
| version | INTEGER | 版本号 | - |
| mass_mail_sent_datetime | TIMESTAMP | 批量邮件发送时间 | - |
| monthly_operation_instruction_count | INTEGER | 月间运行指示书承诺数 | - |
| daily_vehicle_cost_list_count | INTEGER | 日别佣车费一览承诺数 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**m_partner（合作伙伴表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| partner_id | VARCHAR(20) | 合作伙伴ID | UNIQUE |
| partner_name | VARCHAR(100) | 合作伙伴名称 | - |
| partner_type | VARCHAR(20) | 合作伙伴类型 | 輸送パートナー |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_message（消息表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| message_id | VARCHAR(50) | 消息ID | UNIQUE |
| completed_order_id | VARCHAR(50) | 实绩ID | → t_completed_order.completed_order_id |
| sender_id | VARCHAR(20) | 发送者ID | - |
| receiver_id | VARCHAR(20) | 接收者ID | - |
| message_content | TEXT | 消息内容 | - |
| is_read | BOOLEAN | 是否已读 | DEFAULT FALSE |
| created_at | TIMESTAMP | 创建时间 | - |

---

## 6. 前端实现

### 6.1 搜索组件
```typescript
// b4搜索组件
import { Select, Input, Checkbox, Button, Table } from 'antd';

export const B4SearchPage: React.FC = () => {
  const [searchParams, setSearchParams] = useState({
    yearMonth: moment(),
    partnerId: '',
    completedOrderId: '',
    workTypes: [],
    status: []
  });

  const handleSearch = () => {
    // 执行搜索
  };

  return (
    <div className="b4-search-container">
      <div className="search-section">
        <Select />
        <Input />
        <Input />
        <Checkbox.Group />
        <Checkbox.Group />
        <Button onClick={handleSearch}>検索</Button>
      </div>
      <Table />
    </div>
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 搜索条件可正常输入
- [ ] 検索按钮可正常执行搜索
- [ ] 列表正确显示搜索结果
- [ ] 点击公司代码跳转到详情页

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] 列表字段顺序正确

### 7.3 性能验收
- [ ] 搜索响应时间 < 1秒
- [ ] 列表渲染时间 < 1秒

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10 | v1.0.1 | 新增5.3节：画面-API-数据库关系映射表，包含详细的关系总览、关系说明、数据流图和核心数据库表结构 | - |
| 2026-02-XX | v1.0 | 初始版本 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b0-导航菜单 | [../b0-共通ナビゲーション/05_设计规范.md](../b0-共通ナビゲーション/05_设计规范.md) | 导航菜单设计规范 |
| b2-発注検索 | [../b2-発注検索/05_设计规范.md](../b2-発注検索/05_设计规范.md) | 相似搜索页面 |

### A.2 与p4-実績検索对比
| 特性 | b4-実績検索 | p4-実績検索 |
|------|-------------|-------------|
| **用户类型** | ベース | 輸送パートナー |
| **设备支持** | PCのみ | PC/SP |

---

**文档编制**: -  
**编制时间**: 2026-02-10 
**适用范围**: 別紙_画面一覧_v151.xlsx - b4-実績検索  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
