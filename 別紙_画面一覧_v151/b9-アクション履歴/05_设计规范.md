# b9-アクション履歴 - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b9-アクション履歴 |
| **界面编号** | b9 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b9-アクション履歴 是操作历史查询页面，提供アクション履歴の検索と一覧表示功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- アクション履歴検索
- 検索結果一覧表示

### 1.5 适用范围
- 前端开发人员（列表组件实现）
- 后端开发人员（历史查询API）
- 测试工程师（查询功能测试）

---

## 2. 页面元素

### 2.1 元素清单

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | 年月選択 | プルダウン | 选择対象年月 | 选择触发 |
| ⑵ | 会社コード | 入力 | 会社コード | 文本输入 |
| ⑶ | パートナー名 | 入力 | パートナー名 | 文本输入 |
| ⑷ | 検索 | ボタン | 执行搜索 | 点击→执行查询 |
| ⑸ | 会社コード | テキスト | 公司代码 | 显示 |
| ⑹ | パートナー名 | テキスト | 公司名称 | 显示 |
| ⑺ | 日時 | テキスト | 操作日時 | 显示 |
| ⑻ | 更新者 | テキスト | ユーザー名 | 显示 |
| ⑨ | 項目 | テキスト | アクション内容 | 显示 |

---

## 3. 交互流程

### 3.1 页面加载流程
| 步骤 | 行为 | 系统响应 |
|------|------|----------|
| 1 | 页面初始化 | 检查登录状态 |
| 2 | 加载搜索条件 | 显示搜索表单 |
| 3 | 等待用户输入 | - |

### 3.2 搜索流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 输入搜索条件 | 年月選択/コード/名前 |
| 2 | 点击検索按钮 | 执行查询 |
| 3 | 显示结果 | 列表展示匹配数据 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | 上部搜索+下部列表 | - | 经典列表布局 |

### 4.2 列表字段顺序
| 顺序 | 字段 | 宽度 | 说明 |
|------|------|------|------|
| 1 | 会社コード | 固定 | 公司代码 |
| 2 | パートナー名 | 自动 | 公司名称 |
| 3 | 日時 | 固定 | 操作时间 |
| 4 | 更新者 | 固定 | 操作者 |
| 5 | 項目 | 自动 | 操作内容 |

---

## 5. API接口设计

### 5.1 历史查询API
```yaml
# 操作历史搜索查询
GET /api/v1/action-history/search
Authorization: Bearer {token}

# Query Parameters
- year_month: string (YYYY-MM)
- company_code: string
- partner_name: string
- page: integer
- page_size: integer
```

### 5.2 画面-API-数据库关系映射

#### 5.2.1 关系总览表

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|-------------|-------------|----------|
| **搜索条件区** | | | | |
| ⑴ 年月選択 | GET /api/v1/action-history/search | 按年月筛选历史记录 | t_action_log | action_datetime (YYYY-MM格式筛选) |
| ⑵ 会社コード | GET /api/v1/action-history/search | 按公司代码筛选 | t_action_log | company_code (模糊匹配) |
| | | | m_partner | company_code → partner_name |
| ⑶ パートナー名 | GET /api/v1/action-history/search | 按合作伙伴名筛选 | t_action_log | partner_name (模糊匹配) |
| | | | m_partner | partner_name |
| ⑷ 検索ボタン | GET /api/v1/action-history/search | 执行多条件组合查询 | t_action_log | 全部搜索条件 AND 组合 |
| **搜索结果列表区** | | | | |
| 列表数据获取 | GET /api/v1/action-history/search | 分页查询操作历史 | t_action_log | id, company_code, partner_name, action_datetime, action_type, action_detail |
| | | | m_partner | partner_id → partner_name |
| | | | m_user | action_by → user_name |
| ⑸ 会社コード | GET /api/v1/action-history/search | 显示公司代码 | t_action_log | company_code |
| ⑹ パートナー名 | GET /api/v1/action-history/search | 显示合作伙伴名称 | m_partner | partner_name |
| ⑺ 日時 | GET /api/v1/action-history/search | 显示操作时间 | t_action_log | action_datetime |
| ⑻ 更新者 | GET /api/v1/action-history/search | 显示操作者名称 | m_user | user_name |
| | | | t_action_log | action_by → m_user.user_id |
| ⑨ 項目 | GET /api/v1/action-history/search | 显示操作内容 | t_action_log | action_type + action_detail |
| | | | - | 组合显示: action_type 动作类型 + action_detail 操作详情 |

#### 5.2.2 关系说明

**1. 搜索流程关系**

```
用户输入搜索条件 (⑴⑵⑶)
         ↓
点击検索ボタン (⑷)
         ↓
前端调用: GET /api/v1/action-history/search
         ↓
后端查询: t_action_log (多条件 AND)
         ↓
关联查询: m_partner (获取partner_name)
关联查询: m_user (获取user_name)
         ↓
返回JSON结果给前端
         ↓
前端渲染: 列表展示 (⑸⑹⑺⑻⑨等)
```

**2. 数据表关系**

```
t_action_log (操作日志表，主表)
    ├─ id (主键)
    ├─ log_id (日志ID，业务主键)
    ├─ company_code (公司代码)
    │      └─→ m_partner.company_code (关联合作伙伴信息)
    ├─ partner_name (合作伙伴名称)
    │      └─→ m_partner.partner_name
    ├─ action_datetime (操作时间)
    ├─ action_type (操作类型)
    │      可能的值:
    │      ├─ 検索 (搜索操作)
    │      ├─ 編集 (编辑操作)
    │      ├─ 保存 (保存操作)
    │      ├─ 送付 (发送操作)
    │      ├─ 承諾 (承诺操作)
    │      ├─ 代理承諾 (代理承诺)
    │      ├─ 差戻し (退回操作)
    │      ├─ 確認OK (确认通过)
    │      ├─ 確認NG (确认拒绝)
    │      ├─ アップロード (上传操作)
    │      ├─ ダウンロード (下载操作)
    │      ├─ ステータス変更 (状态变更)
    │      ├─ インポート (导入操作)
    │      ├─ メール送信 (邮件发送)
    │      └─ その他 (其他操作)
    ├─ action_detail (操作详情，JSON格式)
    │      示例: {"operation": "confirm_ok", "billing_id": "xxx", "note": "确认通过"}
    ├─ action_by (操作者ID)
    │      └─→ m_user.user_id (关联用户信息)
    ├─ related_screen (相关画面)
    │      可能的值:
    │      ├─ b2-発注検索
    │      ├─ b3-発注詳細
    │      ├─ b4-実績検索
    │      ├─ b5-実績詳細
    │      ├─ b6-被請求管理
    │      ├─ b7-被請求詳細
    │      ├─ b8-CSVアップロード
    │      └─ 其他
    ├─ related_id (关联业务ID，如billing_id, completed_order_id等)
    ├─ ip_address (IP地址)
    ├─ user_agent (用户代理)
    ├─ is_active (是否有效)
    │      DEFAULT TRUE
    ├─ created_at (创建时间)
    └─ updated_at (更新时间)

m_partner (合作伙伴表)
    ├─ id (主键)
    ├─ partner_id (合作伙伴ID)
    ├─ company_code (公司代码)
    │      UNIQUE
    ├─ partner_name (合作伙伴名称)
    ├─ company_name (公司名称)
    ├─ partner_type (合作伙伴类型)
    ├─ is_active (是否有效)
    │      DEFAULT TRUE
    ├─ created_at (创建时间)
    └─ updated_at (更新时间)

m_user (用户表)
    ├─ id (主键)
    ├─ user_id (用户ID)
    │      UNIQUE
    ├─ user_name (用户名)
    ├─ email (邮箱)
    ├─ role (角色)
    │      可能的值:
    │      ├─ 管理者
    │      ├─ 発注担当
    │      ├─ 配車担当
    │      └─ 計上担当
    ├─ azure_ad_id (AzureAD ID)
    ├─ is_active (是否有效)
    │      DEFAULT TRUE
    ├─ created_at (创建时间)
    └─ updated_at (更新时间)
```

**3. 字段映射关系**

| 画面元素 | 数据库表 | 源字段 | 目标字段 | 转换逻辑 |
|----------|---------|--------|---------|---------|
| 年月選択 | t_action_log | action_datetime | - | YYYY-MM格式提取 |
| 会社コード | t_action_log | company_code | - | 直接映射 |
| パートナー名 | m_partner | partner_name | - | company_code关联查询 |
| 会社コード（列表） | t_action_log | company_code | - | 直接映射 |
| パートナー名（列表） | m_partner | partner_name | - | company_code关联查询 |
| 日時 | t_action_log | action_datetime | - | 日期时间格式化 |
| 更新者 | m_user | user_name | - | action_by关联查询 |
| 項目 | t_action_log | action_type, action_detail | - | 组合显示 |
| action_type | t_action_log | action_type | - | 直接映射 |
| action_detail | t_action_log | action_detail | - | JSON解析后显示 |

**4. 搜索条件处理逻辑**

```
年月選択条件:
  - 如果选择年月: WHERE action_datetime >= '年月-01 00:00:00' AND action_datetime < '下月-01 00:00:00'
  - 如果未选择: 不限制

会社コード条件:
  - 如果输入: WHERE company_code LIKE '%输入值%'
  - 如果未输入: 不限制

パートナー名条件:
  - 如果输入: WHERE partner_name LIKE '%输入值%'
  - 如果未输入: 不限制

组合逻辑:
  - 全部条件使用 AND 连接
  - 如果多个条件都未输入，返回全部记录
```

**5. 列表排序规则**

```
默认排序:
  - 主要排序: action_datetime DESC (按操作时间倒序)
  - 次要排序: id ASC (按主键正序)

分页处理:
  - 使用 LIMIT 和 OFFSET 进行分页
  - 支持 page 和 page_size 参数
  - 返回 total_count (总记录数) 用于前端分页组件
```

#### 5.2.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        b9-アクション履歴 画面                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐               │
│  │ 年月選択    │  │ 会社コード   │  │ パートナー名 │               │
│  │ (⑴)       │  │ 入力(⑵)     │  │ 入力(⑶)     │               │
│  └─────────────┘  └──────────────┘  └─────────────┘               │
│         ↓                ↓                 ↓                       │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ 検索ボタン (⑷)                                       │     │
│  └────────────────────────┬───────────────────────────────┘     │
│                           ↓                                      │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │ GET /api/v1/action-history/search                      │     │
│  │ Query: year_month, company_code, partner_name, page...  │     │
│  └────────────────────────┬───────────────────────────────┘     │
│                           ↓                                      │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │              Spring Boot Controller                    │     │
│  └────────────────────────┬───────────────────────────────┘     │
│                           ↓                                      │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │              ActionHistoryService                       │     │
│  └────────────────────────┬───────────────────────────────┘     │
│                           ↓                                      │
│              ┌────────────┼────────────┐                          │
│              ↓            ↓            ↓                          │
│        ┌─────────┐ ┌─────────┐ ┌─────────┐                        │
│        │t_       │ │m_       │ │m_       │                        │
│        │action   │ │partner   │ │user     │                        │
│        │_log     │ │         │ │         │                        │
│        └────┬────┘ └────┬────┘ └────┬────┘                        │
│             │            │            │                             │
│             └────────────┴────────────┘                             │
│                           ↓                                      │
│              ┌────────────────────────┐                            │
│              │  组装查询结果          │                            │
│              │  (关联查询用户信息)    │                            │
│              └────────────────────────┘                            │
│                           ↓                                      │
│              ┌────────────────────────┐                            │
│              │  返回JSON响应          │                            │
│              │  (含分页信息)          │                            │
│              └────────────────────────┘                            │
│                           ↓                                      │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │                   Frontend                             │     │
│  │                   Table Render                         │     │
│  └────────────────────────┬───────────────────────────────┘     │
│                           ↓                                      │
│  ┌─────────────────────────────────────────────────────────┐     │
│  │              搜索结果列表                              │     │
│  │  ⑸ ⑹ ⑺ ⑻ ⑼                                      │     │
│  │  会社コード/パートナー名/日時/更新者/項目              │     │
│  └─────────────────────────────────────────────────────────┘     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 5.2.4 核心数据库表结构

**t_action_log（操作日志表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| log_id | VARCHAR(50) | 日志ID（业务主键） | UNIQUE |
| company_code | VARCHAR(20) | 公司代码 | → m_partner.company_code |
| partner_name | VARCHAR(100) | 合作伙伴名称 | → m_partner.partner_name |
| action_datetime | TIMESTAMP | 操作时间 | - |
| action_type | VARCHAR(50) | 操作类型 | 検索/編集/保存/送付/承諾/代理承諾/差戻し/確認OK/確認NG/アップロード/ダウンロード/ステータス変更/インポート/メール送信/その他 |
| action_detail | JSONB | 操作详情 | JSON格式，包含具体操作信息 |
| action_by | VARCHAR(20) | 操作者ID | → m_user.user_id |
| related_screen | VARCHAR(50) | 相关画面 | b2/b3/b4/b5/b6/b7/b8等 |
| related_id | VARCHAR(50) | 关联业务ID | billing_id/completed_order_id等 |
| ip_address | VARCHAR(50) | IP地址 | - |
| user_agent | TEXT | 用户代理字符串 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**m_partner（合作伙伴表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| partner_id | VARCHAR(20) | 合作伙伴ID | UNIQUE |
| company_code | VARCHAR(20) | 公司代码 | UNIQUE |
| partner_name | VARCHAR(100) | 合作伙伴名称 | - |
| company_name | VARCHAR(100) | 公司名称 | - |
| partner_type | VARCHAR(20) | 合作伙伴类型 | 輸送パートナー |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**m_user（用户表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| user_id | VARCHAR(20) | 用户ID | UNIQUE |
| user_name | VARCHAR(100) | 用户名 | - |
| email | VARCHAR(100) | 邮箱 | - |
| role | VARCHAR(20) | 角色 | 管理者/発注担当/配車担当/計上担当 |
| azure_ad_id | VARCHAR(100) | AzureAD ID | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**5.2.5 操作类型说明**

| action_type | 说明 | 常见操作场景 |
|-------------|------|-------------|
| 検索 | 搜索操作 | b2/b4搜索、筛选 |
| 編集 | 编辑操作 | b3/b5编辑数据 |
| 保存 | 保存操作 | 保存编辑内容 |
| 送付 | 发送操作 | 发送指示书、账单 |
| 承諾 | 承诺操作 | パートナー承诺 |
| 代理承諾 | 代理承诺 | ベース代替承诺 |
| 差戻し | 退回操作 | 退回重新处理 |
| 確認OK | 确认通过 | 账单确认通过 |
| 確認NG | 确认拒绝 | 账单确认拒绝 |
| アップロード | 上传操作 | CSV/账单文件上传 |
| ダウンロード | 下载操作 | 下载账单、文件 |
| ステータス変更 | 状态变更 | 变更账单状态 |
| インポート | 导入操作 | CSV数据导入 |
| メール送信 | 邮件发送 | 发送通知邮件 |
| その他 | 其他操作 | 其他操作记录 |

---

### 6.1 搜索列表组件
```typescript
// b9搜索组件
import { Select, Input, Button, Table } from 'antd';

export const B9HistoryPage: React.FC = () => {
  const [searchParams, setSearchParams] = useState({
    yearMonth: moment(),
    companyCode: '',
    partnerName: ''
  });

  const handleSearch = () => {
    // 执行搜索
  };

  return (
    <div className="b9-history-container">
      <div className="search-section">
        <Select
          value={searchParams.yearMonth}
          onChange={(value) => setSearchParams({...searchParams, yearMonth: value})}
        />
        <Input
          placeholder="会社コード"
          value={searchParams.companyCode}
          onChange={(e) => setSearchParams({...searchParams, companyCode: e.target.value})}
        />
        <Input
          placeholder="パートナー名"
          value={searchParams.partnerName}
          onChange={(e) => setSearchParams({...searchParams, partnerName: e.target.value})}
        />
        <Button onClick={handleSearch}>検索</Button>
      </div>
      <Table
        dataSource={historyList}
        columns={columns}
        rowKey="id"
      />
    </div>
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 搜索条件可正常输入
- [ ] 検索按钮可正常执行搜索
- [ ] 列表正确显示搜索结果

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] 列表字段顺序正确

### 7.3 性能验收
- [ ] 搜索响应时间 < 1秒

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10 | v1.0.1 | 新增5.2节：画面-API-数据库关系映射表，包含详细的关系总览、关系说明、数据流图和核心数据库表结构 | - |
| 2026-02-XX | v1.0 | 初始版本 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b0-导航菜单 | [../b0-共通ナビゲーション/05_设计规范.md](../b0-共通ナビゲーション/05_设计规范.md) | 导航菜单设计规范 |

---

**文档编制**: -  
**编制时间**: 2026-02-10 
**适用范围**: 別紙_画面一覧_v151.xlsx - b9-アクション履歴  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
