# b5-実績詳細 - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b5-実績詳細 |
| **界面编号** | b5 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b5-実績詳細 是业绩详情页面，提供业绩详细信息展示和日别傭车费一览的编辑、发送功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- 輸送パートナー情報表示
- 状態進捗表示
- 日別傭車費一覧編集
- 送付功能
- アクション履歴表示
- メッセージ交流

### 1.5 适用范围
- 前端开发人员（详情页面组件实现）
- 后端开发人员（业绩/费用API开发）
- 测试工程师（详情功能测试）

---

## 2. 页面元素

### 2.1 元素清单

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | 輸送パートナー情報 | 表示区域 | 輸送パートナーID/名 | - |
| ⑵ | 状態表示 | 表示区域 | 発注ID/ステータス/version/指示書送付/承諾 | - |
| ⑶ | 日別傭車費一覧 | テーブル | 費用表格 | 編集/保存/送付 |
| ⑷ | 月間運行指示書 | テーブル | 確定版指示書 | 表示のみ |
| ⑸ | アクション履歴 | リスト | 行为历史 | 表示 |
| ⑹ | メッセージ | パネル | 消息交流 | 表示/入力/送信 |

### 2.2 状態区域字段说明
| 字段 | 元素类型 | 说明 |
|------|----------|------|
| 発注ID | Text（只读） | 発注対象の発注IDを表示する |
| ステータス | Tag | 「全承諾」「未承諾」のどちらかを表示する |
| version | Text（只读） | 月間運行指示書の最新version（数字）を表示する |
| 指示書送付 | Text（只读） | 輸送パートナーへ指示書を送付した日時を表示する |
| 承諾 | Text（只读） | 輸送パートナーが承諾した日時を表示する |

### 2.3 日別傭車費一覧字段
| 字段 | 元素类型 | 功能说明 | 交互 |
|------|----------|----------|------|
| 線便コード | Text | 线路代码 | 表示 |
| 線便名 | Text | 线路名称 | 表示 |
| 土/日/月/火/水/木/金 | Button | 日期金额 | 点击编辑 |
| 承認済/未承認/差戻し | Tag | 状态 | 显示/切换 |
| version | Select | 版本选择 | プルダウン |

### 2.4 差戻し状态说明
| 状态 | 条件 | 操作 |
|------|------|------|
| 承認済 | 已承认 | 点击后可显示[差戻し]按钮 |
| 未承認 | 未承认 | - |
| 差戻し | 退回 | 从承認済状态点击可退回至未承認 |

### 2.2 Tabs组件
| Tab名 | 内容 | 权限 |
|-------|------|------|
| 確定前 | 日別傭車費一覧 | 可编辑 |
| 確定後 | 月間運行指示書（確定版） | 只读 |

### 2.3 日別傭車費一覧字段
| 字段 | 元素类型 | 功能说明 | 交互 |
|------|----------|----------|------|
| 線便コード | Text | 线路代码 | 表示 |
| 線便名 | Text | 线路名称 | 表示 |
| 土/日/月/火/水/木/金 | Button | 日期金额 | 点击编辑 |
| version | Select | 版本选择 | プルダウン |

---

## 3. 交互流程

### 3.1 Tabs切换流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击Tab | 切换显示内容 |
| 2 | 確定前 | 显示日別傭車費一覧（可编辑） |
| 3 | 確定後 | 显示確定版指示書（只读） |

### 3.2 费用编辑流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击金額格子 | 显示吹き出し |
| 2 | 输入変更内容 | 背景強調表示 |
| 3 | 点击変更を保存 | 保存数据 |
| 4 | 保存成功 | 显示成功提示 |

### 3.3 送付流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击送付按钮 | 显示确认对话框 |
| 2 | 确认发送 | 执行发送 |
| 3 | 发送成功 | 更新状态 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | 多区域组合+Tabs | - | Tab切换+表格 |

### 4.2 Tabs规范
| 属性 | 值 |
|------|-----|
| **Tab位置** | 顶部 |
| **Tab数** | 2 |
| **默认选中** | 確定前 |

### 4.3 表格规范
| 属性 | 值 |
|------|-----|
| **行高** | 固定高度 |
| **列宽** | 根据内容自适应 |
| **横向滚动** | 需要 |

---

## 5. API接口设计

### 5.1 业绩详情API
```yaml
# 获取业绩详情
GET /api/v1/completed-orders/{completedOrderId}
Authorization: Bearer {token}
```

### 5.2 费用表格API
```yaml
# 获取费用列表
GET /api/v1/completed-orders/{completedOrderId}/daily-costs
Authorization: Bearer {token}

# 保存费用变更
PUT /api/v1/completed-orders/{completedOrderId}/daily-costs
Authorization: Bearer {token}
Body: { changes: [...] }

# 送付费用
POST /api/v1/completed-orders/{completedOrderId}/daily-costs/send
Authorization: Bearer {token}
```

### 5.3 画面-API-数据库关系映射

#### 5.3.1 关系总览表

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|-------------|-------------|----------|
| **页面加载** | | | | |
| 页面初始化 | GET /api/v1/completed-orders/{completedOrderId} | 获取业绩详情基本信息 | t_completed_order | completed_order_id, partner_id, status, version, instruction_sent_datetime, committed_datetime |
| | | | m_partner | partner_id → partner_id, partner_name |
| | | | m_route | route_code → route_name |
| **輸送パートナー情報区** | | | | |
| 輸送パートナーID | GET /api/v1/completed-orders/{completedOrderId} | 显示合作伙伴ID | m_partner | partner_id |
| 輸送パートナー名 | GET /api/v1/completed-orders/{completedOrderId} | 显示合作伙伴名称 | m_partner | partner_name |
| **状態表示区** | | | | |
| 発注ID | GET /api/v1/completed-orders/{completedOrderId} | 显示业绩ID | t_completed_order | completed_order_id |
| ステータス | GET /api/v1/completed-orders/{completedOrderId} | 显示全承諾/未承諾状态 | t_completed_order | status (全承諾/未承諾) |
| version | GET /api/v1/completed-orders/{completedOrderId} |显示最新版本号 | t_completed_order | latest_version |
| 指示書送付 | GET /api/v1/completed-orders/{completedOrderId} | 显示发送时间 | t_completed_order | instruction_sent_datetime |
| 承諾 | GET /api/v1/completed-orders/{completedOrderId} | 显示承诺时间 | t_completed_order | committed_datetime |
| **確定前Tab - 日別傭車費一覧** | | | | |
| 切换到確定前Tab | GET /api/v1/completed-orders/{completedOrderId}/daily-costs | 获取费用表数据 | t_daily_vehicle_cost | completed_order_id, route_code, date, amount, status, version |
| | | | m_route | route_code → route_name |
| version選択 | GET /api/v1/completed-orders/{completedOrderId}/daily-costs | 按version筛选费用数据 | t_daily_vehicle_cost | version |
| 線便コード | GET /api/v1/completed-orders/{completedOrderId}/daily-costs | 显示线路代码 | m_route | route_code |
| 線便名 | GET /api/v1/completed-orders/{completedOrderId}/daily-costs | 显示线路名称 | m_route | route_name |
| 土/日/月/火/水/木/金（金額） | GET /api/v1/completed-orders/{completedOrderId}/daily-costs | 显示各日金额 | t_daily_vehicle_cost | date, amount |
| 金額格子点击 | - | 显示吹き出し编辑界面 | - | - |
| 吹き出し - 金額输入 | - | 编辑金额（前端暂存） | - | - |
| 吹き出し - 事由选择 | - | 选择变更原因（前端暂存） | - | - |
| 吹き出し - 変更後输入 | - | 输入变更后内容（前端暂存） | - | - |
| 背景強調表示 | - | 高亮显示已编辑格子 | - | - |
| マウスオーバー | - | 显示吹き出し内容 | t_daily_vehicle_cost_change | amount, reason, after_change |
| ＋追加（行追加） | - | 添加新费用行（前端暂存） | - | - |
| 変更を保存 | PUT /api/v1/completed-orders/{completedOrderId}/daily-costs | 保存费用变更数据 | t_daily_vehicle_cost | 更新 amount, status |
| | | | t_daily_vehicle_cost_change | 插入变更记录（route_code, date, amount, reason, after_change, change_datetime, changed_by） |
| 輸送パートナーに送付する | POST /api/v1/completed-orders/{completedOrderId}/daily-costs/send | 发送费用表给合作伙伴 | t_completed_order | 更新 instruction_sent_datetime |
| | | | t_daily_vehicle_cost | 更新 status = 送付済 |
| | | | t_sub_account | sub_account_id (振り分け用) |
| 代理承諾 | POST /api/v1/completed-orders/{completedOrderId}/daily-costs/proxy-commit | 代替合作伙伴承诺 | t_completed_order | 更新 committed_datetime |
| | | | t_daily_vehicle_cost | 更新 status = 承認済 |
| | | | t_action_log | 插入代理承諾操作记录 |
| サブアカウント振り分け - プルダウン | GET /api/v1/partners/{partnerId}/sub-accounts | 获取子账户列表 | t_sub_account | sub_account_id, sub_account_name, branch_office |
| サブアカウント振り分け - チェックボックス | - | 批量选择子账户 | - | - |
| 承認済状態 | GET /api/v1/completed-orders/{completedOrderId}/daily-costs | 显示已承诺状态 | t_daily_vehicle_cost | status = 承認済 |
| 未承認状態 | GET /api/v1/completed-orders/{completedOrderId}/daily-costs | 显示未承诺状态 | t_daily_vehicle_cost | status = 未承認 |
| 差戻し操作 | PUT /api/v1/completed-orders/{completedOrderId}/daily-costs/{routeCode}/{date}/status | 退回至未承诺 | t_daily_vehicle_cost | 更新 status = 未承認 |
| | | | t_action_log | 插入差戻し操作记录 |
| **確定後Tab - 月間運行指示書** | | | | |
| 切换到確定後Tab | GET /api/v1/completed-orders/{completedOrderId}/confirmed-instruction | 获取确定版指示书 | t_monthly_instruction | completed_order_id, instruction_content, signature_image, seal_image |
| 月間運行指示書内容 | GET /api/v1/completed-orders/{completedOrderId}/confirmed-instruction | 显示指示书内容 | t_monthly_instruction | instruction_content |
| 署名表示 | GET /api/v1/completed-orders/{completedOrderId}/confirmed-instruction | 显示署名图片 | t_monthly_instruction | signature_image |
| 捺印表示 | GET /api/v1/completed-orders/{completedOrderId}/confirmed-instruction | 显示捺印图片 | t_monthly_instruction | seal_image |
| **アクション履歴区** | | | | |
| アクション履歴表示 | GET /api/v1/completed-orders/{completedOrderId}/action-logs | 获取操作历史记录 | t_action_log | log_id, action_type, action_detail, action_datetime, action_by, related_data |
| **メッセージ区** | | | | |
| メッセージパネル表示 | GET /api/v1/completed-orders/{completedOrderId}/messages | 获取消息列表 | t_message | message_id, sender_id, receiver_id, content, sent_datetime, is_read |
| | | | m_user | sender_id → user_name |
| コメントボックス | - | 输入消息内容 | - | - |
| 送信ボタン | POST /api/v1/completed-orders/{completedOrderId}/messages | 发送消息 | t_message | 插入消息记录（sender_id, receiver_id, content, sent_datetime） |
| | | | t_completed_order | 更新 last_message_datetime |
| ファイルアップロードリンク | - | 触发文件上传 | - | - |
| ファイルアップロード | POST /api/v1/completed-orders/{completedOrderId}/messages/upload | 上传文件附件 | t_message_attachment | 插入附件记录（attachment_id, message_id, file_name, file_path, file_size, upload_datetime） |
| | | | t_message | 关联 message_id |
| ファイルダウンロード | GET /api/v1/messages/{messageId}/attachments/{attachmentId} | 下载文件 | t_message_attachment | file_path, file_name |
| **导航操作** | | | | |
| 返回ボタン | - | 返回b4-実績検索 | - | - |

#### 5.3.2 关系说明

**1. 页面加载流程**

```
页面初始化 (b5-実績詳細)
         ↓
GET /api/v1/completed-orders/{completedOrderId}
         ↓
后端查询: t_completed_order (主表)
         ↓
关联查询: m_partner (获取合作伙伴信息)
关联查询: m_route (获取线路信息)
         ↓
返回JSON给前端
         ↓
前端渲染:
  - 輸送パートナー情報区
  - 状態表示区
  - 默认显示確定前Tab
```

**2. 確定前Tab - 日別傭車費一覧加载流程**

```
切换到確定前Tab
         ↓
GET /api/v1/completed-orders/{completedOrderId}/daily-costs
         ↓
后端查询: t_daily_vehicle_cost (按completed_order_id)
         ↓
关联查询: m_route (获取线路名称)
         ↓
关联查询: t_daily_vehicle_cost_change (获取变更记录)
         ↓
返回费用表格数据
         ↓
前端渲染费用表格:
  - 線便コード、線便名
  - 土/日/月/火/水/木/金金額
  - 承認済/未承認/差戻し状态
  - version選択プルダウン
```

**3. 费用编辑保存流程**

```
用户点击金額格子
         ↓
前端显示吹き出し编辑界面
         ↓
用户输入: 金額、事由、変更後
         ↓
前端暂存编辑数据 + 背景強調显示
         ↓
用户点击【変更を保存】
         ↓
PUT /api/v1/completed-orders/{completedOrderId}/daily-costs
Body: { changes: [...] }
         ↓
后端处理:
  1. 更新 t_daily_vehicle_cost (amount, status)
  2. 插入 t_daily_vehicle_cost_change (变更记录)
  3. 插入 t_action_log (操作记录)
  4. 返回成功响应
         ↓
前端移除背景強调 + 显示成功提示
```

**4. 送付流程**

```
用户点击【輸送パートナーに送付する】
         ↓
前端显示确认对话框
         ↓
用户确认
         ↓
POST /api/v1/completed-orders/{completedOrderId}/daily-costs/send
Body: { subAccountId: "xxx" } (可选)
         ↓
后端处理:
  1. 更新 t_completed_order (instruction_sent_datetime = NOW())
  2. 更新 t_daily_vehicle_cost (status = 送付済)
  3. 插入 t_action_log (送付操作记录)
  4. 发送通知给合作伙伴
  5. 返回成功响应
         ↓
前端更新状态显示
```

**5. 代理承諾流程**

```
用户点击【代理承諾】
         ↓
前端显示确认对话框
         ↓
用户确认
         ↓
POST /api/v1/completed-orders/{completedOrderId}/daily-costs/proxy-commit
         ↓
后端处理:
  1. 更新 t_completed_order (committed_datetime = NOW())
  2. 更新 t_daily_vehicle_cost (status = 承認済)
  3. 插入 t_action_log (代理承諾操作记录)
  4. 发送通知给合作伙伴
  5. 返回成功响应
         ↓
前端更新状态显示
```

**6. メッセージ发送流程**

```
用户点击【メッセージ】ボタン
         ↓
GET /api/v1/completed-orders/{completedOrderId}/messages
         ↓
后端查询: t_message (按completed_order_id)
         ↓
关联查询: m_user (获取发送者名称)
         ↓
关联查询: t_message_attachment (获取附件信息)
         ↓
返回消息列表
         ↓
前端显示メッセージパネル

用户输入メッセージ内容
         ↓
用户点击【送信】
         ↓
POST /api/v1/completed-orders/{completedOrderId}/messages
Body: { content: "...", files: [...] }
         ↓
后端处理:
  1. 插入 t_message (消息记录)
  2. 更新 t_completed_order (last_message_datetime)
  3. 处理附件 (保存文件 + 插入 t_message_attachment)
  4. 发送通知给合作伙伴
  5. 返回成功响应
         ↓
前端更新メッセージ列表
```

**7. 数据表关系**

```
t_completed_order (实绩主表)
    ├─ id (主键)
    ├─ completed_order_id (实绩ID，业务主键)
    ├─ partner_id (合作伙伴ID，外键)
    │      └─→ m_partner.partner_id (关联合作伙伴信息)
    ├─ status (状态: 全承諾/未承諾)
    ├─ latest_version (最新版本号)
    ├─ instruction_sent_datetime (指示书发送时间)
    ├─ committed_datetime (承诺时间)
    ├─ last_message_datetime (最后消息时间)
    │
    ├─→ t_daily_vehicle_cost.completed_order_id (一对多)
    │      ├─ id (主键)
    │      ├─ route_code (线路代码)
    │      │      └─→ m_route.route_code (关联线路名称)
    │      ├─ date (日期)
    │      ├─ amount (金额)
    │      ├─ status (状态: 未承認/承認済/送付済/差戻し)
    │      ├─ version (版本号)
    │      │
    │      └─→ t_daily_vehicle_cost_change.route_id (一对多，变更记录)
    │             ├─ id (主键)
    │             ├─ amount (变更后金额)
    │             ├─ reason (变更原因)
    │             ├─ after_change (变更后说明)
    │             ├─ change_datetime (变更时间)
    │             └─ changed_by (变更者)
    │
    ├─→ t_monthly_instruction.completed_order_id (一对一，确定版指示书)
    │      ├─ id (主键)
    │      ├─ instruction_content (指示书内容)
    │      ├─ signature_image (署名图片)
    │      └─ seal_image (捺印图片)
    │
    ├─→ t_message.completed_order_id (一对多)
    │      ├─ id (主键)
    │      ├─ message_id (消息ID)
    │      ├─ sender_id (发送者ID)
    │      │      └─→ m_user.user_id (关联发送者名称)
    │      ├─ receiver_id (接收者ID)
    │      ├─ content (消息内容)
    │      ├─ sent_datetime (发送时间)
    │      ├─ is_read (是否已读)
    │      │
    │      └─→ t_message_attachment.message_id (一对多)
    │             ├─ id (主键)
    │             ├─ attachment_id (附件ID)
    │             ├─ file_name (文件名)
    │             ├─ file_path (文件路径)
    │             ├─ file_size (文件大小)
    │             └─ upload_datetime (上传时间)
    │
    └─→ t_action_log.completed_order_id (一对多)
           ├─ id (主键)
           ├─ log_id (日志ID)
           ├─ action_type (操作类型: 保存/送付/承諾/差戻し/代理承諾)
           ├─ action_detail (操作详情)
           ├─ action_datetime (操作时间)
           ├─ action_by (操作者)
           └─ related_data (关联数据JSON)

m_partner (合作伙伴表)
    ├─ id (主键)
    ├─ partner_id (合作伙伴ID)
    ├─ partner_name (合作伙伴名称)
    └─ partner_type (合作伙伴类型)
    │
    └─→ t_sub_account.partner_id (一对多，子账户)
           ├─ id (主键)
           ├─ sub_account_id (子账户ID)
           ├─ sub_account_name (子账户名称)
           ├─ branch_office (支店/営業所)
           └─ is_active (是否有效)

m_route (线路表)
    ├─ id (主键)
    ├─ route_code (线路代码)
    └─ route_name (线路名称)
```

**8. 字段映射关系**

| 画面元素 | 数据库表 | 源字段 | 目标字段 | 转换逻辑 |
|----------|---------|--------|---------|---------|
| 輸送パートナーID | m_partner | partner_id | - | 直接映射 |
| 輸送パートナー名 | m_partner | partner_name | - | 直接映射 |
| 発注ID | t_completed_order | completed_order_id | - | 直接映射 |
| ステータス | t_completed_order | status | - | 标签样式 |
| version | t_completed_order | latest_version | - | 直接映射 |
| 指示書送付 | t_completed_order | instruction_sent_datetime | - | 日期时间格式化 |
| 承諾 | t_completed_order | committed_datetime | - | 日期时间格式化 |
| 線便コード | m_route | route_code | - | 直接映射 |
| 線便名 | m_route | route_name | - | 直接映射 |
| 土/日/月/火/水/木/金 | t_daily_vehicle_cost | date, amount | - | 日期对应列 |
| 承認済/未承認/差戻し | t_daily_vehicle_cost | status | - | 标签样式 |
| 吹き出し - 金額 | t_daily_vehicle_cost_change | amount | - | 前端编辑后保存 |
| 吹き出し - 事由 | t_daily_vehicle_cost_change | reason | - | 前端编辑后保存 |
| 吹き出し - 変更後 | t_daily_vehicle_cost_change | after_change | - | 前端编辑后保存 |
| version選択 | t_daily_vehicle_cost | version | - | プルダウン筛选 |
| 月間運行指示書内容 | t_monthly_instruction | instruction_content | - | HTML渲染 |
| 署名 | t_monthly_instruction | signature_image | - | 图片显示 |
| 捺印 | t_monthly_instruction | seal_image | - | 图片显示 |
| アクション履歴 | t_action_log | 所有字段 | - | 列表显示 |
| メッセージ内容 | t_message | content | - | 直接映射 |
| メッセージ发送者 | m_user | user_name | - | 关联查询 |
| メッセージ附件 | t_message_attachment | file_name, file_path | - | 链接下载 |

#### 5.3.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           b5-実績詳細 画面                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  [確定前]  [確定後]                                                     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│         ↓                        ↓                                          │
│  ┌───────────────┐    ┌──────────────────┐                                 │
│  │ 輸送パートナー  │    │ 月間運行指示書     │                                 │
│  │ 情報表示       │    │ （確定版）        │                                 │
│  └───────┬───────┘    └────────┬─────────┘                                 │
│          │                     │                                           │
│  ┌───────┴───────┐    ┌────────┴─────────┐                                 │
│  │ 状態表示       │    │ 署名・捺印表示     │                                 │
│  └───────┬───────┘    └──────────────────┘                                 │
│          │                                                                 │
│  ┌───────┴──────────────────────────────────────────────────────────┐   │
│  │  日別傭車費一覧                                                      │   │
│  │  ┌────┬────┬────┬────┬────┬────┬────┬────┬────┐                    │   │
│  │  │線便│線便│ 土 │ 日 │ 月 │ 火 │ 水 │ 木 │ 金 │                    │   │
│  │  │コード│名  │ 金額│ 金額│ 金額│ 金額│ 金額│ 金額│ 金額│                    │   │
│  │  ├────┼────┼────┼────┼────┼────┼────┼────┼────┤                    │   │
│  │  │001 │線路A│10万│8万 │9万 │10万│8万 │9万 │10万│  ← 点击金額格子       │   │
│  │  └────┴────┴────┴────┴────┴────┴────┴────┴────┘                    │   │
│  │                                                                          │   │
│  │  操作按钮: [編集] [変更を保存] [輸送パートナーに送付する] [代理承諾]      │   │
│  │                                                                          │   │
│  │  サブアカウント振り分け: [プルダウン] [チェックボックス]                  │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                   ↓                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  アクション履歴                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                   ↓                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  メッセージ                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │   │
│  │  │ メッセージ列表                                                    │ │   │
│  │  └─────────────────────────────────────────────────────────────────┘ │   │
│  │  ┌─────────────────┐  ┌──────────────┐                               │   │
│  │  │ コメントボックス │  │ [送信]       │                               │   │
│  │  └─────────────────┘  └──────────────┘                               │   │
│  │  ┌─────────────────────────────────────────────┐                       │   │
│  │  │ [ファイルアップロード] [ダウンロード]        │                       │   │
│  │  └─────────────────────────────────────────────┘                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓                              ↓
          ┌────────────────┐           ┌────────────────┐
          │ 页面加载        │           │ 费用编辑保存    │
          │ GET completed   │           │ PUT daily-costs│
          │ -orders/{id}    │           └────────┬───────┘
          └────────┬───────┘                    │
                   ↓                            ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET daily-costs│           │ POST send      │
          │ (確定前Tab)     │           │ (送付)         │
          └────────┬───────┘           └────────┬───────┘
                   ↓                            ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET confirmed  │           │ POST proxy-    │
          │ instruction     │           │ commit        │
          │ (確定後Tab)     │           │ (代理承諾)     │
          └────────┬───────┘           └────────┬───────┘
                   ↓                            ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET action-    │           │ GET messages   │
          │ logs           │           └────────┬───────┘
          └────────────────┘                    │
                   ↓                            ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET sub-       │           │ POST messages  │
          │ accounts       │           │ (送信)         │
          └────────────────┘           └────────┬───────┘
                                               ↓
                                  ┌────────────────┐
                                  │ POST upload    │
                                  │ (ファイル添付)  │
                                  └────────────────┘
```

#### 5.3.4 核心数据库表结构

**t_completed_order（实绩主表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| completed_order_id | VARCHAR(50) | 实绩ID（业务主键） | UNIQUE |
| partner_id | VARCHAR(20) | 合作伙伴ID | → m_partner.partner_id |
| status | VARCHAR(20) | 状态 | 全承諾/未承諾 |
| latest_version | INTEGER | 最新版本号 | - |
| instruction_sent_datetime | TIMESTAMP | 指示书发送时间 | - |
| committed_datetime | TIMESTAMP | 承诺时间 | - |
| last_message_datetime | TIMESTAMP | 最后消息时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_daily_vehicle_cost（日别傭车费明细表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| cost_id | VARCHAR(50) | 费用ID | UNIQUE |
| completed_order_id | VARCHAR(50) | 实绩ID | → t_completed_order.completed_order_id |
| route_code | VARCHAR(20) | 线路代码 | → m_route.route_code |
| date | DATE | 日期 | - |
| amount | DECIMAL(12,2) | 金额 | - |
| status | VARCHAR(20) | 状态 | 未承認/承認済/送付済/差戻し |
| version | INTEGER | 版本号 | - |
| sub_account_id | VARCHAR(50) | 子账户ID | → t_sub_account.sub_account_id (可选) |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_daily_vehicle_cost_change（费用变更记录表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| change_id | VARCHAR(50) | 变更ID | UNIQUE |
| cost_id | VARCHAR(50) | 费用ID | → t_daily_vehicle_cost.cost_id |
| amount | DECIMAL(12,2) | 变更后金额 | - |
| reason | VARCHAR(100) | 变更原因 | - |
| after_change | TEXT | 变更后说明 | - |
| change_datetime | TIMESTAMP | 变更时间 | - |
| changed_by | VARCHAR(20) | 变更者 | → m_user.user_id |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_monthly_instruction（月间运行指示书表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| instruction_id | VARCHAR(50) | 指示书ID | UNIQUE |
| completed_order_id | VARCHAR(50) | 实绩ID | → t_completed_order.completed_order_id |
| instruction_content | TEXT | 指示书内容 | HTML |
| signature_image | TEXT | 署名图片路径 | - |
| seal_image | TEXT | 捺印图片路径 | - |
| version | INTEGER | 版本号 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_sub_account（子账户表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| sub_account_id | VARCHAR(50) | 子账户ID | UNIQUE |
| partner_id | VARCHAR(20) | 合作伙伴ID | → m_partner.partner_id |
| sub_account_name | VARCHAR(100) | 子账户名称 | - |
| branch_office | VARCHAR(100) | 支店/営業所 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_action_log（操作日志表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| log_id | VARCHAR(50) | 日志ID | UNIQUE |
| completed_order_id | VARCHAR(50) | 实绩ID | → t_completed_order.completed_order_id |
| action_type | VARCHAR(50) | 操作类型 | 保存/送付/承諾/差戻し/代理承諾 |
| action_detail | TEXT | 操作详情 | JSON格式 |
| action_datetime | TIMESTAMP | 操作时间 | - |
| action_by | VARCHAR(20) | 操作者 | → m_user.user_id |
| related_data | TEXT | 关联数据 | JSON格式 |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_message（消息表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| message_id | VARCHAR(50) | 消息ID | UNIQUE |
| completed_order_id | VARCHAR(50) | 实绩ID | → t_completed_order.completed_order_id |
| sender_id | VARCHAR(20) | 发送者ID | → m_user.user_id |
| receiver_id | VARCHAR(20) | 接收者ID | → m_user.user_id |
| content | TEXT | 消息内容 | - |
| sent_datetime | TIMESTAMP | 发送时间 | - |
| is_read | BOOLEAN | 是否已读 | DEFAULT FALSE |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_message_attachment（消息附件表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| attachment_id | VARCHAR(50) | 附件ID | UNIQUE |
| message_id | VARCHAR(50) | 消息ID | → t_message.message_id |
| file_name | VARCHAR(255) | 文件名 | - |
| file_path | VARCHAR(500) | 文件路径 | - |
| file_size | BIGINT | 文件大小（字节） | - |
| upload_datetime | TIMESTAMP | 上传时间 | - |
| uploaded_by | VARCHAR(20) | 上传者 | → m_user.user_id |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

---

## 6. 前端实现

### 6.1 Tabs组件
```typescript
// b5 Tabs组件
import { Tabs } from 'antd';

export const B5DetailPage: React.FC = () => {
  return (
    <Tabs defaultActiveKey="before">
      <Tabs.TabPane tab="確定前" key="before">
        <DailyCostTable />
      </Tabs.TabPane>
      <Tabs.TabPane tab="確定後" key="after">
        <ConfirmedInstruction />
      </Tabs.TabPane>
    </Tabs>
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 正确显示业绩详情
- [ ] Tabs切换正常
- [ ] 確定前：编辑功能正常
- [ ] 確定後：只读显示正常
- [ ] 保存功能正常
- [ ] 送付功能正常
- [ ] メッセージ功能正常

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] Tabs切换正确
- [ ] 表格显示正确

### 7.3 性能验收
- [ ] 页面加载 < 3秒
- [ ] 表格渲染 < 2秒
- [ ] 保存操作 < 1秒

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10 | v1.0.1 | 新增5.3节：画面-API-数据库关系映射表，包含详细的关系总览、关系说明、数据流图和核心数据库表结构 | - |
| 2026-02-XX | v1.0 | 初始版本 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b4-実績検索 | [../b4-実績検索/05_设计规范.md](../b4-実績検索/05_设计规范.md) | 列表页面设计规范 |

### A.2 与b3-発注詳細对比
| 特性 | b3-発注詳細 | b5-実績詳細 |
|------|-------------|-------------|
| **用户类型** | ベース | ベース |
| **Tab切换** | なし | あり |
| **表格类型** | 月間運行指示書 | 日別傭車費一覧 |
| **金额字段** | なし | あり |

---

**文档编制**: -  
**编制时间**: 2026-02-10 
**适用范围**: 別紙_画面一覧_v151.xlsx - b5-実績詳細  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
