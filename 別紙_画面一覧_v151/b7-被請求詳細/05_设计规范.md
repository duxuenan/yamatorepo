# b7-被請求詳細 - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b7-被請求詳細 |
| **界面编号** | b7 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b7-被請求詳細 是账单详情页面，提供账单详细信息展示、预览和确认功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- 基本信息显示
- 請求書プレビュー
- 金額確認
- 確認OK/NG操作
- 代理アップロード
- メッセージ交流

### 1.5 适用范围
- 前端开发人员（详情页面组件实现）
- 后端开发人员（账单API开发）
- 测试工程师（详情功能测试）

---

## 2. 页面元素

### 2.1 元素清单

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | 被請求年月 | 表示項目 | 対象年月表示 | - |
| ⑵ | 会社コード | 表示項目 | 会社コード表示 | - |
| ⑶ | 輸送パートナー名 | 表示項目 | パートナー名表示 | - |
| ⑷ | ステータス | タグ | 状況表示 | - |
| ⑸ | プレビュー | プレビュー | 画像表示 | 点击→弹窗 |
| ⑹ | 実績確認 | リンク | 跳转 | 点击→b5 |
| ⑺ | 請求書合計金額 | 表示項目 | OCR金額 | - |
| ⑻ | 実績合計金額 | 表示項目 | 実績金額 | - |
| ⑼ | 金額差異 | タグ | あり/なし | - |
| ⑽ | 更新日時 | 表示項目 | 更新日時 | - |
| ⑾ | 更新者 | 表示項目 | 更新者名 | - |
| ⑿ | ファイル名 | 表示項目 | ファイル名 | - |
| ⒀ | 請求書アップロード | ボタン | 代理上传 | 点击→选择文件 |
| ⒁ | 確認OK | ボタン | 确认 | 点击→更新状态 |
| ⒂ | 確認NG | ボタン | 拒绝 | 点击→更新状态 |
| ⒃ | メッセージ | パネル | 消息交流 | 点击→展开 |

### 2.2 ステータス详细说明
| 状态 | 条件 | 说明 | 颜色编码 |
|------|------|------|----------|
| 未提出 | 輸送パートナーが請求書をアップロードしていない | 輸送パートナーが本システムを利用しない場合、ベース側が代理アップロードしていない場合も含む | 灰色 |
| 要確認 | 金額不匹配 | 輸送パートナーがアップロードした請求書の合計金額と本システムが保持する実績の合計金額を突合し、金額が一致しない | 橙色 |
| チェック未 | 未确认 | アップロードされた請求書をチェックしていない | 黄色 |
| チェック済 | 已确认 | 請求詳細画面で「確認OK」ボタンが押下されたとき | 蓝色 |
| ビズインテグラル登録完了 | 已上传 | ビズインテグラル（別システム）に請求書（PDF）を手動アップロードした | 绿色 |

### 2.3 プレビュー功能

#### 缩略图显示
| 属性 | 值 |
|------|-----|
| **显示方式** | 网格排列 |
| **点击动作** | 放大显示 |
| **多图处理** | 分页 |

#### 放大预览
| 属性 | 值 |
|------|-----|
| **显示方式** | 模态弹窗 |
| **导航** | 上一页/下一页 |
| **关闭** | 閉じる按钮 |

---

## 3. 交互流程

### 3.1 页面加载流程
| 步骤 | 行为 | 系统响应 |
|------|------|----------|
| 1 | 页面初始化 | 获取账单ID |
| 2 | 获取账单详情 | 查询数据库 |
| 3 | 获取账单图片 | 加载图片URL |
| 4 | 显示详情 | 渲染页面 |

### 3.2 预览流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击图片 | 显示放大预览 |
| 2 | 翻页操作 | 切换图片 |
| 3 | 点击关闭 | 关闭预览 |

### 3.3 确认流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击OK/NG | 验证条件 |
| 2 | 确认操作 | 更新状态 |
| 3 | 刷新页面 | 显示新状态 |

### 3.4 上传流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击上传按钮 | 显示文件选择 |
| 2 | 选择文件 | 预览文件 |
| 3 | 确认上传 | 上传文件 |
| 4 | 刷新页面 | 显示上传结果 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | 上中下结构 | - | 信息+预览+操作 |

### 4.2 状态颜色
| 状态 | 颜色 | 说明 |
|------|------|------|
| 未提出 | 灰色 | 未上传 |
| 要確認 | 橙色 | 需确认 |
| チェック未 | 黄色 | 未检查 |
| チェック済 | 蓝色 | 已检查 |
| 差戻し | 红色 | 被退回 |

### 4.3 金额差異颜色
| 状态 | 颜色 | 说明 |
|------|------|------|
| なし | 绿色 | 金额一致 |
| あり | 红色 | 金额不一致 |

---

## 5. API接口设计

### 5.1 账单详情API
```yaml
# 获取账单详情
GET /api/v1/billing/{billingId}
Authorization: Bearer {token}
```

### 5.2 账单图片API
```yaml
# 获取账单图片列表
GET /api/v1/billing/{billingId}/images
Authorization: Bearer {token}

# 获取单张图片
GET /api/v1/billing/{billingId}/images/{imageId}
Authorization: Bearer {token}
```

### 5.3 确认操作API
```yaml
# 确认OK
POST /api/v1/billing/{billingId}/confirm-ok
Authorization: Bearer {token}

# 确认NG
POST /api/v1/billing/{billingId}/confirm-ng
Authorization: Bearer {token}
```

### 5.4 代理上传API
```yaml
# 代理上传
POST /api/v1/billing/{billingId}/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

### 5.4 画面-API-数据库关系映射

#### 5.4.1 关系总览表

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|-------------|-------------|----------|
| **页面加载** | | | | |
| 页面初始化 | GET /api/v1/billing/{billingId} | 获取账单详情 | t_billing | billing_id, year_month, company_code, partner_name, status, performance_total_amount, billing_total_amount, amount_difference, latest_action_datetime, latest_action_by |
| | | | m_partner | company_code → partner_name |
| | | | t_billing_ocr | billing_id → billing_ocr_amount |
| | | | t_billing_file | billing_id → file_name, file_path |
| | | | t_billing_action_log | billing_id → latest_action_datetime, latest_action_by |
| **基本信息区** | | | | |
| ⑴ 被請求年月 | GET /api/v1/billing/{billingId} | 显示対象年月 | t_billing | year_month (YYYY-MM格式) |
| ⑵ 会社コード | GET /api/v1/billing/{billingId} | 显示公司代码 | t_billing | company_code |
| ⑶ 輸送パートナー名 | GET /api/v1/billing/{billingId} | 显示合作伙伴名称 | m_partner | company_code → partner_name |
| ⑷ ステータス | GET /api/v1/billing/{billingId} | 显示请求状态 | t_billing | status (带颜色Tag) |
| **プレビュー区** | | | | |
| ⑸ サムネイル画像 | GET /api/v1/billing/{billingId}/images | 获取图片列表 | t_billing_file | file_path, file_name, file_thumbnail_path |
| プレビュー | GET /api/v1/billing/{billingId}/images/{imageId} | 获取单张图片 | t_billing_file | file_path |
| 拡大画像弹窗 | GET /api/v1/billing/{billingId}/images | 获取所有图片 | t_billing_file | file_path, file_name |
| | | | - | 前端分页显示 |
| **実績確認区** | | | | |
| ⑹ 実績確認リンク | - | 跳转到b5-実績詳細 | - | 携带completedOrderId |
| **金額情報区** | | | | |
| ⑺ 請求書合計金額 | GET /api/v1/billing/{billingId} | 显示OCR金额 | t_billing_ocr | billing_ocr_amount |
| | GET /api/v1/billing/{billingId} | 显示系统金额 | t_billing | billing_total_amount |
| ⑻ 実績合計金額 | GET /api/v1/billing/{billingId} | 显示实绩金额 | t_billing | performance_total_amount |
| | | | t_performance_summary | performance_total_amount |
| ⑼ 金額差異 | GET /api/v1/billing/{billingId} | 显示金额差異 | t_billing | amount_difference |
| | | | - | 計算: 請求書合計 - 実績合計 |
| **更新情報区** | | | | |
| ⑽ 更新日時 | GET /api/v1/billing/{billingId} | 显示最后更新时间 | t_billing_action_log | latest_action_datetime |
| ⑾ 更新者 | GET /api/v1/billing/{billingId} | 显示最后更新者 | t_billing_action_log | latest_action_by |
| | | | m_user | action_by → user_name |
| ⑿ ファイル名 | GET /api/v1/billing/{billingId} | 显示文件名 | t_billing_file | file_name |
| **操作按钮区** | | | | |
| ⒀ 請求書アップロード | POST /api/v1/billing/{billingId}/upload | 代理上传文件 | t_billing_file | 插入文件记录 (file_name, file_path, uploaded_by, uploaded_datetime) |
| | | | t_billing | status → 未提出/要確認/チェック未 (更新) |
| | | | t_billing_ocr | 插入OCR记录 (billing_ocr_amount, ocr_datetime, ocr_source=D-Just) |
| | | | t_billing_action_log | 插入代理上传记录 |
| ⒁ 確認OK | POST /api/v1/billing/{billingId}/confirm-ok | 确认通过 | t_billing | status → "チェック済" |
| | | | t_billing_action_log | 插入确认OK记录 (action_type="確認OK", action_detail=" billsing confirmed successfully") |
| ⒂ 確認NG | POST /api/v1/billing/{billingId}/confirm-ng | 确认拒绝 | t_billing | status → "差戻し" |
| | | | t_billing_action_log | 插入确认NG记录 (action_type="確認NG", action_detail=" billsing rejected, please re-upload") |
| **メッセージ区** | | | | |
| ⒃ メッセージ | GET /api/v1/billing/{billingId}/messages | 获取消息列表 | t_message | message_id, sender_id, receiver_id, content, sent_datetime, is_read |
| | | | m_user | sender_id → user_name |
| | POST /api/v1/billing/{billingId}/messages | 发送消息 | t_message | 插入消息记录 (sender_id, receiver_id, content, sent_datetime) |
| | POST /api/v1/billing/{billingId}/messages/upload | 上传附件 | t_message_attachment | 插入附件记录 (file_name, file_path) |
| | GET /api/v1/messages/{messageId}/attachments/{attachmentId} | 下载附件 | t_message_attachment | file_path, file_name |

#### 5.4.2 关系说明

**1. 页面加载流程**

```
页面初始化 (b7-被請求詳細)
         ↓
GET /api/v1/billing/{billingId}
         ↓
后端查询: t_billing (主表)
         ↓
关联查询: m_partner (获取合作伙伴名称)
关联查询: t_billing_file (获取文件信息)
关联查询: t_billing_action_log (获取最新操作记录)
关联查询: t_billing_ocr (获取OCR金额)
关联查询: t_performance_summary (获取实绩金额)
         ↓
计算逻辑:
  - 金額差異: IF(OCR金额 = 实绩金额, "なし", "あり")
  - 金額差分: 請求書合計 - 実績合計
         ↓
返回JSON给前端
         ↓
前端渲染:
  - 基本信息区 (⑴-⑷)
  - プレビュー区 (⑸)
  - 実績確認区 (⑹)
  - 金額情報区 (⑺-⑼)
  - 更新情報区 (⑽-⑿)
  - 操作按钮区 (⒀-⒂)
  - メッセージ区 (⒃)
```

**2. プレビュー加载流程**

```
页面加载
         ↓
GET /api/v1/billing/{billingId}/images
         ↓
后端查询: t_billing_file (WHERE billing_id = ? AND is_active = true)
         ↓
关联查询: t_file_storage (获取file_path)
         ↓
返回图片列表 (file_id, file_name, file_path, thumbnail_path)
         ↓
前端渲染:
  - サムネイル网格显示
  - 绑定点击事件
         ↓
用户点击图片
         ↓
显示拡大预览弹窗
         ↓
多图时分页切换
```

**3. 代理上传流程（⒀）**

```
用户点击【請求書アップロード】按钮
         ↓
显示文件选择对话框
         ↓
用户选择文件
         ↓
前端预览文件
         ↓
用户确认上传
         ↓
POST /api/v1/billing/{billingId}/upload
Content-Type: multipart/form-data
Body: { file: binary }
         ↓
后端处理:
  1. 验证文件类型 (PDF/JPG/PNG)
  2. 保存文件到存储服务
  3. 生成file_path
  4. 插入 t_billing_file (文件记录)
  5. 调用 D-Just OCR API 读取金额
  6. 插入 t_billing_ocr (OCR记录)
  7. 更新 t_billing (billing_total_amount = OCR金额)
  8. 插入 t_billing_action_log (代理上传记录)
  9. 计算金額差異
         ↓
返回成功响应
         ↓
前端刷新页面
```

**4. 確認OK流程（⒁）**

```
用户点击【確認OK】按钮
         ↓
显示确认对话框: "請求書に問題がないことを確認しましたか？"
         ↓
用户确认
         ↓
POST /api/v1/billing/{billingId}/confirm-ok
         ↓
后端处理:
  1. 验证当前状态 (必須: 未提出/要確認/チェック未)
  2. 更新 t_billing (status = "チェック済")
  3. 插入 t_billing_action_log (action_type="確認OK", action_detail=" confirmed successfully")
  4. 返回成功响应
         ↓
前端刷新页面
         ↓
ステータス显示为[チェック済] (蓝色Tag)
```

**5. 確認NG流程（⒂）**

```
用户点击【確認NG】按钮
         ↓
显示确认对话框: "請求書に問題があります。再アップロードを許可しますか？"
         ↓
用户确认
         ↓
POST /api/v1/billing/{billingId}/confirm-ng
         ↓
后端处理:
  1. 验证当前状态 (任意状态可拒绝)
  2. 更新 t_billing (status = "差戻し")
  3. 插入 t_billing_action_log (action_type="確認NG", action_detail=" rejected, please re-upload")
  4. 发送通知给輸送パートナー (可选)
  5. 返回成功响应
         ↓
前端刷新页面
         ↓
ステータス显示为[差戻し] (红色Tag)
```

**6. メッセージ发送流程（⒃）**

```
用户点击【メッセージ】按钮
         ↓
GET /api/v1/billing/{billingId}/messages
         ↓
后端查询: t_message (WHERE billing_id = ? AND is_active = true)
         ↓
关联查询: m_user (sender_id → user_name)
         ↓
返回消息列表
         ↓
前端显示メッセージパネル

用户输入メッセージ内容
         ↓
用户点击【送信】按钮
         ↓
POST /api/v1/billing/{billingId}/messages
Body: { content: "...", files: [...] }
         ↓
后端处理:
  1. 插入 t_message (消息记录)
  2. 处理文件附件 (插入 t_message_attachment)
  3. 更新 t_billing (last_message_datetime = NOW())
  4. 发送通知给パートナー (可选)
  5. 返回成功响应
         ↓
前端更新メッセージ列表
```

**7. 数据表关系**

```
t_billing（账单主表）
    ├─ id (主键)
    ├─ billing_id (账单ID，业务主键)
    ├─ year_month (年月)
    ├─ company_code (公司代码)
    │      └─→ m_partner.company_code
    ├─ partner_name (合作伙伴名称)
    │      └─→ m_partner.partner_name
    ├─ status (状态)
    ├─ amount_difference (金额差異)
    ├─ performance_total_amount (实绩合计金额)
    │      └─→ t_performance_summary
    ├─ billing_total_amount (账单合计金额)
    │      └─→ t_billing_ocr
    ├─ last_action_datetime (最后操作时间)
    ├─ last_action_by (最后操作者)
    │      └─→ m_user.user_id
    │
    ├─→ t_billing_file.billing_id (一对多)
    │      ├─ id (主键)
    │      ├─ file_id (文件ID)
    │      ├─ file_name (文件名)
    │      ├─ file_path (文件路径)
    │      ├─ file_size (文件大小)
    │      ├─ file_type (文件类型)
    │      ├─ thumbnail_path (缩略图路径)
    │      ├─ uploaded_by (上传者)
    │      │      └─→ m_user.user_id
    │      └─ uploaded_datetime (上传时间)
    │
    ├─→ t_billing_action_log.billing_id (一对多)
    │      ├─ id (主键)
    │      ├─ log_id (日志ID)
    │      ├─ action_type (操作类型)
    │      ├─ action_detail (操作详情)
    │      ├─ action_datetime (操作时间)
    │      ├─ action_by (操作者)
    │      │      └─→ m_user.user_id
    │      └─ related_data (关联数据)
    │
    ├─→ t_billing_ocr.billing_id (一对一)
    │      ├─ id (主键)
    │      ├─ ocr_id (OCR ID)
    │      ├─ billing_ocr_amount (OCR金额)
    │      ├─ ocr_datetime (OCR时间)
    │      ├─ ocr_source (OCR来源: D-Just)
    │      └─ is_valid (是否有效)
    │
    └─→ t_message.billing_id (一对多)
           ├─ id (主键)
           ├─ message_id (消息ID)
           ├─ sender_id (发送者)
           │      └─→ m_user.user_id
           ├─ receiver_id (接收者)
           │      └─→ m_user.user_id
           ├─ content (消息内容)
           ├─ sent_datetime (发送时间)
           ├─ is_read (是否已读)
           │
           └─→ t_message_attachment.message_id (一对多)
                  ├─ id (主键)
                  ├─ attachment_id (附件ID)
                  ├─ file_name (文件名)
                  ├─ file_path (文件路径)
                  └─ upload_datetime (上传时间)

m_partner（合作伙伴表）
    ├─ id (主键)
    ├─ partner_id (合作伙伴ID)
    ├─ company_code (公司代码)
    ├─ partner_name (合作伙伴名称)
    └─ partner_type (合作伙伴类型)

m_user（用户表）
    ├─ id (主键)
    ├─ user_id (用户ID)
    ├─ user_name (用户名)
    └─ role (角色)

t_performance_summary（实绩汇总表）
    ├─ id (主键)
    ├─ billing_id (账单ID)
    │      └─→ t_billing.billing_id
    ├─ completed_order_id (实绩ID)
    ├─ performance_total_amount (实绩合计金额)
    └─ summary_datetime (汇总时间)
```

**8. 字段映射关系**

| 画面元素 | 数据库表 | 源字段 | 目标字段 | 转换逻辑 |
|----------|---------|--------|---------|---------|
| 被請求年月 | t_billing | year_month | - | YYYY-MM格式转换 |
| 会社コード | t_billing | company_code | - | 直接映射 |
| 輸送パートナー名 | m_partner | partner_name | - | company_code关联查询 |
| ステータス | t_billing | status | - | 标签样式（颜色） |
| サムネイル画像 | t_billing_file | thumbnail_path | - | 直接映射 |
| 拡大画像 | t_billing_file | file_path | - | 直接映射 |
| 請求書合計金額 | t_billing_ocr | billing_ocr_amount | - | 直接映射 |
| | t_billing | billing_total_amount | - | 直接映射 |
| 実績合計金額 | t_billing | performance_total_amount | - | 直接映射 |
| | t_performance_summary | performance_total_amount | - | 直接映射 |
| 金額差異 | t_billing | amount_difference | - | 計算字段 + 标签样式 |
| 更新日時 | t_billing_action_log | latest_action_datetime | - | 日期时间格式化 |
| 更新者 | m_user | user_name | - | action_by关联查询 |
| ファイル名 | t_billing_file | file_name | - | 直接映射 |
| メッセージ内容 | t_message | content | - | 直接映射 |
| メッセージ发送者 | m_user | user_name | - | sender_id关联查询 |

#### 5.4.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           b7-被請求詳細 画面                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  基本信息区                                                            │ │
│  │  ⑴ 被請求年月: 2026-02    ⑵ 会社コード: 0001                         │ │
│  │  ⑶ 輸送パートナー名: 运输A    ⑷ ステータス: [チェック済]              │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑸ プレビュー区                                                        │ │
│  │  ┌─────┬─────┬─────┐                                                  │ │
│  │  │图片1 │图片2 │图片3 │  ← サムネイル                                 │ │
│  │  └─────┴─────┴─────┘                                                  │ │
│  │  [プレビュー] リンク → 拡大画像弹窗                                     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑹ 実績確認: [実績詳細画面を確認する] リンク                           │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑺-⑼ 金額情報区                                                       │ │
│  │  請求書合計金額: 100万    実績合計金額: 100万    金額差異: [なし]        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑽-⑿ 更新情報区                                                       │ │
│  │  更新日時: 2026-02-10 14:30    更新者: 山田太郎    ファイル名: xxx.pdf  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  操作按钮区                                                            │ │
│  │  ⒀ [請求書アップロード(代理登録)]  ⒁ [確認OK]  ⒂ [確認NG]           │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⒃ メッセージ: [メッセージ] ボタン                                     │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │ メッセージ面板 (右側展開)                                          │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓                              ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET billing/    │           │ POST billing/   │
          │ {billingId}     │           │ {billingId}/    │
          │ (页面加载)      │           │ upload          │
          └────────┬───────┘           │ (代理上传)      │
                   │                   └────────┬───────┘
                   ↓                            ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET billing/    │           │ POST billing/   │
          │ {billingId}/    │           │ {billingId}/    │
          │ images          │           │ confirm-ok      │
          │ (プレビュー)     │           │ (確認OK)        │
          └────────┬───────┘           └────────┬───────┘
                   │                            ↓
                   ↓                   ┌────────────────┐
          ┌────────────────┐           │ POST billing/   │
          │ POST billing/    │           │ {billingId}/    │
          │ {billingId}/    │           │ confirm-ng      │
          │ messages        │           │ (確認NG)        │
          │ (メッセージ)     │           └────────────────┘
          └────────┬───────┘
                   ↓
          ┌────────────────┐
          │ POST billing/   │
          │ {billingId}/    │
          │ messages/upload │
          │ (ファイル添付)   │
          └────────────────┘
```

#### 5.4.4 核心数据库表结构

**t_billing（账单主表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| billing_id | VARCHAR(50) | 账单ID（业务主键） | UNIQUE |
| year_month | VARCHAR(7) | 年月（YYYY-MM） | - |
| company_code | VARCHAR(20) | 公司代码 | → m_partner.company_code |
| partner_name | VARCHAR(100) | 合作伙伴名称 | → m_partner.partner_name |
| status | VARCHAR(20) | 状态 | 未提出/要確認/チェック未/チェック済/差戻し/ビズインテグラル登録完了 |
| amount_difference | VARCHAR(10) | 金额差異 | あり/なし |
| performance_total_amount | DECIMAL(12,2) | 实绩合计金额 | → t_performance_summary |
| billing_total_amount | DECIMAL(12,2) | 账单合计金额 | → t_billing_ocr |
| last_action_datetime | TIMESTAMP | 最后操作时间 | → t_billing_action_log |
| last_action_by | VARCHAR(20) | 最后操作者 | → m_user.user_id |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_billing_file（账单文件表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| file_id | VARCHAR(50) | 文件ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| file_name | VARCHAR(255) | 文件名 | - |
| file_path | VARCHAR(500) | 文件路径 | - |
| file_size | BIGINT | 文件大小（字节） | - |
| file_type | VARCHAR(20) | 文件类型 | PDF/JPG/PNG |
| thumbnail_path | VARCHAR(500) | 缩略图路径 | - |
| uploaded_by | VARCHAR(20) | 上传者 | → m_user.user_id |
| uploaded_datetime | TIMESTAMP | 上传时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_billing_action_log（账单操作日志表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| log_id | VARCHAR(50) | 日志ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| action_type | VARCHAR(50) | 操作类型 | 代理上传/確認OK/確認NG/プレビュー/メッセージ |
| action_detail | TEXT | 操作详情 | JSON格式 |
| action_datetime | TIMESTAMP | 操作时间 | - |
| action_by | VARCHAR(20) | 操作者 | → m_user.user_id |
| related_data | TEXT | 关联数据 | JSON格式 |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_billing_ocr（账单OCR表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| ocr_id | VARCHAR(50) | OCR ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| billing_ocr_amount | DECIMAL(12,2) | OCR读取金额 | - |
| ocr_datetime | TIMESTAMP | OCR识别时间 | - |
| ocr_source | VARCHAR(50) | OCR来源 | D-Just |
| is_valid | BOOLEAN | 是否有效 | DEFAULT TRUE |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_message（消息表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| message_id | VARCHAR(50) | 消息ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| sender_id | VARCHAR(20) | 发送者ID | → m_user.user_id |
| receiver_id | VARCHAR(20) | 接收者ID | → m_user.user_id |
| content | TEXT | 消息内容 | - |
| sent_datetime | TIMESTAMP | 发送时间 | - |
| is_read | BOOLEAN | 是否已读 | DEFAULT FALSE |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_message_attachment（消息附件表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| attachment_id | VARCHAR(50) | 附件ID | UNIQUE |
| message_id | VARCHAR(50) | 消息ID | → t_message.message_id |
| file_name | VARCHAR(255) | 文件名 | - |
| file_path | VARCHAR(500) | 文件路径 | - |
| file_size | BIGINT | 文件大小 | - |
| uploaded_by | VARCHAR(20) | 上传者 | → m_user.user_id |
| upload_datetime | TIMESTAMP | 上传时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**m_partner（合作伙伴表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| partner_id | VARCHAR(20) | 合作伙伴ID | UNIQUE |
| company_code | VARCHAR(20) | 公司代码 | UNIQUE |
| partner_name | VARCHAR(100) | 合作伙伴名称 | - |
| partner_type | VARCHAR(20) | 合作伙伴类型 | 輸送パートナー |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**m_user（用户表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| user_id | VARCHAR(20) | 用户ID | UNIQUE |
| user_name | VARCHAR(100) | 用户名 | - |
| role | VARCHAR(20) | 角色 | 管理者/発注担当/配車担当/計上担当 |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

---

### 6.1 详情页面组件
```typescript
// b7详情组件
import { Card, Button, Tag, Image, Modal } from 'antd';

export const B7DetailPage: React.FC = () => {
  const [previewVisible, setPreviewVisible] = useState(false);
  const [currentImage, setCurrentImage] = useState(0);

  const handlePreview = (index: number) => {
    setCurrentImage(index);
    setPreviewVisible(true);
  };

  return (
    <div className="b7-detail-container">
      <BasicInfoSection data={billingData} />
      <PreviewSection
        images={billingData.images}
        onPreview={handlePreview}
      />
      <AmountSection data={billingData} />
      <ActionButtons
        onConfirmOk={handleConfirmOk}
        onConfirmNg={handleConfirmNg}
        onUpload={handleUpload}
      />
      <MessageSection />
      <Modal
        visible={previewVisible}
        footer={null}
        onCancel={() => setPreviewVisible(false)}
      >
        <Image src={billingData.images[currentImage]} />
      </Modal>
    </div>
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 正确显示账单详情
- [ ] プレビュー功能正常
- [ ] 金額確認显示正确
- [ ] 確認OK功能正常
- [ ] 確認NG功能正常
- [ ] 代理上传功能正常
- [ ] メッセージ功能正常

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] 状态颜色正确
- [ ] 预览显示正确

### 7.3 性能验收
- [ ] 页面加载 < 2秒
- [ ] 预览加载 < 1秒

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10 | v1.0.1 | 新增5.4节：画面-API-数据库关系映射表，包含详细的关系总览、关系说明、数据流图和核心数据库表结构 | - |
| 2026-02-XX | v1.0 | 初始版本 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b6-被請求管理 | [../b6-被請求管理/05_设计规范.md](../b6-被請求管理/05_设计规范.md) | 列表页面设计规范 |

### A.2 与p7-被請求詳細对比
| 特性 | b7-被請求詳細 | p7-被請求詳細 |
|------|---------------|---------------|
| **用户类型** | ベース | 輸送パートナー |
| **设备支持** | PCのみ | PC/SP |

---

**文档编制**: -  
**编制时间**: 2026-02-10 
**适用范围**: 別紙_画面一覧_v151.xlsx - b7-被請求詳細  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
