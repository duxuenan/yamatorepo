# p2-発注検索 - 设计规范

## API接口设计

### 1. 获取お知らせ

```typescript
// GET /api/v1/notices
interface GetNoticesResponse {
  success: boolean;
  data: {
    notices: Notice[];
  };
}

interface Notice {
  noticeId: string;
  title: string;
  body: string;
  relatedPage: '発注詳細' | '実績確認' | '請求書アップロード';
  relatedOrderId?: string;
  publishDate: string;
}
```

### 2. 搜索订单

```typescript
// GET /api/v1/orders/search
interface SearchOrdersRequest {
  yearMonth?: string;
  orderId?: string;
  base?: string;
  status?: string[];
  page?: number;
  pageSize?: number;
}

interface Order {
  orderId: string;
  orderDate: string;
  baseName: string;
  status: string;
  version: number;
  instructionReceived: string;
  commitment: string | null;
}

interface SearchOrdersResponse {
  success: boolean;
  data: {
    orders: Order[];
    total: number;
  };
}
```

### 3. 获取ベース列表

```typescript
// GET /api/v1/bases
interface GetBasesResponse {
  success: boolean;
  data: {
    bases: Base[];
  };
}

interface Base {
  baseId: string;
  baseName: string;
}
```

## 前端组件设计

### 1. 页面组件结构

```
p2-OrderSearch/
├── index.tsx                    # 主页面组件
├── components/
│   ├── InformationSection.tsx  # お知らせ区域
│   ├── SearchForm.tsx          # 搜索表单
│   ├── OrderList.tsx           # 订单列表
│   └── OrderItem.tsx           # 订单项
├── hooks/
│   ├── useNotices.ts           # お知らせhook
│   └── useOrderSearch.ts       # 订单搜索hook
├── types/
│   └── order.ts               # 类型定义
└── utils/
    └── validation.ts           # 验证工具
```

### 2. 组件代码示例

```tsx
// index.tsx
import React from 'react';
import { InformationSection } from './components/InformationSection';
import { SearchForm } from './components/SearchForm';
import { OrderList } from './components/OrderList';

export const OrderSearchPage: React.FC = () => {
  return (
    <div className="order-search-page">
      <h1>発注検索</h1>

      <InformationSection />

      <SearchForm onSearch={handleSearch} />

      <OrderList orders={orders} total={total} />
    </div>
  );
};
```

## 后端服务设计

### 1. Controller

```java
@RestController
@RequestMapping("/api/v1/orders")
@RequiredArgsConstructor
public class OrderController {

    private final OrderService orderService;

    @GetMapping("/search")
    public ResponseEntity<SearchOrdersResponse> searchOrders(
            @RequestParam(required = false) String yearMonth,
            @RequestParam(required = false) String orderId,
            @RequestParam(required = false) String base,
            @RequestParam(required = false) List<String> status,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "20") int pageSize) {
        SearchOrdersResponse response = orderService.searchOrders(
                yearMonth, orderId, base, status, page, pageSize);
        return ResponseEntity.ok(response);
    }
}
```

### 2. Service

```java
@Service
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;

    public SearchOrdersResponse searchOrders(
            String yearMonth, String orderId, String base,
            List<String> status, int page, int pageSize) {

        Specification<Order> spec = Specification.where(null);

        if (yearMonth != null) {
            spec = spec.and((root, query, cb) ->
                cb.equal(root.get("orderDate"), yearMonth));
        }

        if (orderId != null) {
            spec = spec.and((root, query, cb) ->
                cb.like(root.get("orderId"), "%" + orderId + "%"));
        }

        if (base != null) {
            spec = spec.and((root, query, cb) ->
                cb.equal(root.get("baseId"), base));
        }

        if (status != null && !status.isEmpty()) {
            spec = spec.and((root, query, cb) ->
                root.get("status").in(status));
        }

        Page<Order> resultPage = orderRepository.findAll(spec,
                PageRequest.of(page - 1, pageSize));

        return SearchOrdersResponse.builder()
                .success(true)
                .data(SearchOrdersResponse.SearchResultData.builder()
                        .orders(resultPage.getContent())
                        .total((int) resultPage.getTotalElements())
                        .build())
                .build();
    }
}
```

## 数据库表设计

### 1. orders 表

```sql
CREATE TABLE orders (
    order_id VARCHAR(50) PRIMARY KEY,
    order_date VARCHAR(7) NOT NULL,
    base_id VARCHAR(50) NOT NULL,
    base_name VARCHAR(200) NOT NULL,
    status VARCHAR(50) NOT NULL,
    version INT DEFAULT 1,
    instruction_received TIMESTAMP,
    commitment TIMESTAMP,
    partner_id VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (base_id) REFERENCES bases(base_id),
    FOREIGN KEY (partner_id) REFERENCES partner_companies(company_id)
);

CREATE INDEX idx_orders_date ON orders(order_date);
CREATE INDEX idx_orders_base ON orders(base_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_partner ON orders(partner_id);
```

### 2. notices 表

```sql
CREATE TABLE notices (
    notice_id VARCHAR(50) PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    body TEXT NOT NULL,
    related_page VARCHAR(50) NOT NULL,
    related_order_id VARCHAR(50),
    publish_date DATE NOT NULL,
    expiry_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notices_date ON notices(publish_date);
```

## 性能优化建议

### 1. 搜索优化

```sql
-- 使用复合索引
CREATE INDEX idx_orders_search ON orders(order_date, base_id, status, partner_id);
```

### 2. 分页优化

```sql
-- 使用游标分页
SELECT * FROM orders
WHERE order_id > :lastOrderId
ORDER BY order_id
LIMIT :pageSize;
```
