# p2-発注検索 - 设计规范

## 1. 功能概述

### 1.1 文档信息

| 项目 | 内容 |
|------|------|
| **工作表名称** | p2-発注検索 |
| **界面编号** | p2 |
| **文档版本** | v1.0 |
| **最后更新** | 2026-02-10 |
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述

p2-発注検索是パートナー（合作伙伴）侧的订单搜索页面，用于合作伙伴搜索和查看收到的订单。

- お知らせ显示：显示系统通知/公告信息
- 订单搜索：按年/月、订单ID、ベース、状态搜索订单
- 订单列表：显示搜索结果，支持分页
- 订单详情跳转：点击订单跳转到p3-発注詳細

### 1.3 页面结构

| 区域 | 功能 |
|------|------|
| お知らせ区域 | 显示系统通知、跳转相关页面 |
| 検索条件区域 | 年月选择、订单ID输入、ベース选择、状态筛选 |
| 订单列表区域 | 显示订单列表，支持分页和详情跳转 |

### 1.4 核心功能

| 功能 | 描述 | 优先级 |
|------|------|--------|
| お知らせ显示 | 显示系统通知列表 | P0 |
| 订单搜索 | 多条件组合搜索订单 | P0 |
| 订单列表 | 显示搜索结果 | P0 |
| 详情跳转 | 跳转到订单详情页面 | P0 |
| 分页功能 | 结果分页展示 | P1 |

### 1.5 适用范围

- 前端开发人员（搜索页面组件实现）
- 后端开发人员（订单API开发）
- 测试工程师（功能测试）

---

## 2. 页面元素

### 2.1 お知らせ区域

| 序号 | 元素名称 | 元素类型 | 功能说明 |
|------|----------|----------|----------|
| ⑴ | お知らせ列表 | List | 通知列表显示 |
| ⑵ | タイトル | Text | 通知标题 |
| ⑶ | 本文 | Text | 通知内容 |
| ⑷ | 関連ページ | Link | 跳转链接 |

### 2.2 検索条件区域

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑸ | 年月 | Select | 年月选择 | プルダウン選択 |
| ⑹ | 注文ID | Input | 订单ID输入 | 文字入力 |
| ⑺ | ベース | Select | ベース选择 | プルダウン選択 |
| ⑻ | 状態 | Checkbox | 状态多选 | チェック選択 |
| ⑼ | 検索ボタン | Button | 执行搜索 | クリック |

### 2.3 订单列表区域

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑽ | 注文ID列 | Link | 订单ID | クリック→p3 |
| ⑾ | 発注日付列 | Text | 发注日期 | 表示 |
| ⑿ | ベース名列 | Text | ベース名 | 表示 |
| ⒀ | 状態列 | Tag | 订单状态 | Tag表示 |
| ⒁ | 指示書受領列 | Text | 指示書收到 | 表示 |
| ⒂ | 確定期限列 | Text | 確定期限 | 表示 |
| ⒃ | ページネーション | Pagination | 分页控件 | クリック |

---

## 3. 交互流程

### 3.1 页面加载流程

| ステップ | アクション | システム応答 |
|----------|-----------|--------------|
| 1 | ユーザーがp2ページへ遷移 | ページ初期化 |
| 2 | お知らせAPI実行 | GET /api/v1/notices |
| 3 | ベースリストAPI実行 | GET /api/v1/bases |
| 4 | デフォルト検索実行 | 全件検索 |
| 5 | APIレスポンス受信 | 検索結果表示 |
| 6 | ページ表示完了 | ユーザー操作待機 |

### 3.2 搜索操作流程

| ステップ | ユーザー操作 | システム応答 |
|----------|-------------|--------------|
| 1 | 検索条件入力/選択 | リアルタイムバリデーション |
| 2 | 検索ボタンクック | ローディング表示開始 |
| 3 | 検索パラメータ構築 | 各フィールド値取得 |
| 4 | APIリクエスト送信 | GET /api/v1/orders/search |
| 5 | レスポンス受信 | テーブルデータ更新 |
| 6 | ページネーション更新 | 合計件数表示更新 |

### 3.3 详情跳转流程

| ステップ | ユーザー操作 | システム応答 |
|----------|-------------|--------------|
| 1 | 注文IDリンククリック | p3页面へ遷移 |
| 2 | URLパラメータ設定 | /p3/{orderId} |
| 3 | 詳細ページロード | 注文情報表示 |

---

## 4. 界面规范

### 4.1 页面布局

| 属性 | PC端値 | SP端値 | 説明 |
|------|--------|--------|------|
| **ページタイプ** | PCのみ | - | PC专用页面 |
| **レイアウト方式** | 上→下配置 | 垂直配置 | お知らせ→検索→リスト |
| **セクション間隔** | 24px | 16px | カード間余白 |

### 4.2 お知らせ区域规格

| 属性 | 値 | 説明 |
|------|----|------|
| **リスト高** | 固定高 | 最大3件显示 |
| **フォントサイズ** | 14px | 標準テキスト |

### 4.3 検索条件区域规格

| 属性 | PC端値 | 説明 |
|------|--------|------|
| **ラベル幅** | 80px | 固定幅 |
| **入力欄幅** | 180px | PC端固定幅 |
| **ラジオ/チェック間隔** | 16px | オプション間余白 |

### 4.4 订单列表规格

| 属性 | 値 | 説明 |
|------|----|------|
| **行高** | 48px | 固定行高 |
| **縞模様** | 有り | 偶数行背景#fafafa |
| **ホバー効果** | 有り | 行ホバー背景#f5f5f5 |
| **ページネーション** | 有り | 底部显示 |

### 4.5 状态标签颜色

| 状態 | 背景色 | 文字色 | 説明 |
|------|--------|--------|------|
| 配送完了 | #52c41a | #ffffff | 绿色 |
| 配送中 | #1890ff | #ffffff | 蓝色 |
| 未着手 | #fa8c16 | #ffffff | 橙色 |
| 受付済 | #722ed1 | #ffffff | 紫色 |

---

## 5. API接口设计

### 5.1 获取お知らせ

```typescript
// GET /api/v1/notices
interface GetNoticesResponse {
  success: boolean;
  data: {
    notices: Notice[];
  };
}

interface Notice {
  noticeId: string;
  title: string;
  body: string;
  relatedPage: '発注詳細' | '実績確認' | '請求書アップロード';
  relatedOrderId?: string;
  publishDate: string;
}
```

### 5.2 搜索订单

```typescript
// GET /api/v1/orders/search
interface SearchOrdersRequest {
  yearMonth?: string;
  orderId?: string;
  base?: string;
  status?: string[];
  page?: number;
  pageSize?: number;
}

interface Order {
  orderId: string;
  orderDate: string;
  baseName: string;
  status: string;
  version: number;
  instructionReceived: string;
  commitment: string | null;
}

interface SearchOrdersResponse {
  success: boolean;
  data: {
    orders: Order[];
    total: number;
  };
}
```

### 5.3 获取ベース列表

```typescript
// GET /api/v1/bases
interface GetBasesResponse {
  success: boolean;
  data: {
    bases: Base[];
  };
}

interface Base {
  baseId: string;
  baseName: string;
}
```

---

## 6. 前端组件设计

### 6.1 页面组件结构

```
p2-OrderSearch/
├── index.tsx                    # 主页面组件
├── components/
│   ├── InformationSection.tsx  # お知らせ区域
│   ├── SearchForm.tsx          # 搜索表单
│   ├── OrderList.tsx           # 订单列表
│   └── OrderItem.tsx           # 订单项
├── hooks/
│   ├── useNotices.ts           # お知らせhook
│   └── useOrderSearch.ts       # 订单搜索hook
├── types/
│   └── 类型定义
└── utils/
    └── validation.ts           order.ts               # # 验证工具
```

### 6.2 组件代码示例

```tsx
// index.tsx
import React from 'react';
import { InformationSection } from './components/InformationSection';
import { SearchForm } from './components/SearchForm';
import { OrderList } from './components/OrderList';

export const OrderSearchPage: React.FC = () => {
  return (
    <div className="order-search-page">
      <h1>発注検索</h1>

      <InformationSection />

      <SearchForm onSearch={handleSearch} />

      <OrderList orders={orders} total={total} />
    </div>
  );
};
```

---

## 7. 后端服务设计

### 7.1 Controller

```java
@RestController
@RequestMapping("/api/v1/orders")
@RequiredArgsConstructor
public class OrderController {

    private final OrderService orderService;

    @GetMapping("/search")
    public ResponseEntity<SearchOrdersResponse> searchOrders(
            @RequestParam(required = false) String yearMonth,
            @RequestParam(required = false) String orderId,
            @RequestParam(required = false) String base,
            @RequestParam(required = false) List<String> status,
            @RequestParam(defaultValue = "1") int page,
            @RequestParam(defaultValue = "20") int pageSize) {
        SearchOrdersResponse response = orderService.searchOrders(
                yearMonth, orderId, base, status, page, pageSize);
        return ResponseEntity.ok(response);
    }
}
```

### 7.2 Service

```java
@Service
@RequiredArgsConstructor
public class OrderService {

    private final OrderRepository orderRepository;

    public SearchOrdersResponse searchOrders(
            String yearMonth, String orderId, String base,
            List<String> status, int page, int pageSize) {

        Specification<Order> spec = Specification.where(null);

        if (yearMonth != null) {
            spec = spec.and((root, query, cb) ->
                cb.equal(root.get("orderDate"), yearMonth));
        }

        if (orderId != null) {
            spec = spec.and((root, query, cb) ->
                cb.like(root.get("orderId"), "%" + orderId + "%"));
        }

        if (base != null) {
            spec = spec.and((root, query, cb) ->
                cb.equal(root.get("baseId"), base));
        }

        if (status != null && !status.isEmpty()) {
            spec = spec.and((root, query, cb) ->
                root.get("status").in(status));
        }

        Page<Order> resultPage = orderRepository.findAll(spec,
                PageRequest.of(page - 1, pageSize));

        return SearchOrdersResponse.builder()
                .success(true)
                .data(SearchOrdersResponse.SearchResultData.builder()
                        .orders(resultPage.getContent())
                        .total((int) resultPage.getTotalElements())
                        .build())
                .build();
    }
}
```

---

## 8. 数据库表设计

### 8.1 orders 表

```sql
CREATE TABLE orders (
    order_id VARCHAR(50) PRIMARY KEY,
    order_date VARCHAR(7) NOT NULL,
    base_id VARCHAR(50) NOT NULL,
    base_name VARCHAR(200) NOT NULL,
    status VARCHAR(50) NOT NULL,
    version INT DEFAULT 1,
    instruction_received TIMESTAMP,
    commitment TIMESTAMP,
    partner_id VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (base_id) REFERENCES bases(base_id),
    FOREIGN KEY (partner_id) REFERENCES partner_companies(company_id)
);

CREATE INDEX idx_orders_date ON orders(order_date);
CREATE INDEX idx_orders_base ON orders(base_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_partner ON orders(partner_id);
```

### 8.2 notices 表

```sql
CREATE TABLE notices (
    notice_id VARCHAR(50) PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    body TEXT NOT NULL,
    related_page VARCHAR(50) NOT NULL,
    related_order_id VARCHAR(50),
    publish_date DATE NOT NULL,
    expiry_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notices_date ON notices(publish_date);
```

---

## 9. 画面-API-数据库关系映射表

### 9.1 关系总览表

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|--------------|--------------|----------|
| お知らせ列表 | GET /api/v1/notices | 获取通知列表 | m_notices | 字段直接映射 |
| お知らせ标题 | GET /api/v1/notices | 显示通知标题 | m_notices | title → title |
| お知らせ内容 | GET /api/v1/notices | 显示通知正文 | m_notices | body → body |
| お知らせ関連ページ | GET /api/v1/notices | 跳转相关页面 | m_notices | related_page → relatedPage |
| 年月選択 | GET /api/v1/orders/search | 搜索订单（年月） | m_orders | order_date = yearMonth |
| 注文ID入力 | GET /api/v1/orders/search | 搜索订单（ID） | m_orders | order_id LIKE %orderId% |
| ベース選択 | GET /api/v1/orders/search | 搜索订单（ベース） | m_orders | base_id = base |
| ベース選択 | GET /api/v1/bases | 获取ベース列表 | m_bases | 字段直接映射 |
| 状態選択 | GET /api/v1/orders/search | 搜索订单（状态） | m_orders | status IN (status[]) |
| 注文リスト | GET /api/v1/orders/search | 获取订单列表 | m_orders | 字段直接映射 |
| 注文ID列 | GET /api/v1/orders/search | 显示订单ID | m_orders | order_id → orderId |
| 発注日付列 | GET /api/v1/orders/search | 显示発注日期 | m_orders | order_date → orderDate |
| ベース名列 | GET /api/v1/orders/search | 显示ベース名 | m_orders | base_name → baseName |
| 状態列 | GET /api/v1/orders/search | 显示订单状态 | m_orders | status → status |
| 指示書受領列 | GET /api/v1/orders/search | 显示指示書收到 | m_orders | instruction_received → instructionReceived |
| 確定期限列 | GET /api/v1/orders/search | 显示確定期限 | m_orders | commitment → commitment |

### 9.2 关系说明

**页面加载流程**：
1. 用户访问p2页面
2. 并行调用notices API、bases API
3. API从m_notices获取通知数据
4. API从m_bases获取ベースリスト
5. 默认执行orders/search API获取全部订单
6. 渲染页面各区域

**订单搜索流程**：
1. 用户选择搜索条件（年月/订单ID/ベース/状态）
2. 点击検索按钮
3. 构建查询参数
4. 调用orders/search API
5. 后端在m_orders上执行带条件的分页查询
6. 返回搜索结果

**数据表关系（ER图）**：

```
┌─────────────────────────────────────────────────────────────┐
│                       m_orders                               │
├─────────────────────────────────────────────────────────────┤
│ PK: order_id                                                │
│ FK: base_id ─────────────────────► m_bases                 │
│ FK: partner_id ──────────────────► m_partner_companies     │
│    order_date                                               │
│    base_name                                                │
│    status                                                   │
│    version                                                  │
│    instruction_received                                     │
│    commitment                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ N:1
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      m_notices                                │
├─────────────────────────────────────────────────────────────┤
│ PK: notice_id                                               │
│    title                                                    │
│    body                                                     │
│    related_page                                             │
│    related_order_id ───────────────► m_orders               │
│    publish_date                                             │
└─────────────────────────────────────────────────────────────┘
```

**字段映射逻辑**：
- m_orders.order_date (VARCHAR(7)) ↔ API orderDate (YYYY-MM格式)
- m_orders.status ↔ API status
- m_orders.instruction_received (TIMESTAMP) ↔ API instructionReceived
- m_orders.commitment (TIMESTAMP) ↔ API commitment

### 9.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户操作层                                       │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐              │
│  │お知らせ閲覧│    │条件選択   │    │検索ﾎﾞﾀﾝ   │    │注文選択   │              │
│  │  List   │    │ Form    │    │ Button   │    │ Table行  │              │
│  └────┬─────┘    └────┬─────┘    └────┬─────┘    └────┬─────┘              │
└───────┼──────────────┼──────────────┼──────────────┼───────────────────────┘
        │              │              │              │
        │ GET          │ GET          │ GET          │ GET
        ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           React Frontend                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │                      OrderSearchPage.tsx                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐    │   │
│  │  │Information  │  │ SearchForm  │  │  OrderList Component         │    │   │
│  │  │  Section    │  │ (検索フォーム)│  │  (注文リスト)             │    │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────────┘    │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
        │              │              │
        │ GET          │ GET          │ GET
        ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         REST API Layer                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐   │
│  │  GET /api/v1/notices                                                  │   │
│  │  GET /api/v1/orders/search                                           │   │
│  │  GET /api/v1/bases                                                   │   │
│  └───────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
        │              │              │
        │ SQL SELECT   │ SQL SELECT   │ SQL SELECT
        ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Database Layer (PostgreSQL)                         │
│  ┌────────────────────────────────────────┐  ┌────────────────────────────┐  │
│  │       m_orders                          │  │       m_notices            │  │
│  │       (注文テーブル)                   │  │       (お知らせテーブル)  │  │
│  └────────────────────────────────────────┘  └────────────────────────────┘  │
│         ▲                                      │                            │
│         │ FK                                   │ FK                          │
│         │                                      ▼                            │
│  ┌────────────────────────────────────────┐                                 │
│  │            m_bases                       │                                 │
│  │            (ンベーステーブル)            │                                 │
│  └────────────────────────────────────────┘                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.4 核心数据库表结构

**m_orders（订单表）**

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| order_id | VARCHAR(50) | PK, NOT NULL | - | 注文ID |
| order_date | VARCHAR(7) | NOT NULL | - | 発注日期（YYYY-MM） |
| base_id | VARCHAR(50) | FK → m_bases, NOT NULL | - | ンベースID |
| base_name | VARCHAR(200) | NOT NULL | - | ンベース名 |
| status | VARCHAR(50) | NOT NULL | - | 注文状態 |
| version | INT | NOT NULL | 1 | バージョン（楽観鎖） |
| instruction_received | TIMESTAMP | NULL | - | 指示書受領日時 |
| commitment | TIMESTAMP | NULL | - | 確定期限 |
| partner_id | VARCHAR(50) | FK → m_partner_companies, NOT NULL | - | パートナーID |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 更新日時 |

**m_notices（通知表）**

| フィールド名 | データ型 | 制約 | デフォルト | 説明 |
|--------------|----------|------|------------|------|
| notice_id | VARCHAR(50) | PK, NOT NULL | - | お知らせID |
| title | VARCHAR(200) | NOT NULL | - | タイトル |
| body | TEXT | NOT NULL | - | 本文 |
| related_page | VARCHAR(50) | NOT NULL | - | 関連ページ |
| related_order_id | VARCHAR(50) | FK → m_orders, NULL | - | 関連注文ID |
| publish_date | DATE | NOT NULL | - | 公開日 |
| expiry_date | DATE | NULL | - | 有効期限 |
| created_at | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 作成日時 |

**m_bases（ンベース主表）**

| フィールド名 | データ型 | 制約 | デフォルト | 説明 |
|--------------|----------|------|------------|------|
| base_id | VARCHAR(50) | PK, NOT NULL | - | ンベースID |
| base_name | VARCHAR(200) | NOT NULL | - | ンベース名 |
| base_type | ENUM('ンベース','本社') | NOT NULL | 'ンベース' | ンベースタイプ |

**关联关系说明**：
- `m_orders` と `m_bases` は N:1 関係（複数の注文が1つのンベースに属する）
- `m_orders` と `m_partner_companies` は N:1 関係（複数の注文が1つのパートナーに属する）
- `m_notices` と `m_orders` は N:1 関係（注が注文に関連付けられる場合がある）

**インデックス最適化**：
- idx_orders_date: 年月フィルタリング用
- idx_orders_base: ンベースフィルタリング用
- idx_orders_status: 状態フィルタリング用
- idx_orders_partner: パートナーフィルタリング用

---

## 10. 性能优化建议

### 10.1 搜索优化

```sql
-- 使用复合索引
CREATE INDEX idx_orders_search ON orders(order_date, base_id, status, partner_id);
```

### 10.2 分页优化

```sql
-- 使用游标分页
SELECT * FROM orders
WHERE order_id > :lastOrderId
ORDER BY order_id
LIMIT :pageSize;
```

---

## 11. 验收标准

### 11.1 功能验收

| 测试场景 | 预期结果 | 优先级 |
|----------|----------|--------|
| 页面初始加载 | 显示お知らせ、ンベースリスト、全注文リスト | P0 |
| お知らせ显示 | 正确显示通知列表 | P0 |
| 年月筛选 | 按選択された年月筛选 | P0 |
| 注文ID搜索 | 支持部分匹配搜索 | P0 |
| ンベース筛选 | 正确筛选指定ンベース | P0 |
| 状态筛选 | 支持多选状态筛选 | P0 |
| 组合搜索 | 多条件AND逻辑正确 | P0 |
| 分页功能 | 正常翻页，每页大小切换 | P0 |
| 详情跳转 | 跳转到p3详情页 | P0 |

### 11.2 视觉验收

| 项目 | 要求 |
|------|------|
| 布局 | 与设计稿一致 |
| 颜色 | 状态标签颜色正确 |
| 间距 | 符合UI规范 |

---

## 12. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10 | v1.0.1 | 重新整理章节顺序，添加画面-API-数据库关系映射表 | - |
| 2026-02-05 | v1.0 | 初始版本 | - |

---

**文档编制**: -  
**编制时间**: 2026-02-10  
**适用范围**: p2-発注検索 合作伙伴订单搜索页面
