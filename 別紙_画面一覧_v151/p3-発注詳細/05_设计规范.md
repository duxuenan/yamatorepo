# p3-ç™ºæ³¨è©³ç´° - è®¾è®¡è§„èŒƒ

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ–‡æ¡£ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å·¥ä½œè¡¨åç§°** | p3-ç™ºæ³¨è©³ç´° |
| **ç•Œé¢ç¼–å·** | p3 |
| **å¯¹åº”Baseç•Œé¢** | b3-ç™ºæ³¨è©³ç´° |
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0 |
| **æœ€åæ›´æ–°** | 2026-02-XX|
| **æ–‡æ¡£çŠ¶æ€** | âœ… å·²å‘å¸ƒ |

### 1.2 åŠŸèƒ½æè¿°

p3-ç™ºæ³¨è©³ç´° æ˜¯åˆä½œä¼™ä¼´ï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼‰ä¾§æŸ¥çœ‹å’Œæ“ä½œè®¢å•è¯¦æƒ…çš„é¡µé¢ã€‚ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¯ä»¥é€šè¿‡æ­¤é¡µé¢ï¼š

- æŸ¥çœ‹æ¥è‡ªãƒ™ãƒ¼ã‚¹ï¼ˆæ€»éƒ¨ï¼‰çš„è®¢å•è¯¦ç»†ä¿¡æ¯
- å¯¹è®¢å•è¿›è¡Œæ‰¿è¯ºï¼ˆæ‰¿è«¾ï¼‰æˆ–æ‹’ç»ï¼ˆå´ä¸‹ï¼‰æ“ä½œ
- æ·»åŠ å¤„ç†å¤‡æ³¨ï¼ˆãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å‚™è€ƒï¼‰
- è·Ÿè¸ªè®¢å•çŠ¶æ€å˜åŒ–

### 1.3 æŠ€æœ¯æ¶æ„

æœ¬æ–‡æ¡£åŸºäº **å‰åç«¯åˆ†ç¦»æ¶æ„**ï¼Œè¯¦ç»†æŠ€æœ¯è§„èŒƒè¯·å‚è€ƒï¼š

ğŸ‘‰ **[\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md)**

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| å‰ç«¯ | React 18.x + TypeScript + Ant Design |
| åç«¯ | Spring Boot 3.x + Java 17 |
| æ•°æ®åº“ | PostgreSQL 15.x |

### 1.4 æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| è®¢å•è¯¦æƒ…å±•ç¤º | æ˜¾ç¤ºå®Œæ•´è®¢å•ä¿¡æ¯ | P0 |
| æ‰¿è¯ºæ“ä½œ | åˆä½œä¼™ä¼´æ¥å—è®¢å• | P0 |
| æ‹’ç»æ“ä½œ | åˆä½œä¼™ä¼´æ‹’ç»è®¢å• | P0 |
| å¤‡æ³¨è¾“å…¥ | æ·»åŠ å¤„ç†å¤‡æ³¨ | P1 |
| çŠ¶æ€è¿½è¸ª | è·Ÿè¸ªè®¢å•çŠ¶æ€å˜åŒ– | P1 |

### 1.5 é€‚ç”¨èŒƒå›´

- å‰ç«¯å¼€å‘äººå‘˜ï¼ˆè¯¦æƒ…é¡µé¢ç»„ä»¶å®ç°ï¼‰
- åç«¯å¼€å‘äººå‘˜ï¼ˆè®¢å•æ“ä½œAPIå¼€å‘ï¼‰
- æµ‹è¯•å·¥ç¨‹å¸ˆï¼ˆåŠŸèƒ½æµ‹è¯•ï¼‰

---

## 2. APIæ¥å£è®¾è®¡

### 2.1 è·å–è®¢å•è¯¦æƒ…

```typescript
// GET /api/v1/partners/orders/{orderId}
interface GetOrderDetailRequest {
  orderId: string;
}

interface GetOrderDetailResponse {
  success: boolean;
  data: {
    orderId: string;
    orderYearMonth: string;
    baseName: string;
    status: OrderStatus;
    requestDetail: string;
    requestDate: string;
    deadline: string;
    partnerMemo: string;
    createdAt: string;
    updatedAt: string;
  };
  error?: {
    code: string;
    message: string;
  };
}

type OrderStatus =
  | 'PENDING'
  | 'ACCEPTED'
  | 'REJECTED'
  | 'EXPIRED'
  | 'CANCELLED';
```

### 2.2 æ‰¿è¯ºè®¢å•

```typescript
// POST /api/v1/partners/orders/{orderId}/accept
interface AcceptOrderRequest {
  orderId: string;
  memo?: string;
}

interface AcceptOrderResponse {
  success: boolean;
  data: {
    orderId: string;
    status: 'ACCEPTED';
    acceptedAt: string;
  };
  message: string;
  error?: {
    code: string;
    message: string;
  };
}
```

### 2.3 æ‹’ç»è®¢å•

```typescript
// POST /api/v1/partners/orders/{orderId}/reject
interface RejectOrderRequest {
  orderId: string;
  reason: string;
}

interface RejectOrderResponse {
  success: boolean;
  data: {
    orderId: string;
    status: 'REJECTED';
    rejectedAt: string;
  };
  message: string;
  error?: {
    code: string;
    message: string;
  };
}
```

### 2.4 ä¿å­˜å¤‡æ³¨

```typescript
// PUT /api/v1/partners/orders/{orderId}/memo
interface SaveMemoRequest {
  orderId: string;
  memo: string;
}

interface SaveMemoResponse {
  success: boolean;
  data: {
    orderId: string;
    memo: string;
    updatedAt: string;
  };
  message: string;
}
```

### 2.5 è·å–æ“ä½œå†å²

```typescript
// GET /api/v1/partners/orders/{orderId}/history
interface GetOrderHistoryResponse {
  success: boolean;
  data: {
    historyId: string;
    orderId: string;
    action: OrderAction;
    performedBy: string;
    performedAt: string;
    memo?: string;
  }[];
}
```

### 2.6 APIé”™è¯¯å“åº”

```typescript
interface ApiErrorResponse {
  success: false;
  error: {
    code: ErrorCode;
    message: string;
    details?: Record<string, unknown>;
  };
}

type ErrorCode =
  | 'ORDER_NOT_FOUND'
  | 'ORDER_ALREADY_PROCESSED'
  | 'ORDER_EXPIRED'
  | 'PERMISSION_DENIED'
  | 'INVALID_REQUEST'
  | 'INTERNAL_ERROR';
```

---

## 3. å‰ç«¯ç»„ä»¶è®¾è®¡

### 3.1 é¡µé¢ç»„ä»¶ç»“æ„

```
p3-OrderDetail/
â”œâ”€â”€ index.tsx                    # ä¸»é¡µé¢ç»„ä»¶
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ OrderHeader.tsx         # è®¢å•å¤´éƒ¨ï¼ˆIDã€çŠ¶æ€ï¼‰
â”‚   â”œâ”€â”€ OrderInfoCard.tsx       # è®¢å•ä¿¡æ¯å¡ç‰‡
â”‚   â”œâ”€â”€ RequestDetailSection.tsx # å§”æ‰˜è¯¦æƒ…åŒºåŸŸ
â”‚   â”œâ”€â”€ PartnerMemoSection.tsx  # åˆä½œä¼™ä¼´å¤‡æ³¨
â”‚   â”œâ”€â”€ ActionButtons.tsx       # æ“ä½œæŒ‰é’®ç»„
â”‚   â”œâ”€â”€ AcceptModal.tsx         # æ‰¿è¯ºç¡®è®¤å¼¹çª—
â”‚   â”œâ”€â”€ RejectModal.tsx         # æ‹’ç»ç¡®è®¤å¼¹çª—
â”‚   â””â”€â”€ StatusTag.tsx           # çŠ¶æ€æ ‡ç­¾ç»„ä»¶
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useOrderDetail.ts       # è®¢å•è¯¦æƒ…Hook
â”‚   â”œâ”€â”€ useOrderActions.ts      # è®¢å•æ“ä½œHook
â”‚   â””â”€â”€ useOrderStatus.ts       # è®¢å•çŠ¶æ€Hook
â”œâ”€â”€ types/
â”‚   â””â”€â”€ order.ts               # è®¢å•ç›¸å…³ç±»å‹å®šä¹‰
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ orderFormatter.ts       # è®¢å•æ•°æ®æ ¼å¼åŒ–
â”‚   â””â”€â”€ validation.ts          # è¡¨å•éªŒè¯
â””â”€â”€ styles/
    â””â”€â”€ OrderDetail.module.css
```

### 3.2 ä¸»é¡µé¢ç»„ä»¶

```tsx
// index.tsx
import React, { useEffect, useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Spin, message } from 'antd';
import { OrderHeader } from './components/OrderHeader';
import { OrderInfoCard } from './components/OrderInfoCard';
import { RequestDetailSection } from './components/RequestDetailSection';
import { PartnerMemoSection } from './components/PartnerMemoSection';
import { ActionButtons } from './components/ActionButtons';
import { useOrderDetail } from './hooks/useOrderDetail';
import styles from './styles/OrderDetail.module.css';

export const OrderDetailPage: React.FC = () => {
  const { orderId } = useParams<{ orderId: string }>();
  const navigate = useNavigate();
  const { order, loading, error, refresh } = useOrderDetail(orderId);
  const [messageApi, contextHolder] = message.useMessage();

  const handleAccept = async () => {
    try {
      await acceptOrder(orderId!);
      messageApi.success('æ³¨æ–‡ã‚’æ‰¿è«¾ã—ã¾ã—ãŸ');
      refresh();
    } catch (err) {
      messageApi.error(err.message);
    }
  };

  const handleReject = async (reason: string) => {
    try {
      await rejectOrder(orderId!, reason);
      messageApi.success('æ³¨æ–‡ã‚’å´ä¸‹ã—ã¾ã—ãŸ');
      refresh();
    } catch (err) {
      messageApi.error(err.message);
    }
  };

  const handleMemoChange = async (memo: string) => {
    try {
      await saveMemo(orderId!, memo);
    } catch (err) {
      messageApi.error(err.message);
    }
  };

  const handleBack = () => {
    navigate('/p2');
  };

  if (loading) {
    return <Spin size="large" className={styles.loading} />;
  }

  if (error || !order) {
    return <div className={styles.error}>{error?.message}</div>;
  }

  return (
    <div className={styles.container}>
      {contextHolder}
      <OrderHeader
        orderId={order.orderId}
        status={order.status}
        onBack={handleBack}
      />
      <OrderInfoCard
        yearMonth={order.orderYearMonth}
        baseName={order.baseName}
        status={order.status}
      />
      <RequestDetailSection
        requestDetail={order.requestDetail}
        requestDate={order.requestDate}
        deadline={order.deadline}
      />
      <PartnerMemoSection
        memo={order.partnerMemo}
        onMemoChange={handleMemoChange}
        disabled={order.status !== 'PENDING'}
      />
      <ActionButtons
        status={order.status}
        onAccept={handleAccept}
        onReject={handleReject}
        disabled={order.status !== 'PENDING'}
      />
    </div>
  );
};
```

### 3.3 æ“ä½œæŒ‰é’®ç»„ä»¶

```tsx
// ActionButtons.tsx
import React from 'react';
import { Button, Space, Tooltip } from 'antd';
import { CheckCircleOutlined, CloseCircleOutlined } from '@ant-design/icons';
import { OrderStatus } from '../../types/order';
import styles from './ActionButtons.module.css';

interface ActionButtonsProps {
  status: OrderStatus;
  onAccept: () => void;
  onReject: (reason: string) => void;
  disabled?: boolean;
}

export const ActionButtons: React.FC<ActionButtonsProps> = ({
  status,
  onAccept,
  onReject,
  disabled,
}) => {
  const isPending = status === 'PENDING';
  const canOperate = isPending && !disabled;

  const handleRejectClick = () => {
    Modal.confirm({
      title: 'æ³¨æ–‡ã‚’å´ä¸‹ã—ã¾ã™',
      content: (
        <div>
          <p>å´ä¸‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå¿…é ˆï¼‰</p>
          <Input.TextArea
            id="reject-reason"
            maxLength={500}
            rows={3}
            placeholder="å´ä¸‹ç†ç”±ã‚’å…¥åŠ›..."
          />
        </div>
      ),
      onOk: () => {
        const reason = document.getElementById('reject-reason')?.value;
        if (!reason?.trim()) {
          message.warning('å´ä¸‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return Promise.reject();
        }
        onReject(reason);
      },
      okText: 'å´ä¸‹ã™ã‚‹',
      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    });
  };

  return (
    <div className={styles.actions}>
      <Space>
        <Tooltip title={!canOperate ? 'ã“ã®æ³¨æ–‡ã¯æ“ä½œã§ãã¾ã›ã‚“' : ''}>
          <Button
            type="primary"
            icon={<CheckCircleOutlined />}
            onClick={() => {
              Modal.confirm({
                title: 'æ³¨æ–‡ã‚’æ‰¿è«¾ã—ã¾ã™',
                content: 'ã“ã®æ³¨æ–‡ã‚’å—æ³¨ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
                onOk: onAccept,
                okText: 'æ‰¿è«¾ã™ã‚‹',
                cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
              });
            }}
            disabled={!canOperate}
            className={styles.acceptButton}
          >
            æ‰¿è«¾
          </Button>
        </Tooltip>
        <Tooltip title={!canOperate ? 'ã“ã®æ³¨æ–‡ã¯æ“ä½œã§ãã¾ã›ã‚“' : ''}>
          <Button
            icon={<CloseCircleOutlined />}
            onClick={handleRejectClick}
            disabled={!canOperate}
            danger
            className={styles.rejectButton}
          >
            å´ä¸‹
          </Button>
        </Tooltip>
      </Space>
      {status === 'ACCEPTED' && (
        <span className={styles.statusLabel}>æ‰¿è«¾æ¸ˆã¿</span>
      )}
      {status === 'REJECTED' && (
        <span className={styles.statusLabelRejected}>å´ä¸‹æ¸ˆã¿</span>
      )}
    </div>
  );
};
```

### 3.4 è®¢å•è¯¦æƒ…Hook

```typescript
// hooks/useOrderDetail.ts
import { useState, useEffect, useCallback } from 'react';
import { OrderDetail, OrderStatus } from '../types/order';
import { getOrderDetail, acceptOrder, rejectOrder, saveMemo } from '../api/order';

interface UseOrderDetailReturn {
  order: OrderDetail | null;
  loading: boolean;
  error: Error | null;
  refresh: () => Promise<void>;
  accept: (memo?: string) => Promise<void>;
  reject: (reason: string) => Promise<void>;
  updateMemo: (memo: string) => Promise<void>;
}

export const useOrderDetail = (
  orderId: string | undefined
): UseOrderDetailReturn => {
  const [order, setOrder] = useState<OrderDetail | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<Error | null>(null);

  const fetchOrder = useCallback(async () => {
    if (!orderId) return;
    setLoading(true);
    try {
      const response = await getOrderDetail(orderId);
      if (response.success) {
        setOrder(response.data);
        setError(null);
      } else {
        setError(new Error(response.error?.message));
      }
    } catch (err) {
      setError(err as Error);
    } finally {
      setLoading(false);
    }
  }, [orderId]);

  useEffect(() => {
    fetchOrder();
  }, [fetchOrder]);

  const accept = useCallback(async (memo?: string) => {
    const response = await acceptOrder(orderId!, memo);
    if (response.success) {
      setOrder((prev) =>
        prev ? { ...prev, status: 'ACCEPTED' as OrderStatus } : null
      );
    } else {
      throw new Error(response.error?.message);
    }
  }, [orderId]);

  const reject = useCallback(async (reason: string) => {
    const response = await rejectOrder(orderId!, reason);
    if (response.success) {
      setOrder((prev) =>
        prev ? { ...prev, status: 'REJECTED' as OrderStatus } : null
      );
    } else {
      throw new Error(response.error?.message);
    }
  }, [orderId]);

  const updateMemo = useCallback(async (memo: string) => {
    const response = await saveMemo(orderId!, memo);
    if (response.success) {
      setOrder((prev) => (prev ? { ...prev, memo } : null));
    } else {
      throw new Error(response.error?.message);
    }
  }, [orderId]);

  return {
    order,
    loading,
    error,
    refresh: fetchOrder,
    accept,
    reject,
    updateMemo,
  };
};
```

---

## 4. åç«¯æœåŠ¡è®¾è®¡

### 4.1 Controller

```java
@RestController
@RequestMapping("/api/v1/partners/orders")
@RequiredArgsConstructor
public class PartnerOrderController {

    private final PartnerOrderService partnerOrderService;

    @GetMapping("/{orderId}")
    public ResponseEntity<GetOrderDetailResponse> getOrderDetail(
            @PathVariable String orderId,
            @AuthenticationPrincipal User user) {
        GetOrderDetailResponse response = partnerOrderService.getOrderDetail(
            orderId, user.getPartnerId());
        return ResponseEntity.ok(response);
    }

    @PostMapping("/{orderId}/accept")
    public ResponseEntity<AcceptOrderResponse> acceptOrder(
            @PathVariable String orderId,
            @RequestBody(required = false) AcceptOrderRequest request,
            @AuthenticationPrincipal User user) {
        AcceptOrderResponse response = partnerOrderService.acceptOrder(
            orderId, user.getPartnerId(), request.getMemo());
        return ResponseEntity.ok(response);
    }

    @PostMapping("/{orderId}/reject")
    public ResponseEntity<RejectOrderResponse> rejectOrder(
            @PathVariable String orderId,
            @RequestBody RejectOrderRequest request,
            @AuthenticationPrincipal User user) {
        RejectOrderResponse response = partnerOrderService.rejectOrder(
            orderId, user.getPartnerId(), request.getReason());
        return ResponseEntity.ok(response);
    }

    @PutMapping("/{orderId}/memo")
    public ResponseEntity<SaveMemoResponse> saveMemo(
            @PathVariable String orderId,
            @RequestBody SaveMemoRequest request,
            @AuthenticationPrincipal User user) {
        SaveMemoResponse response = partnerOrderService.saveMemo(
            orderId, user.getPartnerId(), request.getMemo());
        return ResponseEntity.ok(response);
    }

    @GetMapping("/{orderId}/history")
    public ResponseEntity<GetOrderHistoryResponse> getOrderHistory(
            @PathVariable String orderId,
            @AuthenticationPrincipal User user) {
        GetOrderHistoryResponse response = partnerOrderService.getOrderHistory(
            orderId, user.getPartnerId());
        return ResponseEntity.ok(response);
    }
}
```

### 4.2 Service

```java
@Service
@RequiredArgsConstructor
public class PartnerOrderService {

    private final OrderRepository orderRepository;
    private final OrderActionRepository orderActionRepository;

    @Transactional
    public GetOrderDetailResponse getOrderDetail(String orderId, String partnerId) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException(orderId));

        if (!order.getPartnerId().equals(partnerId)) {
            throw new PermissionDeniedException();
        }

        return GetOrderDetailResponse.builder()
            .success(true)
            .data(OrderDetailDTO.from(order))
            .build();
    }

    @Transactional
    public AcceptOrderResponse acceptOrder(String orderId, String partnerId, String memo) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException(orderId));

        validateOrderForAction(order, partnerId);

        order.setStatus(OrderStatus.ACCEPTED);
        orderRepository.save(order);

        OrderAction action = OrderAction.builder()
            .orderId(orderId)
            .actionType(ActionType.ACCEPTED)
            .performedBy(partnerId)
            .memo(memo)
            .build();
        orderActionRepository.save(action);

        return AcceptOrderResponse.builder()
            .success(true)
            .message("æ³¨æ–‡ã‚’æ‰¿è«¾ã—ã¾ã—ãŸ")
            .data(AcceptOrderResultDTO.builder()
                .orderId(orderId)
                .status(OrderStatus.ACCEPTED)
                .acceptedAt(LocalDateTime.now())
                .build())
            .build();
    }

    @Transactional
    public RejectOrderResponse rejectOrder(String orderId, String partnerId, String reason) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException(orderId));

        validateOrderForAction(order, partnerId);

        if (StringUtils.isBlank(reason)) {
            throw new ValidationException("å´ä¸‹ç†ç”±ã¯å¿…é ˆã§ã™");
        }

        order.setStatus(OrderStatus.REJECTED);
        orderRepository.save(order);

        OrderAction action = OrderAction.builder()
            .orderId(orderId)
            .actionType(ActionType.REJECTED)
            .performedBy(partnerId)
            .memo(reason)
            .build();
        orderActionRepository.save(action);

        return RejectOrderResponse.builder()
            .success(true)
            .message("æ³¨æ–‡ã‚’å´ä¸‹ã—ã¾ã—ãŸ")
            .data(RejectOrderResultDTO.builder()
                .orderId(orderId)
                .status(OrderStatus.REJECTED)
                .rejectedAt(LocalDateTime.now())
                .build())
            .build();
    }

    private void validateOrderForAction(Order order, String partnerId) {
        if (!order.getPartnerId().equals(partnerId)) {
            throw new PermissionDeniedException();
        }

        if (order.getStatus() != OrderStatus.PENDING) {
            throw new OrderAlreadyProcessedException(order.getStatus().name());
        }

        if (order.getDeadline().isBefore(LocalDateTime.now())) {
            throw new OrderExpiredException();
        }
    }
}
```

---

## 5. æ•°æ®åº“è¡¨è®¾è®¡

### 5.1 orders è¡¨ï¼ˆæ‰©å±•å­—æ®µï¼‰

```sql
ALTER TABLE orders ADD COLUMN partner_id VARCHAR(50) NOT NULL;
ALTER TABLE orders ADD COLUMN partner_memo VARCHAR(1000);
ALTER TABLE orders ADD COLUMN deadline DATETIME NOT NULL;

CREATE INDEX idx_orders_partner_status ON orders(partner_id, status);
CREATE INDEX idx_orders_partner_deadline ON orders(partner_id, deadline);
```

### 5.2 order_actions è¡¨

```sql
CREATE TABLE order_actions (
    action_id VARCHAR(50) PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    action_type ENUM('PENDING', 'ACCEPTED', 'REJECTED', 'EXPIRED', 'CANCELLED') NOT NULL,
    performed_by VARCHAR(50) NOT NULL,
    memo TEXT,
    action_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_actions_order (order_id),
    INDEX idx_actions_performer (performed_by)
);
```

### 5.3 order_status_history è¡¨

```sql
CREATE TABLE order_status_history (
    history_id VARCHAR(50) PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL,
    previous_status VARCHAR(20),
    new_status VARCHAR(20) NOT NULL,
    changed_by VARCHAR(50) NOT NULL,
    change_reason TEXT,
    changed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    INDEX idx_history_order (order_id)
);
```

---

## 6. éªŒè¯è§„åˆ™

### 6.1 å‰ç«¯éªŒè¯

```typescript
// validation.ts
import { Validate } from 'react-hook-form';

export const validateOrderId: Validate = (value: string) => {
  if (!value) return 'æ³¨æ–‡IDã¯å¿…é ˆã§ã™';
  if (value.length > 50) return 'æ³¨æ–‡IDã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
  return true;
};

export const validateMemo: Validate = (value: string) => {
  if (value && value.length > 1000) {
    return 'å‚™è€ƒã¯1000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
  }
  return true;
};

export const validateRejectReason: Validate = (value: string) => {
  if (!value) return 'å´ä¸‹ç†ç”±ã¯å¿…é ˆã§ã™';
  if (value.length > 500) return 'å´ä¸‹ç†ç”±ã¯500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
  if (value.trim().length < 5) return 'å´ä¸‹ç†ç”±ã¯5æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
  return true;
};
```

### 6.2 åç«¯éªŒè¯

```java
@Validated
public class OrderActionRequest {

    @NotBlank(message = "æ³¨æ–‡IDã¯å¿…é ˆã§ã™")
    @Size(max = 50, message = "æ³¨æ–‡IDã¯50æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
    private String orderId;

    @Size(max = 1000, message = "å‚™è€ƒã¯1000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
    private String memo;
}

@Validated
public class RejectOrderRequest {

    @NotBlank(message = "å´ä¸‹ç†ç”±ã¯å¿…é ˆã§ã™")
    @Size(min = 5, max = 500, message = "å´ä¸‹ç†ç”±ã¯5æ–‡å­—ä»¥ä¸Š500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
    private String reason;
}
```

---

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 å‰ç«¯ä¼˜åŒ–

```typescript
// ä½¿ç”¨React Queryè¿›è¡Œæ•°æ®ç¼“å­˜å’Œé¢„è·å–
const { data: order } = useQuery({
  queryKey: ['order', orderId],
  queryFn: () => getOrderDetail(orderId),
  staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿå†…æ•°æ®è§†ä¸ºæ–°é²œ
  cacheTime: 30 * 60 * 1000,
});

// è·¯ç”±é¢„åŠ è½½
const router = createBrowserRouter([
  {
    path: '/p3/:orderId',
    element: <OrderDetailPage />,
    loader: async ({ params }) => {
      preLoadOrderData(params.orderId);
      return null;
    },
  },
]);
```

### 7.2 åç«¯ä¼˜åŒ–

```java
@Configuration
@EnableCaching
public class CacheConfig {

    @Bean
    public CacheManager cacheManager() {
        return new RedisCacheManager(redisCacheConfiguration());
    }
}

@Service
public class PartnerOrderService {

    @Cacheable(value = "orderDetails", key = "#orderId")
    public OrderDetailDTO getOrderDetail(String orderId, String partnerId) {
        // æ•°æ®åº“æŸ¥è¯¢
    }
}
```

---

## 8. å®‰å…¨è€ƒè™‘

### 8.1 æƒé™éªŒè¯

```typescript
// å‰ç«¯æƒé™æ£€æŸ¥
const useOrderPermission = (order: OrderDetail | null) => {
  const { user } = useAuth();

  const canAccept = useMemo(() => {
    if (!order) return false;
    return (
      order.status === 'PENDING' &&
      order.partnerId === user.partnerId &&
      new Date(order.deadline) > new Date()
    );
  }, [order, user]);

  const canReject = canAccept;
  const canView = order?.partnerId === user.partnerId;

  return { canAccept, canReject, canView };
};
```

### 8.2 CSRFä¿æŠ¤

```typescript
// å°è£…çš„APIè°ƒç”¨ï¼ˆå¸¦CSRF Tokenï¼‰
const apiClient = axios.create({
  baseURL: '/api/v1',
});

apiClient.interceptors.request.use((config) => {
  const token = getCsrfToken();
  if (token) {
    config.headers['X-CSRF-Token'] = token;
  }
  return config;
});
```

### 8.3 è¯·æ±‚é™æµ

```java
@Configuration
public class RateLimitConfig {

    @Bean
    public RateLimiter orderActionRateLimiter() {
        return RateLimiter.builder()
            .limitForPeriod(10)
            .limitRefreshPeriod(Duration.ofSeconds(60))
            .build();
    }
}

@RestController
@RequestMapping("/api/v1/partners/orders")
public class PartnerOrderController {

    private final RateLimiter orderActionRateLimiter;

    @PostMapping("/{orderId}/accept")
    public ResponseEntity<AcceptOrderResponse> acceptOrder(
            @PathVariable String orderId,
            @RateLimited(rateLimiter = "orderActionRateLimiter") RateLimitResult result) {
        if (result.isBlocked()) {
            throw new TooManyRequestsException();
        }
        // å¤„ç†é€»è¾‘
    }
}
```

---

## 9. é”™è¯¯å¤„ç†

### 9.1 å…¨å±€é”™è¯¯å¤„ç†

```typescript
// errorBoundary.tsx
export class ErrorBoundary extends React.Component<Props, State> {
  static getDerivedStateFromError(error: Error) {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    logError(error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <Result
          status="error"
          title="ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          subTitle={this.state.error?.message}
          extra={[
            <Button key="retry" onClick={() => this.setState({ hasError: false })}>
              å†è©¦è¡Œ
            </Button>,
            <Button key="back" onClick={() => navigate('/p2')}>
              ã«æˆ»ã‚‹
            </Button>,
          ]}
        />
      );
    }
    return this.props.children;
  }
}
```

### 9.2 APIé”™è¯¯å¤„ç†

```typescript
// api.ts
const handleApiError = (error: AxiosError): never => {
  if (error.response?.status === 404) {
    throw new OrderNotFoundError();
  }
  if (error.response?.status === 403) {
    throw new PermissionDeniedError();
  }
  if (error.response?.status === 400) {
    const message = error.response.data?.error?.message;
    throw new OrderValidationError(message);
  }
  if (error.code === 'ECONNABORTED') {
    throw new TimeoutError();
  }
  throw new NetworkError();
};
```

---

## 10. æµ‹è¯•ç”¨ä¾‹

### 10.1 å•å…ƒæµ‹è¯•

```typescript
// useOrderDetail.test.ts
describe('useOrderDetail', () => {
  it('should return order data when order exists', async () => {
    const mockOrder = {
      orderId: 'ORD-001',
      status: 'PENDING',
      partnerId: 'PARTNER-001',
    };
    (getOrderDetail as jest.Mock).mockResolvedValue({
      success: true,
      data: mockOrder,
    });

    const { result } = renderHook(() => useOrderDetail('ORD-001'));

    await waitFor(() => !result.current.loading);

    expect(result.current.order).toEqual(mockOrder);
    expect(result.current.error).toBeNull();
  });

  it('should handle accept action', async () => {
    (acceptOrder as jest.Mock).mockResolvedValue({
      success: true,
      message: 'æ³¨æ–‡ã‚’æ‰¿è«¾ã—ã¾ã—ãŸ',
    });

    await result.current.accept();

    expect(acceptOrder).toHaveBeenCalledWith('ORD-001', undefined);
  });
});
```

### 10.2 é›†æˆæµ‹è¯•

```java
@SpringBootTest
@AutoConfigureMockMvc
class PartnerOrderControllerIntegrationTest {

    @Autowired
    private MockMvc mockMvc;

    @Test
    @WithMockUser(username = "partner1", roles = {"PARTNER"})
    void acceptOrder_Success() throws Exception {
        mockMvc.perform(post("/api/v1/partners/orders/ORD-001/accept")
                .contentType(MediaType.APPLICATION_JSON))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.success").value(true))
            .andExpect(jsonPath("$.data.status").value("ACCEPTED"));
    }

    @Test
    @WithMockUser(username = "partner1", roles = {"PARTNER"})
    void acceptOrder_AlreadyProcessed_BadRequest() throws Exception {
        mockMvc.perform(post("/api/v1/partners/orders/ORD-002/accept")
                .contentType(MediaType.APPLICATION_JSON))
            .andExpect(status().isBadRequest())
            .andExpect(jsonPath("$.error.code").value("ORDER_ALREADY_PROCESSED"));
    }
}
```

---

## 11. éªŒæ”¶æ ‡å‡†

### 11.1 åŠŸèƒ½éªŒæ”¶

| åœºæ™¯ | é¢„æœŸç»“æœ | ä¼˜å…ˆçº§ |
|------|----------|--------|
| åŠ è½½å­˜åœ¨çš„è®¢å• | æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰è®¢å•ä¿¡æ¯ | P0 |
| åŠ è½½ä¸å­˜åœ¨çš„è®¢å• | æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œè¿”å›åˆ—è¡¨ | P0 |
| çŠ¶æ€ä¸ºPENDINGæ—¶ç‚¹å‡»æ‰¿è¯º | ç¡®è®¤åçŠ¶æ€å˜ä¸ºACCEPTED | P0 |
| çŠ¶æ€ä¸ºPENDINGæ—¶ç‚¹å‡»æ‹’ç» | è¾“å…¥ç†ç”±åçŠ¶æ€å˜ä¸ºREJECTED | P0 |
| çŠ¶æ€éPENDINGæ—¶æ“ä½œ | æŒ‰é’®ç¦ç”¨ï¼Œæ˜¾ç¤ºåŸå›  | P0 |
| è¾“å…¥å¤‡æ³¨å¹¶ä¿å­˜ | å¤‡æ³¨æ­£ç¡®ä¿å­˜ | P1 |
| æ¥è¿‘æˆªæ­¢æœŸé™ | æ˜¾ç¤ºè­¦å‘Šæç¤º | P1 |

### 11.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | è¦æ±‚ | æµ‹è¯•æ–¹æ³• |
|------|------|----------|
| é¡µé¢åŠ è½½æ—¶é—´ | < 2ç§’ | Lighthouse |
| APIå“åº”æ—¶é—´ | < 500ms | APIæµ‹è¯• |
| æ“ä½œå“åº”æ—¶é—´ | < 300ms | ç”¨æˆ·æ“ä½œ |

### 11.3 å®‰å…¨éªŒæ”¶

| æ£€æŸ¥é¡¹ | è¦æ±‚ |
|--------|------|
| æƒé™æ£€æŸ¥ | éå½’å±åˆä½œä¼™ä¼´æ— æ³•æ“ä½œ |
| CSRFä¿æŠ¤ | æ‰€æœ‰POSTè¯·æ±‚å¸¦CSRF Token |
| è¾“å…¥éªŒè¯ | åç«¯éªŒè¯æ‰€æœ‰è¾“å…¥ |
| é”™è¯¯ä¿¡æ¯ | ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ |

---

## 12. å˜æ›´æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2026-02-XX| v1.0 | åˆå§‹ç‰ˆæœ¬ | - |

---

## é™„å½•

### A.1 ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ | [\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md) | å‰åç«¯æŠ€æœ¯æ¶æ„è¯¦ç»†è§„èŒƒ |
| b3-ç™ºæ³¨è©³ç´° | [../b3-ç™ºæ³¨è©³ç´°/05_è®¾è®¡è§„èŒƒ.md](../b3-ç™ºæ³¨è©³ç´°/05_è®¾è®¡è§„èŒƒ.md) | Baseä¾§è®¢å•è¯¦æƒ…è®¾è®¡è§„èŒƒ |
| p2-ç™ºæ³¨æ¤œç´¢ | [../p2-ç™ºæ³¨æ¤œç´¢/05_è®¾è®¡è§„èŒƒ.md](../p2-ç™ºæ³¨æ¤œç´¢/05_è®¾è®¡è§„èŒƒ.md) | åˆä½œä¼™ä¼´è®¢å•åˆ—è¡¨è®¾è®¡è§„èŒƒ |

### A.2 ä¸b3-ç™ºæ³¨è©³ç´°å¯¹æ¯”

| ç‰¹æ€§ | b3-ç™ºæ³¨è©³ç´° | p3-ç™ºæ³¨è©³ç´° |
|------|-------------|-------------|
| **ç”¨æˆ·è§’è‰²** | ãƒ™ãƒ¼ã‚¹ï¼ˆæ€»éƒ¨ï¼‰ | è¼¸é€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ï¼ˆåˆä½œä¼™ä¼´ï¼‰ |
| **ä¸»è¦æ“ä½œ** | ç¼–è¾‘ã€é€ä»˜ã€ä»£ç†æ‰¿è¯º | æ‰¿è¯ºã€æ‹’ç»ã€å¤‡æ³¨ |
| **è®¾å¤‡æ”¯æŒ** | PCã®ã¿ | PC/SP |
| **æŒ‡ç¤ºä¹¦ç¼–è¾‘** | è¯¦ç»†ç¼–è¾‘åŠŸèƒ½ | åªè¯»æŸ¥çœ‹ |
| **APIå‰ç¼€** | /api/v1/orders | /api/v1/partners/orders |
| **æ¶ˆæ¯åŠŸèƒ½** | å®Œæ•´æ¶ˆæ¯é¢æ¿ | ç®€åŒ–å¤‡æ³¨åŠŸèƒ½ |

---

**æ–‡æ¡£ç¼–åˆ¶**: -  
**ç¼–åˆ¶æ—¶é—´**: 2026-02-XX 
**é€‚ç”¨èŒƒå›´**: p3-ç™ºæ³¨è©³ç´° åˆä½œä¼™ä¼´è®¢å•è¯¦æƒ…é¡µé¢  
**äº¤å‰å¼•ç”¨**: [\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md)
