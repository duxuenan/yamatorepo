# p3-発注詳細 - 详细分析

## 1. 页面概述

### 1.1 页面定位

p3-発注詳細 是パートナー側（合作伙伴端）的订单详情页面，与b3-発注詳細（ベース側）相对应。パートナー通过此页面查看来自ベース（总部/基地）的订单详细信息，并进行承诺或拒绝操作。

### 1.2 核心功能

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 订单详情展示 | 显示完整订单信息 | P0-必须 |
| 承诺操作 | パートナー接受订单 | P0-必须 |
| 拒绝操作 | パートナー拒绝订单 | P0-必须 |
| 备注输入 | 添加处理备注 | P1-建议 |
| 状态追踪 | 跟踪订单状态变化 | P1-建议 |

### 1.3 与b3的差异

| 特性 | b3-発注詳細 | p3-発注詳細 |
|------|-------------|-------------|
| **用户角色** | ベース（总部） | 輸送パートナー（合作伙伴） |
| **主要操作** | 编辑指示书、送付、代理承诺 | 承诺、拒绝、备注 |
| **设备支持** | PCのみ | PC/SP |
| **指示书编辑** | 详细编辑功能 | 只读查看 |
| **メッセージ** | 消息交流面板 | 简化备注功能 |

---

## 2. 页面结构层次

### 2.1 整体结构

```
輸送パートナーシステム
├── p3-発注詳細（订单详情页）
│   ├── 页面头部
│   │   ├── 返回按钮 ← p2-発注検索
│   │   └── 页面标题
│   ├── 订单基本信息区域
│   │   ├── 受注ID（订单ID）
│   │   ├── 年月（订单年月）
│   │   ├── 依頼ベース（委托基地）
│   │   └── ステータス（状态标签）
│   ├── 订单详细信息区域
│   │   ├── 依頼内容（委托内容详情）
│   │   ├── 依頼日（委托日期）
│   │   └── 受付期限（受理截止日期）
│   ├── 合作伙伴备注区域
│   │   └── パートナー備考（备注输入框）
│   └── 操作按钮区域
│       ├── 承諾按钮
│       └── 却下按钮
```

### 2.2 区域详细说明

#### 区域1：页面头部

| 元素 | 类型 | 说明 |
|------|------|------|
| 返回按钮 | Button | 导航回p2-発注検索页面 |
| 页面标题 | Text | "発注詳細" |

#### 区域2：订单基本信息

| 元素 | 类型 | 数据格式 | 说明 |
|------|------|----------|------|
| 受注ID | Text | 文字列 | 订单唯一标识符 |
| 年月 | Text | YYYY-MM | 订单所属年月 |
| 依頼ベース | Text | 文字列 | 委托基地名称 |
| ステータス | Tag | 枚举 | 订单当前状态 |

#### 区域3：订单详细信息

| 元素 | 类型 | 数据格式 | 说明 |
|------|------|----------|------|
| 依頼内容 | TextArea | テキスト | 委托详细内容描述 |
| 依頼日 | Date | YYYY/MM/DD | 委托发布日期 |
| 受付期限 | DateTime | YYYY/MM/DD HH:mm | 受理截止时间 |

#### 区域4：合作伙伴备注

| 元素 | 类型 | 交互 | 说明 |
|------|------|------|------|
| 備考入力 | Input.TextArea | 手动输入 | 合作伙伴备注信息 |

#### 区域5：操作按钮

| 元素 | 类型 | 颜色 | 说明 |
|------|------|------|------|
| 承諾 | Primary Button | 蓝色 | 接受订单 |
| 却下 | Default Button | 灰色 | 拒绝订单 |

---

## 3. 字段详细分析

### 3.1 字段清单

| 字段标识 | 字段名称 | 数据类型 | 必填 | 最大长度 | 业务规则 |
|----------|----------|----------|------|----------|----------|
| order_id | 受注ID | string | 是 | 50 | 订单唯一标识 |
| order_year_month | 年月 | string | 是 | 7 | YYYY-MM格式 |
| base_name | 依頼ベース | string | 是 | 200 | 委托基地名称 |
| status | ステータス | enum | 是 | 20 | 订单当前状态 |
| request_detail | 依頼内容 | text | 是 | 4000 | 委托详细描述 |
| request_date | 依頼日 | date | 是 | 10 | 委托发布日期 |
| deadline | 受付期限 | datetime | 是 | 16 | 受理截止时间 |
| partner_memo | パートナー備考 | string | 否 | 1000 | 合作伙伴备注 |

### 3.2 状态枚举值

| 状态值 | 显示名称 | 颜色 | 说明 |
|--------|----------|------|------|
| PENDING | 受付済 | 橙色 | 待合作伙伴确认 |
| ACCEPTED | 承諾済 | 绿色 | 合作伙伴已接受 |
| REJECTED | 却下 | 红色 | 合作伙伴已拒绝 |
| EXPIRED | 期限切れ | 灰色 | 超过受理期限 |
| CANCELLED | キャンセル | 灰色 | 订单已取消 |

### 3.3 字段验证规则

| 字段 | 验证规则 | 错误提示 |
|------|----------|----------|
| パートナー備考 | 最大1000字符 | "備考は1000文字以内で入力してください" |
| 承諾操作 | 状态必须为PENDING | "この注文はすでに処理済みです" |
| 却下操作 | 状态必须为PENDING | "この注文はすでに処理済みです" |
| 受付期限 | 不能早于当前时间（展示时） | - |

---

## 4. 交互流程详细说明

### 4.1 页面加载流程

```
┌─────────────────────────────────────────────────────────────┐
│  页面加载流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 用户从p2-発注検索点击订单                                  │
│     ↓                                                        │
│  2. 获取订单ID参数                                            │
│     ↓                                                        │
│  3. 调用API获取订单详情                                        │
│     GET /api/v1/partners/orders/{orderId}                     │
│     ↓                                                        │
│  4. 显示加载状态（骨架屏）                                      │
│     ↓                                                        │
│  5. API返回数据                                               │
│     ↓                                                        │
│  6. 渲染订单基本信息                                           │
│     ↓                                                        │
│  7. 渲染订单详细信息                                           │
│     ↓                                                        │
│  8. 渲染备注输入区域                                           │
│     ↓                                                        │
│  9. 渲染操作按钮（根据状态判断是否可用）                         │
│     ↓                                                        │
│  10. 页面加载完成                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 承诺操作流程

```
┌─────────────────────────────────────────────────────────────┐
│  承诺操作流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 用户点击「承諾」按钮                                       │
│     ↓                                                        │
│  2. 显示确认对话框                                            │
│     标题：「注文を承諾します宜しいですか？」                    │
│     内容：「この注文を受注します。よろしいですか？」             │
│     ↓                                                        │
│  3. 用户确认                                                  │
│     ↓                                                        │
│  4. 显示二次确认（可选，敏感操作）                              │
│     ↓                                                        │
│  5. 调用承诺API                                               │
│     POST /api/v1/partners/orders/{orderId}/accept              │
│     Body: { memo: string }                                   │
│     ↓                                                        │
│  6. 显示加载状态                                              │
│     ↓                                                        │
│  7. API处理成功                                               │
│     ↓                                                        │
│  8. 显示成功提示                                              │
│     Toast: "注文を承諾しました"                               │
│     ↓                                                        │
│  9. 更新本地状态                                              │
│     ↓                                                        │
│  10. 返回p2-発注検索页面                                      │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 拒绝操作流程

```
┌─────────────────────────────────────────────────────────────┐
│  拒绝操作流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 用户点击「却下」按钮                                       │
│     ↓                                                        │
│  2. 显示拒绝原因输入对话框                                     │
│     标题：「注文を却下します」                                  │
│     字段：却下理由（必填，最大500字符）                          │
│     ↓                                                        │
│  3. 用户输入拒绝理由并确认                                     │
│     ↓                                                        │
│  4. 调用拒绝API                                               │
│     POST /api/v1/partners/orders/{orderId}/reject             │
│     Body: { reason: string }                                  │
│     ↓                                                        │
│  5. 显示加载状态                                              │
│     ↓                                                        │
│  6. API处理成功                                               │
│     ↓                                                        │
│  7. 显示成功提示                                              │
│     Toast: "注文を却下しました"                                │
│     ↓                                                        │
│  8. 更新本地状态                                              │
│     ↓                                                        │
│  9. 返回p2-発注検索页面                                       │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 备注保存流程

```
┌─────────────────────────────────────────────────────────────┐
│  备注保存流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 用户在备注输入框输入内容                                   │
│     ↓                                                        │
│  2. 检测输入变化                                              │
│     ↓                                                        │
│  3. 自动保存或手动保存                                        │
│     ↓                                                        │
│  4. 调用保存API（可选，实时保存）                               │
│     PUT /api/v1/partners/orders/{orderId}/memo                │
│     Body: { memo: string }                                    │
│     ↓                                                        │
│  5. 显示保存状态                                              │
│     ↓                                                        │
│  6. 保存成功                                                  │
│     ↓                                                        │
│  7. 清除保存状态提示                                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 状态流转说明

### 5.1 订单状态流转图

```
                    ┌─────────────────┐
                    │    PENDING      │  ← 初始状态（受付済）
                    │   （受付済）     │
                    └────────┬────────┘
                             │
              ┌──────────────┴──────────────┐
              │                             │
              ↓                             ↓
    ┌─────────────────┐           ┌─────────────────┐
    │   ACCEPTED      │           │   REJECTED      │
    │  （承諾済）      │           │   （却下）       │
    └────────┬────────┘           └─────────────────┘
             │
             │ （特殊情况下可回滚）
             ↓
    ┌─────────────────┐
    │   CANCELLED     │
    │ （キャンセル）   │
    └─────────────────┘

    ┌─────────────────┐
    │    EXPIRED      │  ← 超过受付期限自动变更
    │  （期限切れ）    │
    └─────────────────┘
```

### 5.2 状态流转规则

| 当前状态 | 允许操作 | 目标状态 | 触发条件 |
|----------|----------|----------|----------|
| PENDING | 承諾 | ACCEPTED | 合作伙伴点击承诺按钮 |
| PENDING | 却下 | REJECTED | 合作伙伴点击拒绝按钮 |
| PENDING | - | EXPIRY | 超过受付期限 |
| ACCEPTED | 取消 | CANCELLED | 合作伙伴或管理员取消 |
| REJECTED | - | - | 终止状态 |
| EXPIRY | - | - | 终止状态 |

---

## 6. 业务规则

### 6.1 受理期限规则

- 受付期限由ベース在创建订单时设定
- 超过受付期限后，合作伙伴无法进行承诺或拒绝操作
- 建议在接近期限时显示警告提示（提前24小时）
- 过期订单状态自动变更为「期限切れ」

### 6.2 操作权限规则

- 仅限当前合作伙伴（订单归属者）可操作
- 状态为PENDING时，承诺和拒绝按钮可用
- 状态为非PENDING时，按钮禁用并显示原因
- 需要二次确认防止误操作

### 6.3 备注规则

- 备注为可选输入
- 最大长度1000字符
- 拒绝操作时，拒绝理由为必填
- 备注保存后，ベース可查看

---

## 7. 异常处理

### 7.1 异常场景

| 场景 | 处理方式 | 用户提示 |
|------|----------|----------|
| 订单不存在 | 返回404，提示返回列表 | "注文が見つかりません" |
| 无操作权限 | 返回403，禁用按钮 | "この注文を操作する権限がありません" |
| 订单已被处理 | 返回400，提示状态 | "この注文はすでに処理済みです" |
| 超过期限 | 返回400，禁用按钮 | "受付期限切れのため、操作できません" |
| 网络错误 | 重试机制 | "ネットワークエラーが発生しました" |
| 服务器错误 | 提示稍后重试 | "サーバーエラーが発生しました" |

### 7.2 错误代码

| 错误码 | 说明 | 处理 |
|--------|------|------|
| ORDER_NOT_FOUND | 订单不存在 | 返回p2页面 |
| ORDER_ALREADY_PROCESSED | 订单已处理 | 刷新页面数据 |
| ORDER_EXPIRED | 订单已过期 | 显示过期提示 |
| PERMISSION_DENIED | 无权限 | 提示权限问题 |
| INVALID_REQUEST | 请求参数错误 | 校验输入 |

---

## 8. 性能要求

| 指标 | 要求 | 说明 |
|------|------|------|
| 页面加载时间 | < 2秒 | 首屏渲染完成 |
| API响应时间 | < 500ms | 详情数据获取 |
| 按钮点击响应 | < 200ms | 操作反馈 |
| 列表滚动流畅 | 60fps | 无卡顿 |

---

## 9. 兼容性要求

### 9.1 响应式设计

| 断点 | 布局 | 说明 |
|------|------|------|
| PC (≥1024px) | 双栏布局 | 左侧详情，右侧操作 |
| 平板 (768-1023px) | 单栏布局 | 垂直滚动 |
| 手机 (<768px) | 单栏紧凑 | 优化触摸操作 |

### 9.2 浏览器支持

| 浏览器 | 最低版本 | 说明 |
|--------|----------|------|
| Chrome | 90 | 推荐 |
| Firefox | 88 | 支持 |
| Safari | 14 | 支持 |
| Edge | 90 | 支持 |

---

**文档编制**: -  
**编制时间**: 2026-02-XX 
**适用范围**: p3-発注詳細 合作伙伴订单详情页面
