# b8-CSVアップロード - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b8-CSVアップロード |
| **界面编号** | b8 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b8-CSVアップロード 是BOSS系统CSV上传页面，提供月間運行計画表和日別傭車費一覧的CSV文件上传、校验和导入功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- CSVファイルアップロード
- ファイルチェック
- データチェック
- パートナーに反映
- 一斉メール送信

### 1.5 适用范围
- 前端开发人员（上传组件实现）
- 后端开发人员（CSV处理API）
- 测试工程师（上传功能测试）

---

## 2. 页面元素

### 2.1 上传方式
b8-CSVアップロード 支持两种上传方式，由ベースごとの設定决定：

| 方式 | 说明 | 対象 |
|------|------|------|
| **全件单位** | あらかじめベースごとに定められた単位に従って、一括で全パートナーに上传 | ベースの全パートナー |
| **個別单位** | 個別パートナーごとにファイルを上传 | 個別パートナー |

### 2.2 上传方式在画面上的体现
| 场景 | 画面行为 |
|------|----------|
| 全件单位 | 選択した年月の全パートナーに対して一括上传画面を表示 |
| 個別単位 | 個別パートナーごとにアップロードするファイルを選択する画面を表示 |

**注意**: システムが自動的にベースの設定を読み取り、適切な上传方法を適用する。

### 2.3 Tabs组件

| Tab名 | 内容 | 上传文件 |
|-------|------|----------|
| 発注（前月25日～26日） | 发注阶段 | 月間運行計画表 |
| 実績確認（当月中） | 业绩确认 | 日別傭車費一覧 |
| 発注＆実績確認（〆後） | 最终确认 | 双方 |

### 2.2 通用元素

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | 年月選択 | プルダウン | 年月选择 | 选择触发 |
| ⑵ | アップロードする書類 | 表示項目 | 显示上传文件类型 | - |
| ⑶ | アップロード済ファイル名 | 表示項目 | 文件名+日時 | - |
| ⑷ | ファイルアップロード | ボタン | 上传文件 | 点击→选择 |
| ⑸ | ファイルチェック結果 | 表示項目 | 文件检查结果 | - |
| ⑹ | データチェック結果 | 表示項目 | 数据检查结果 | - |
| ⑺ | パートナーに反映 | ボタン | 确认导入 | 点击→导入 |
| ⑻ | 一斉メール送信 | ボタン | 发送邮件 | 点击→发送 |

---

## 3. 交互流程

### 3.1 上传流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 选择Tab | 切换上传内容 |
| 2 | 选择年月 | 设定上传期间 |
| 3 | 点击上传按钮 | 打开文件选择 |
| 4 | 选择CSV文件 | 执行上传 |
| 5 | 文件检查 | 显示检查结果 |

### 3.2 校验流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 显示检查结果 | 必須項目/項目数/文字コード |
| 2 | 数据检查 | 差分比較 |
| 3 | 确认/取消 | 继续或取消 |

### 3.3 反映流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 点击反映按钮 | 执行数据导入 |
| 2 | ver.up | 版本号递增 |
| 3 | 邮件发送 | 发送通知邮件 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | Tabs+表单 | - | 多Tab布局 |

### 4.2 状态颜色
| 状态 | 颜色 | 说明 |
|------|------|------|
| チェックOK | 绿色 | 检查通过 |
| チェックNG | 红色 | 检查失败 |
| アップロード済 | 蓝色 | 已上传 |
| 反映済 | 绿色 | 已反映 |

### 4.3 按钮状态
| 状态 | 活性化条件 |
|------|------------|
| アップロード | 常に活性 |
| 再アップロード | アップロード済 |
| パートナーに反映 | チェックOK |
| 一斉メール送信 | 反映済 |

---

## 5. API接口设计

### 5.1 上传API
```yaml
# CSV文件上传
POST /api/v1/csv/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data

# Request
- year_month: string (YYYY-MM)
- tab_type: string (order/completed-order/both)
- file: File

# Response
{
  "status": "success",
  "file_id": "xxx",
  "file_check": {
    "required_blank": "OK",
    "column_count": "OK",
    "encoding": "OK"
  }
}
```

### 5.2 数据校验API
```yaml
# 数据校验
POST /api/v1/csv/validate
Authorization: Bearer {token}

# Response
{
  "data_check": {
    "differences": [...],
    "action_required": true
  }
}
```

### 5.3 反映API
```yaml
# 确认导入
POST /api/v1/csv/import
Authorization: Bearer {token}

# Response
{
  "status": "success",
  "version": "n+1",
  "imported_count": 100
}
```

### 5.4 邮件发送API
```yaml
# 一斉メール送信
POST /api/v1/csv/send-notifications
Authorization: Bearer {token}
```

### 5.5 画面-API-数据库关系映射

#### 5.5.1 关系总览表

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|-------------|-------------|----------|
| **页面加载** | | | | |
| 页面初始化 | GET /api/v1/csv/upload/{tabType}/{yearMonth} | 获取上传状态 | t_csv_upload | year_month, tab_type, upload_status, uploaded_file_id, uploaded_datetime |
| | | | m_base_config | base_id → upload_unit (全件/個別) |
| **Tabs选择** | | | | |
| Tab切换 | GET /api/v1/csv/upload/{tabType}/{yearMonth} | 切换Tab内容 | t_csv_upload | tab_type, upload_status |
| **年月选择区** | | | | |
| ⑴ 年月選択 | GET /api/v1/csv/upload/{tabType}/{yearMonth} | 获取指定年月状态 | t_csv_upload | year_month (YYYY-MM) |
| | | | t_csv_upload_history | year_month → history records |
| **上传状态区** | | | | |
| ⑵ アップロードする書類 | GET /api/v1/csv/upload/{tabType}/{yearMonth} | 显示上传文件类型 | t_csv_upload | tab_type → file_type |
| ⑶ アップロード済ファイル名 | GET /api/v1/csv/upload/{tabType}/{yearMonth} | 显示已上传文件名 | t_csv_upload | uploaded_file_name, uploaded_datetime |
| | | | t_csv_file | file_id → file_name, file_path |
| **文件上传区** | | | | |
| ⑷ ファイルアップロード | POST /api/v1/csv/upload | 上传CSV文件 | t_csv_file | 插入文件记录 (file_name, file_path, file_size, uploaded_by) |
| | | | t_csv_upload | 更新上传状态 |
| | | | t_csv_upload_action_log | 插入上传记录 |
| 再アップロード | POST /api/v1/csv/upload/{uploadId}/reupload | 重新上传 | t_csv_file | 插入新文件记录 |
| | | | t_csv_upload | 更新 uploaded_file_id |
| | | | t_csv_upload_action_log | 插入再上传记录 |
| **ファイルチェック結果区** | | | | |
| ⑸ ファイルチェック結果 | POST /api/v1/csv/{uploadId}/validate | 文件格式校验 | t_csv_file | file_id → t_csv_upload |
| | ファイルチェックOK | GET /api/v1/csv/{uploadId}/validate | 必須項目チェック | t_csv_upload | status → "FILE_CHECK_OK" |
| | | | t_csv_validation_result | validation_id, upload_id, validation_type="FILE_CHECK", check_item, check_result, is_passed |
| | ファイルチェックNG | GET /api/v1/csv/{uploadId}/validate | 显示NG详情 | t_csv_validation_result | validation_type="FILE_CHECK", check_item, error_detail |
| 必須項目ブランク | GET /api/v1/csv/{uploadId}/validate | 检查必填项 | t_csv_upload | status |
| | | | t_csv_validation_result | check_item="REQUIRED_FIELD", is_passed |
| 項目数 | GET /api/v1/csv/{uploadId}/validate | 检查列数 | t_csv_validation_result | check_item="COLUMN_COUNT", is_passed |
| 文字コード | GET /api/v1/csv/{uploadId}/validate | 检查编码 | t_csv_validation_result | check_item="ENCODING", is_passed |
| **データチェック結果区** | | | | |
| ⑹ データチェック結果 | POST /api/v1/csv/{uploadId}/data-validate | 数据内容校验 | t_csv_data_diff | diff_id, upload_id, data_type, missing_data_count, extra_data_count |
| 差分チェック | GET /api/v1/csv/{uploadId}/data-diff | 获取差异数据 | t_csv_data_diff | upload_id, data_type, data_code, data_name, exists_in_csv, exists_in_system |
| 残すデータ選択 | POST /api/v1/csv/{uploadId}/data-diff/confirm | 确认保留数据 | t_csv_data_diff | update keep_status, confirmed_by, confirmed_datetime |
| キャンセル | POST /api/v1/csv/{uploadId}/cancel | 取消上传 | t_csv_upload | status → "CANCELLED" |
| | | | t_csv_upload_action_log | 插入取消记录 |
| **パートナーに反映区** | | | | |
| ⑺ パートナーに反映 | POST /api/v1/csv/{uploadId}/import | 数据导入系统 | t_csv_upload | status → "IMPORTED", imported_datetime |
| | | | t_csv_upload | version → version + 1 |
| | | | t_instruction | 批量更新/插入 instruction records |
| | | | t_instruction_detail | 批量更新/插入 instruction detail records |
| | | | t_daily_vehicle_cost | 批量更新/插入 daily cost records |
| | | | t_partner_data_version | partner_id → data_version increment |
| | | | t_csv_upload_action_log | 插入反映记录 |
| ver.up | POST /api/v1/csv/{uploadId}/import | 版本号递增 | t_partner_data_version | version + 1 |
| | | | t_csv_upload | version update |
| 反映日時表示 | GET /api/v1/csv/{uploadId} | 显示反映时间 | t_csv_upload | imported_datetime |
| **一斉メール送信区** | | | | |
| ⑻ 一斉メール送信 | POST /api/v1/csv/{uploadId}/send-notifications | 批量发送邮件 | t_notification | notification_id, partner_id, notification_type, sent_datetime, sent_status |
| | | | m_partner | partner_id → email, sub_account_id |
| | | | t_sub_account | partner_id, sub_account_id, is_exists |
| 対象パートナー数表示 | GET /api/v1/csv/{uploadId}/notification-targets | 获取目标数 | m_partner | count where sub_account_id is null |
| 非対象パートナー数表示 | GET /api/v1/csv/{uploadId}/notification-targets | 获取非目标数 | m_partner | count where sub_account_id is not null |
| 送付日時表示 | GET /api/v1/csv/{uploadId}/notifications | 显示发送时间 | t_notification | sent_datetime |
| **上传方式控制** | | | | |
| 全件单位控制 | GET /api/v1/bases/{baseId}/config | 获取上传单位设置 | m_base_config | base_id, upload_unit (ALL/PARTNER) |
| | | | t_partner | partner_id, base_id |
| 個別单位控制 | GET /api/v1/partners/{partnerId}/upload | 個別上传 | t_partner_upload | partner_id, year_month, upload_status |

#### 5.5.2 关系说明

**1. 页面加载流程**

```
页面初始化 (b8-CSVアップロード)
         ↓
GET /api/v1/csv/upload/{tabType}/{yearMonth}
         ↓
后端查询: t_csv_upload (WHERE year_month = ? AND tab_type = ?)
         ↓
关联查询: m_base_config (获取上传方式设置: 全件/個別)
关联查询: t_csv_file (获取上传文件信息)
关联查询: t_csv_upload_history (获取历史记录)
关联查询: t_csv_validation_result (获取检查结果)
         ↓
返回上传状态给前端
         ↓
前端渲染:
  - 上传方式 (全件/個別)
  - Tabs内容
  - 已上传文件信息
  - 检查结果
```

**2. 文件上传流程（⑷）**

```
用户选择CSV文件
         ↓
前端校验: 文件类型, 文件大小
         ↓
POST /api/v1/csv/upload
Content-Type: multipart/form-data
Body: { year_month, tab_type, file }
         ↓
后端处理:
  1. 验证文件类型 (CSV)
  2. 解析CSV头部 (获取列数, 列名)
  3. 验证字符编码 (UTF-8/SJIS)
  4. 保存文件到存储服务
  5. 生成file_id
  6. 插入 t_csv_file (文件记录)
  7. 插入 t_csv_upload (上传记录: status="UPLOADED")
  8. 触发异步文件检查
         ↓
后端异步处理:
  1. 文件チェック (必須項目, 項目数, 文字コード)
  2. 插入 t_csv_validation_result (检查结果)
  3. 更新 t_csv_upload (status="FILE_CHECKING")
         ↓
文件检查完成
         ↓
返回响应: { upload_id, file_check_results }
         ↓
前端显示ファイルチェック結果
```

**3. ファイルチェック流程（⑸）**

```
POST /api/v1/csv/{uploadId}/validate
         ↓
后端查询: t_csv_file (获取CSV文件)
         ↓
执行文件检查:
  1. 必須項目ブランク检查
     - 读取CSV第一行 (列名)
     - 检查必填列是否存在空白
     - 记录NG行号和列名
  2. 項目数检查
     - 对比CSV列数与标准模板
     - 记录差异
  3. 文字コード检查
     - 检测文件编码
     - 转换为UTF-8
         ↓
插入 t_csv_validation_result (检查结果)
         ↓
返回检查结果:
  {
    "required_blank": "OK/NG",
    "column_count": "OK/NG",
    "encoding": "OK/NG",
    "details": [...]
  }
         ↓
前端显示チェック結果:
  - 全OK → ボタン活性化
  - 有NG → 显示错误详情, 无法继续
```

**4. データチェック流程（⑹）**

```
POST /api/v1/csv/{uploadId}/data-validate
         ↓
后端查询: t_csv_file (获取CSV数据)
关联查询: t_instruction/t_daily_vehicle_cost (系统现有数据)
         ↓
执行数据检查:
  1. 差分検出
     - 系统有但CSV没有的数据 → 显示, 询问是否删除
     - CSV有但系统没有的数据 → 自动添加
  2. 数据内容校验
     - 数据格式校验
     - 数值范围校验
         ↓
插入 t_csv_data_diff (差异记录)
         ↓
返回差异数据:
  {
    "missing_in_csv": [...],
    "extra_in_csv": [...],
    "data_changes": [...]
  }
         ↓
前端显示:
  - 差分リスト
  - チェックボックス选择保留/删除
  - [キャンセル] / [パートナーに反映] ボタン
```

**5. パートナーに反映流程（⑺）**

```
用户点击【パートナーに反映】
         ↓
POST /api/v1/csv/{uploadId}/import
Body: { data_confirmations: [...] } (保留/删除选择)
         ↓
后端处理:
  1. 验证文件检查状态 (必須FILE_CHECK_OK)
  2. 获取保留/删除配置
  3. 启动事务:
     a. 删除系统中有但CSV标记为删除的数据
     b. 批量更新CSV中有的数据
     c. 批量插入CSV中新增的数据
     d. 更新 t_csv_upload (status="IMPORTED", imported_datetime=NOW())
     e. 版本号递增:
        - 更新 t_partner_data_version (version = version + 1)
        - 更新 t_csv_upload (version)
     f. 插入 t_csv_upload_action_log (IMPORT操作)
  4. 提交事务
         ↓
返回成功响应:
  {
    "status": "success",
    "version": "n+1",
    "imported_count": 100,
    "deleted_count": 5
  }
         ↓
前端显示:
  - ver.up (ver.3 → ver.4)
  - 反映日時
```

**6. 一斉メール送信流程（⑻）**

```
用户点击【一斉メール送信】
         ↓
POST /api/v1/csv/{uploadId}/send-notifications
         ↓
后端处理:
  1. 查询目标パートナー:
     SELECT * FROM m_partner
     WHERE sub_account_id IS NULL  -- サブアカウントがない
     AND is_active = true
     AND base_id = (SELECT base_id FROM t_csv_upload WHERE upload_id = ?)
  2. 排除已有邮件发送记录的パートナー
  3. 批量生成邮件内容
  4. 调用邮件服务发送
  5. 插入 t_notification (发送记录)
         ↓
返回发送结果:
  {
    "status": "success",
    "sent_count": 15,
    "failed_count": 0,
    "skipped_count": 5  -- サブアカウント持有
  }
         ↓
前端显示:
  - 対象パートナー数: 15件
  - サブアカウント保有パートナー数: 5件 (送付対象外)
  - 送付日時
```

**7. 上传方式切换流程**

```
页面加载
         ↓
GET /api/v1/bases/{baseId}/config
         ↓
后端查询: m_base_config (WHERE base_id = ?)
         ↓
返回: upload_unit = "ALL" (全件) or "PARTNER" (個別)
         ↓
前端显示:
  - 全件单位: 選択した年月の全パートナーに対して一括上传画面
  - 個別单位: 個別パートナーごとにアップロードするファイルを選択画面
```

**8. 数据表关系**

```
t_csv_upload（CSV上传主表）
    ├─ id (主键)
    ├─ upload_id (上传ID，业务主键)
    ├─ year_month (年月)
    ├─ tab_type (Tab类型)
    │      ├─ order (発注)
    │      ├─ completed_order (実績確認)
    │      └─ both (発注＆実績確認)
    ├─ upload_unit (上传方式)
    │      ├─ ALL (全件单位)
    │      └─ PARTNER (個別单位)
    ├─ uploaded_file_id (上传文件ID)
    │      └─→ t_csv_file.file_id
    ├─ uploaded_file_name (文件名)
    ├─ uploaded_datetime (上传时间)
    ├─ uploaded_by (上传者)
    │      └─→ m_user.user_id
    ├─ status (状态)
    │      ├─ UPLOADED (已上传)
    │      ├─ FILE_CHECKING (文件检查中)
    │      ├─ FILE_CHECK_OK (文件检查OK)
    │      ├─ FILE_CHECK_NG (文件检查NG)
    │      ├─ DATA_CHECKING (数据检查中)
    │      ├─ DATA_CHECK_OK (数据检查OK)
    │      ├─ IMPORTED (已反映)
    │      ├─ NOTIFICATIONS_SENT (邮件已发送)
    │      └─ CANCELLED (已取消)
    ├─ version (版本号)
    ├─ imported_datetime (反映时间)
    ├─ notification_sent_datetime (邮件发送时间)
    ├─ base_id (ベースID)
    │      └─→ m_base_config.base_id
    └─ is_active (是否有效)

t_csv_file（CSV文件表）
    ├─ id (主键)
    ├─ file_id (文件ID)
    ├─ upload_id (上传ID)
    │      └─→ t_csv_upload.upload_id
    ├─ file_name (文件名)
    ├─ file_path (文件路径)
    ├─ file_size (文件大小)
    ├─ row_count (行数)
    ├─ column_count (列数)
    ├─ encoding (字符编码)
    ├─ uploaded_by (上传者)
    │      └─→ m_user.user_id
    ├─ uploaded_datetime (上传时间)
    └─ is_active (是否有效)

t_csv_validation_result（CSV校验结果表）
    ├─ id (主键)
    ├─ validation_id (校验ID)
    ├─ upload_id (上传ID)
    │      └─→ t_csv_upload.upload_id
    ├─ validation_type (校验类型)
    │      ├─ FILE_CHECK (文件检查)
    │      └─ DATA_CHECK (数据检查)
    ├─ check_item (检查项目)
    │      ├─ REQUIRED_FIELD (必填项)
    │      ├─ COLUMN_COUNT (列数)
    │      ├─ ENCODING (编码)
    │      ├─ DATA_FORMAT (数据格式)
    │      └─ DATA_RANGE (数据范围)
    ├─ check_result (检查结果)
    │      ├─ PASSED (通过)
    │      └─ FAILED (失败)
    ├─ error_detail (错误详情)
    ├─ error_row (错误行号)
    ├─ error_column (错误列名)
    └─ validated_at (校验时间)

t_csv_data_diff（CSV数据差异表）
    ├─ id (主键)
    ├─ diff_id (差异ID)
    ├─ upload_id (上传ID)
    │      └─→ t_csv_upload.upload_id
    ├─ data_type (数据类型)
    │      ├─ instruction (运行指示)
    │      └─ daily_cost (日别费用)
    ├─ data_code (数据代码)
    ├─ data_name (数据名称)
    ├─ exists_in_csv (是否在CSV中)
    ├─ exists_in_system (是否在系统中)
    ├─ data_value_csv (CSV中的值)
    ├─ data_value_system (系统中的值)
    ├─ keep_status (保留状态)
    │      ├─ KEEP (保留)
    │      ├─ DELETE (删除)
    │      └─ PENDING (待定)
    ├─ confirmed_by (确认者)
    │      └─→ m_user.user_id
    ├─ confirmed_datetime (确认时间)
    └─ created_at (创建时间)

t_csv_upload_action_log（CSV上传操作日志表）
    ├─ id (主键)
    ├─ log_id (日志ID)
    ├─ upload_id (上传ID)
    │      └─→ t_csv_upload.upload_id
    ├─ action_type (操作类型)
    │      ├─ UPLOAD (上传)
    │      ├─ REUPLOAD (再上传)
    │      ├─ FILE_CHECK (文件检查)
    │      ├─ DATA_CHECK (数据检查)
    │      ├─ IMPORT (反映)
    │      ├─ CANCEL (取消)
    │      └─ NOTIFICATION (邮件通知)
    ├─ action_detail (操作详情)
    ├─ action_datetime (操作时间)
    ├─ action_by (操作者)
    │      └─→ m_user.user_id
    └─ related_data (关联数据)

m_base_config（ベース配置表）
    ├─ id (主键)
    ├─ base_id (ベースID)
    ├─ base_name (ベース名称)
    ├─ upload_unit (上传方式)
    │      ├─ ALL (全件单位)
    │      └─ PARTNER (個別单位)
    ├─ csv_template_id (CSV模板ID)
    │      └─→ m_csv_template.template_id
    └─ is_active (是否有效)

m_csv_template（CSV模板表）
    ├─ id (主键)
    ├─ template_id (模板ID)
    ├─ template_name (模板名称)
    ├─ template_type (模板类型)
    │      ├─ order (月間運行計画表)
    │      ├─ daily_cost (日別傭車費一覧)
    │      └─ both (双方)
    ├─ required_columns (必填列JSON)
    ├─ column_count (列数)
    ├─ encoding (编码)
    └─ is_active (是否有效)

t_partner_data_version（パートナー数据版本表）
    ├─ id (主键)
    ├─ partner_id (パートナーID)
    │      └─→ m_partner.partner_id
    ├─ year_month (年月)
    ├─ data_type (数据类型)
    │      ├─ instruction (运行指示)
    │      └─ daily_cost (日别费用)
    ├─ version (版本号)
    ├─ updated_at (更新时间)
    └─ updated_by (更新者)
    │      └─→ m_user.user_id

m_partner（合作伙伴表）
    ├─ id (主键)
    ├─ partner_id (パートナーID)
    ├─ base_id (ベースID)
    │      └─→ m_base_config.base_id
    ├─ company_code (公司代码)
    ├─ partner_name (パートナー名称)
    ├─ email (邮箱)
    ├─ sub_account_id (サブアカウントID)
    │      └─→ t_sub_account.sub_account_id (可为NULL)
    └─ is_active (是否有效)

t_sub_account（子账户表）
    ├─ id (主键)
    ├─ sub_account_id (サブアカウントID)
    ├─ partner_id (パートナーID)
    │      └─→ m_partner.partner_id
    ├─ sub_account_name (サブアカウント名称)
    ├─ branch_office (支店/営業所)
    └─ is_active (是否有效)

t_notification（通知表）
    ├─ id (主键)
    ├─ notification_id (通知ID)
    ├─ upload_id (上传ID)
    │      └─→ t_csv_upload.upload_id
    ├─ partner_id (パートナーID)
    │      └─→ m_partner.partner_id
    ├─ notification_type (通知类型)
    │      └─ CSV_UPLOADED (CSV上传通知)
    ├─ sent_datetime (发送时间)
    ├─ sent_status (发送状态)
    │      ├─ SENT (已发送)
    │      ├─ FAILED (失败)
    │      └─ SKIPPED (跳过)
    ├─ failure_reason (失败原因)
    └─ is_active (是否有效)
```

**9. 字段映射关系**

| 画面元素 | 数据库表 | 源字段 | 目标字段 | 转换逻辑 |
|----------|---------|--------|---------|---------|
| 年月選択 | t_csv_upload | year_month | - | YYYY-MM格式转换 |
| アップロードする書類 | t_csv_upload | tab_type | - | Tab类型映射到文件类型 |
| アップロード済ファイル名 | t_csv_file | file_name | - | 直接映射 |
| アップロード日時 | t_csv_upload | uploaded_datetime | - | 日期时间格式化 |
| ファイルチェック結果 | t_csv_validation_result | check_item, is_passed | - | 遍历检查结果 |
| 必須項目ブランク | t_csv_validation_result | check_item="REQUIRED_FIELD", is_passed | - | OK/NG显示 |
| 項目数 | t_csv_validation_result | check_item="COLUMN_COUNT", is_passed | - | OK/NG显示 |
| 文字コード | t_csv_validation_result | check_item="ENCODING", is_passed | - | OK/NG显示 |
| データチェック結果 | t_csv_data_diff | data_type, keep_status | - | 差分列表显示 |
| 差分データ | t_csv_data_diff | data_code, data_name, exists_in_csv, exists_in_system | - | 表格显示 |
| パートナーに反映 | t_csv_upload | status | - | 按钮活性控制 |
| ver.up | t_csv_upload | version | - | version + 1 |
| 反映日時 | t_csv_upload | imported_datetime | - | 日期时间格式化 |
| 一斉メール送信 | t_notification | sent_status | - | 按钮活性控制 |
| 対象パートナー数 | m_partner | COUNT | - | sub_account_id IS NULL 计数 |
| 非対象パートナー数 | m_partner | COUNT | - | sub_account_id IS NOT NULL 计数 |
| 送付日時 | t_notification | sent_datetime | - | 日期时间格式化 |

#### 5.5.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           b8-CSVアップロード 画面                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  [発注（前月25日～26日）] [実績確認（当月中）] [発注＆実績確認（〆後）] │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ⑴ 年月: [プルダウン▼]                                                    │
│                                                                             │
│  ⑵ アップロードする書類: [月間運行計画表]                                  │
│                                                                             │
│  ⑶ アップロード済ファイル名: xxx.csv    アップロード日時: 2026-02-10 14:30 │ │
│                                                                             │
│  ⑷ [ファイルアップロード] / [再アップロード]                                 │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑸ ファイルチェック結果                                                │ │
│  │  ┌─────────────────────────────────────────────────────────┐          │ │
│  │  │ 必須項目ブランク: [OK]  項目数: [OK]  文字コード: [OK]  │          │ │
│  │  └─────────────────────────────────────────────────────────┘          │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑹ データチェック結果                                                │ │
│  │  ┌─────────────────────────────────────────────────────────┐          │ │
│  │  │ [差分リスト]                                                    │          │ │
│  │  │ ┌───────────────────────────────────────────────────┐ │          │ │
│  │  │ │ ☐ データ1  (チェックボックスで残す/削除)          │ │          │ │
│  │  │ └───────────────────────────────────────────────────┘ │          │ │
│  │  │                                                           │          │ │
│  │  │ [キャンセル]  [パートナーに反映]                         │          │ │
│  │  └─────────────────────────────────────────────────────────┘          │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  [パートナーに反映] ボタン    ver.up: ver.3 → ver.4                        │
│  [一斉メール送信] ボタン    反映日時: 2026-02-10 14:35                       │
│                                                                             │
│  対象パートナー数: 15件    送付日時: 2026-02-10 14:40                        │
│  サブアカウント保有パートナー数: 5件 (送付対象外)                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓                              ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET csv/upload/ │           │ POST csv/upload │
          │ {tab}/{month}   │           │ (文件上传)      │
          │ (页面加载)      │           └────────┬───────┘
          └────────┬───────┘                    │
                   │                            ↓
                   │                   ┌────────────────┐
                   │                   │ POST csv/{id}/  │
                   │                   │ validate        │
                   │                   │ (ファイルチェック)│
                   │                   └────────┬───────┘
                   │                            ↓
                   │                   ┌────────────────┐
                   │                   │ POST csv/{id}/  │
                   │                   │ data-validate   │
                   │                   │ (データチェック) │
                   │                   └────────┬───────┘
                   │                            ↓
                   │                   ┌────────────────┐
                   │                   │ POST csv/{id}/  │
                   │                   │ import          │
                   │                   │ (パートナーに反映)│
                   │                   └────────┬───────┘
                   │                            ↓
                   │                   ┌────────────────┐
                   │                   │ POST csv/{id}/  │
                   │                   │ send-notifications│
                   │                   │ (一斉メール送信) │
                   │                   └────────────────┘
```

#### 5.5.4 核心数据库表结构

**t_csv_upload（CSV上传主表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| upload_id | VARCHAR(50) | 上传ID（业务主键） | UNIQUE |
| year_month | VARCHAR(7) | 年月（YYYY-MM） | - |
| tab_type | VARCHAR(20) | Tab类型 | order/completed_order/both |
| upload_unit | VARCHAR(10) | 上传方式 | ALL/PARTNER |
| uploaded_file_id | VARCHAR(50) | 上传文件ID | → t_csv_file.file_id |
| uploaded_file_name | VARCHAR(255) | 文件名 | - |
| uploaded_datetime | TIMESTAMP | 上传时间 | - |
| uploaded_by | VARCHAR(20) | 上传者 | → m_user.user_id |
| status | VARCHAR(20) | 状态 | UPLOADED/FILE_CHECKING/FILE_CHECK_OK/FILE_CHECK_NG/DATA_CHECKING/DATA_CHECK_OK/IMPORTED/NOTIFICATIONS_SENT/CANCELLED |
| version | INTEGER | 版本号 | - |
| imported_datetime | TIMESTAMP | 反映时间 | - |
| notification_sent_datetime | TIMESTAMP | 邮件发送时间 | - |
| base_id | VARCHAR(20) | ベースID | → m_base_config.base_id |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_csv_file（CSV文件表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| file_id | VARCHAR(50) | 文件ID | UNIQUE |
| upload_id | VARCHAR(50) | 上传ID | → t_csv_upload.upload_id |
| file_name | VARCHAR(255) | 文件名 | - |
| file_path | VARCHAR(500) | 文件路径 | - |
| file_size | BIGINT | 文件大小（字节） | - |
| row_count | INTEGER | 行数 | - |
| column_count | INTEGER | 列数 | - |
| encoding | VARCHAR(20) | 字符编码 | UTF-8/SJIS |
| csv_data | JSONB | CSV数据 | - |
| uploaded_by | VARCHAR(20) | 上传者 | → m_user.user_id |
| uploaded_datetime | TIMESTAMP | 上传时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_csv_validation_result（CSV校验结果表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| validation_id | VARCHAR(50) | 校验ID | UNIQUE |
| upload_id | VARCHAR(50) | 上传ID | → t_csv_upload.upload_id |
| validation_type | VARCHAR(20) | 校验类型 | FILE_CHECK/DATA_CHECK |
| check_item | VARCHAR(50) | 检查项目 | REQUIRED_FIELD/COLUMN_COUNT/ENCODING/DATA_FORMAT/DATA_RANGE |
| check_result | VARCHAR(10) | 检查结果 | PASSED/FAILED |
| error_detail | TEXT | 错误详情 | - |
| error_row | INTEGER | 错误行号 | - |
| error_column | VARCHAR(100) | 错误列名 | - |
| validated_at | TIMESTAMP | 校验时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_csv_data_diff（CSV数据差异表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| diff_id | VARCHAR(50) | 差异ID | UNIQUE |
| upload_id | VARCHAR(50) | 上传ID | → t_csv_upload.upload_id |
| data_type | VARCHAR(20) | 数据类型 | instruction/daily_cost |
| data_code | VARCHAR(50) | 数据代码 | - |
| data_name | VARCHAR(200) | 数据名称 | - |
| exists_in_csv | BOOLEAN | 是否在CSV中 | - |
| exists_in_system | BOOLEAN | 是否在系统中 | - |
| data_value_csv | JSONB | CSV中的值 | - |
| data_value_system | JSONB | 系统中的值 | - |
| keep_status | VARCHAR(20) | 保留状态 | KEEP/DELETE/PENDING |
| confirmed_by | VARCHAR(20) | 确认者 | → m_user.user_id |
| confirmed_datetime | TIMESTAMP | 确认时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_csv_upload_action_log（CSV上传操作日志表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| log_id | VARCHAR(50) | 日志ID | UNIQUE |
| upload_id | VARCHAR(50) | 上传ID | → t_csv_upload.upload_id |
| action_type | VARCHAR(20) | 操作类型 | UPLOAD/REUPLOAD/FILE_CHECK/DATA_CHECK/IMPORT/CANCEL/NOTIFICATION |
| action_detail | TEXT | 操作详情 | JSON格式 |
| action_datetime | TIMESTAMP | 操作时间 | - |
| action_by | VARCHAR(20) | 操作者 | → m_user.user_id |
| related_data | TEXT | 关联数据 | JSON格式 |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**m_base_config（ベース配置表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| base_id | VARCHAR(20) | ベースID | UNIQUE |
| base_name | VARCHAR(100) | ベース名称 | - |
| upload_unit | VARCHAR(10) | 上传方式 | ALL/PARTNER |
| csv_template_id | VARCHAR(50) | CSV模板ID | → m_csv_template.template_id |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**m_csv_template（CSV模板表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| template_id | VARCHAR(50) | 模板ID | UNIQUE |
| template_name | VARCHAR(100) | 模板名称 | - |
| template_type | VARCHAR(20) | 模板类型 | order/daily_cost/both |
| required_columns | JSONB | 必填列 | - |
| column_count | INTEGER | 列数 | - |
| encoding | VARCHAR(20) | 编码 | UTF-8/SJIS |
| template_file_path | VARCHAR(500) | 模板文件路径 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_partner_data_version（パートナー数据版本表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| partner_id | VARCHAR(20) | パートナーID | → m_partner.partner_id |
| year_month | VARCHAR(7) | 年月 | - |
| data_type | VARCHAR(20) | 数据类型 | instruction/daily_cost |
| version | INTEGER | 版本号 | - |
| updated_at | TIMESTAMP | 更新时间 | - |
| updated_by | VARCHAR(20) | 更新者 | → m_user.user_id |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| UNIQUE | (partner_id, year_month, data_type) | 复合唯一 | - |

**t_notification（通知表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| notification_id | VARCHAR(50) | 通知ID | UNIQUE |
| upload_id | VARCHAR(50) | 上传ID | → t_csv_upload.upload_id |
| partner_id | VARCHAR(20) | パートナーID | → m_partner.partner_id |
| notification_type | VARCHAR(50) | 通知类型 | CSV_UPLOADED |
| sent_datetime | TIMESTAMP | 发送时间 | - |
| sent_status | VARCHAR(20) | 发送状态 | SENT/FAILED/SKIPPED |
| failure_reason | TEXT | 失败原因 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

---

### 6.1 上传组件
```typescript
// b8上传组件
import { Upload, Button, Progress, Tabs } from 'antd';

export const B8UploadPage: React.FC = () => {
  const [fileList, setFileList] = useState([]);
  const [uploadStatus, setUploadStatus] = useState('idle');

  const handleUpload = async (file) => {
    // 执行上传
  };

  return (
    <div className="b8-upload-container">
      <Tabs items={tabItems} />
      <Upload
        beforeUpload={handleUpload}
        fileList={fileList}
      >
        <Button>アップロード</Button>
      </Upload>
      <CheckResults results={checkResults} />
      <DataDiff diff={dataDiff} />
      <Button disabled={!canImport}>パートナーに反映</Button>
      <Button disabled={!canSend}>一斉メール送信</Button>
    </div>
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] Tab切换正常
- [ ] 文件上传正常
- [ ] 文件检查正常
- [ ] 数据检查正常
- [ ] 反映功能正常
- [ ] 邮件发送正常

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] 状态显示正确
- [ ] 按钮状态正确

### 7.3 性能验收
- [ ] 文件上传 < 10秒
- [ ] 数据校验 < 5秒
- [ ] 批量处理正常

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10 | v1.0.1 | 新增5.5节：画面-API-数据库关系映射表，包含详细的关系总览、关系说明、数据流图和核心数据库表结构 | - |
| 2026-02-XX | v1.0 | 初始版本 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b0-导航菜单 | [../b0-共通ナビゲーション/05_设计规范.md](../b0-共通ナビゲーション/05_设计规范.md) | 导航菜单设计规范 |

### A.2 与p6-CSVアップロード对比
| 特性 | b8-CSVアップロード | p6-CSVアップロード |
|------|--------------------|--------------------|
| **用户类型** | ベース | 輸送パートナー |
| **设备支持** | PCのみ | PC/SP |

---

**文档编制**: -  
**编制时间**: 2026-02-10 
**适用范围**: 別紙_画面一覧_v151.xlsx - b8-CSVアップロード  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
