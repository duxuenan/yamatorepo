# p5-請求検索 - 详细分析

## 1. 页面概述

### 1.1 页面定位

p5-請求検索 是パートナー側（合作伙伴端）的账单搜索页面。パートナー通过此页面搜索和查看来自ベース（总部）的账单信息，包括账单状态、金额和详细内容。

### 1.2 核心功能

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 账单搜索 | 按条件搜索账单 | P0-必须 |
| 结果展示 | 分页显示搜索结果 | P0-必须 |
| 账单查看 | 查看账单详细信息 | P0-必须 |
| 导出功能 | 导出搜索结果（可选） | P1-建议 |

### 1.3 与b5的差异

| 特性 | b5-実績詳細 | p5-請求検索 |
|------|-------------|-------------|
| **用户角色** | ベース（总部） | 輸送パートナー（合作伙伴） |
| **页面类型** | 详情页面 | 搜索列表页面 |
| **主要操作** | 业绩详情查看 | 账单搜索和查看 |
| **设备支持** | PCのみ | PC/SP |

---

## 2. 页面结构层次

### 2.1 整体结构

```
輸送パートナーシステム
├── p5-請求検索（账单搜索页）
│   ├── 页面头部
│   │   └── 页面标题
│   ├── 搜索条件区域
│   │   ├── 年月选择（下拉）
│   │   ├── 請求ID输入框
│   │   ├── ステータス选择（下拉）
│   │   └── 検索ボタン
│   └── 搜索结果区域
│       ├── 搜索结果表格
│       │   ├── 年月列
│       │   ├── 請求ID列
│       │   ├── 金額列
│       │   ├── ステータス列
│       │   ├── 請求日列
│       │   └── 操作列（查看详情）
│       └── 分页组件
```

### 2.2 区域详细说明

#### 区域1：搜索条件

| 元素 | 类型 | 选项/格式 | 说明 |
|------|------|-----------|------|
| 年月選択 | DatePicker.Month | YYYY-MM | 选择搜索年月 |
| 請求ID | Input | 文字列 | 输入账单ID（支持模糊搜索） |
| ステータス | Select | 枚举值 | 账单状态筛选 |
| 検索ボタン | Button | - | 执行搜索操作 |

#### 区域2：搜索结果表格

| 列 | 类型 | 格式 | 说明 |
|----|------|------|------|
| 年月 | Text | YYYY-MM | 账单年月 |
| 請求ID | Link | 文字列 | 点击查看详情 |
| 金額 | Number | ¥999,999 | 账单金额 |
| ステータス | Tag | 枚举 | 状态标签 |
| 請求日 | Date | YYYY/MM/DD | 账单发布日期 |
| 操作 | Button | - | 查看详情 |

---

## 3. 字段详细分析

### 3.1 搜索字段

| 字段标识 | 字段名称 | 数据类型 | 必填 | 选项 | 业务规则 |
|----------|----------|----------|------|------|----------|
| year_month | 年月選択 | month | 否 | 近12个月 | 搜索账单年月 |
| billing_id | 請求ID | string | 否 | - | 支持模糊搜索 |
| status | ステータス | select | 否 | 枚举值 | 账单状态筛选 |

### 3.2 结果字段

| 字段标识 | 字段名称 | 数据类型 | 格式 | 说明 |
|----------|----------|----------|------|------|
| billing_year_month | 年月 | string | YYYY-MM | 账单年月 |
| billing_id | 請求ID | string | 文字列 | 账单唯一标识 |
| amount | 金額 | number | ¥999,999 | 账单总金额 |
| billing_status | ステータス | enum | 标签 | 账单当前状态 |
| issue_date | 請求日 | date | YYYY/MM/DD | 账单发布日期 |

### 3.3 状态枚举值

| 状态值 | 显示名称 | 颜色 | 说明 |
|--------|----------|------|------|
| PENDING | 未請求 | 橙色 | 待发布 |
| ISSUED | 請求済 | 蓝色 | 已发布 |
| PAID | 支払済 | 绿色 | 已支付 |
| CANCELLED | キャンセル | 灰色 | 已取消 |

### 3.4 搜索规则

- 所有搜索条件为AND关系
- 請求ID支持部分匹配
- 年月选择限制在最近12个月
- 默认显示当前月份账单

---

## 4. 交互流程详细说明

### 4.1 页面初始化流程

```
┌─────────────────────────────────────────────────────────────┐
│  页面初始化流程                                              │
├─────────────────────────────────────────────────────────────┤
│  1. 用户导航到p5页面                                          │
│     ↓                                                        │
│  2. 初始化搜索表单                                            │
│     - 设置默认年月为当前月份                                  │
│     - 清空搜索条件                                             │
│     ↓                                                        │
│  3. 自动执行默认搜索（当前月份）                              │
│     GET /api/v1/partners/billings/search                     │
│     ↓                                                        │
│  4. 显示搜索结果                                              │
│     ↓                                                        │
│  5. 页面加载完成                                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 搜索操作流程

```
┌─────────────────────────────────────────────────────────────┐
│  搜索操作流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 用户输入或选择搜索条件                                    │
│     - 选择年月（可选）                                         │
│     - 输入請求ID（可选）                                      │
│     - 选择ステータス（可选）                                   │
│     ↓                                                        │
│  2. 点击「検索」ボタン                                         │
│     ↓                                                        │
│  3. 前端参数验证                                              │
│     - 年月格式验证                                            │
│     - 請求ID长度验证                                          │
│     ↓                                                        │
│  4. 调用搜索API                                               │
│     GET /api/v1/partners/billings/search                     │
│     ↓                                                        │
│  5. 显示加载状态                                              │
│     ↓                                                        │
│  6. API返回搜索结果                                           │
│     ↓                                                        │
│  7. 渲染搜索结果表格                                          │
│     ↓                                                        │
│  8. 更新分页信息                                              │
│     ↓                                                        │
│  9. 搜索完成                                                  │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 查看详情流程

```
┌─────────────────────────────────────────────────────────────┐
│  查看详情流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 用户点击账单的「查看」链接                                  │
│     ↓                                                        │
│  2. 获取账单ID                                               │
│     ↓                                                        │
│  3. 导航到账单详情页                                          │
│     /p5/detail/{billingId}                                    │
│     ↓                                                        │
│  4. 显示账单详细信息                                          │
│     - 账单基本信息                                           │
│     - 费用明细                                               │
│     - 支付状态                                               │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 分页操作流程

```
┌─────────────────────────────────────────────────────────────┐
│  分页操作流程                                                │
├─────────────────────────────────────────────────────────────┤
│  1. 用户点击分页组件                                          │
│     ↓                                                        │
│  2. 获取目标页码                                              │
│     ↓                                                        │
│  3. 调用搜索API（带页码）                                     │
│     GET /api/v1/partners/billings/search?page={page}        │
│     ↓                                                        │
│  4. 显示加载状态                                              │
│     ↓                                                        │
│  5. API返回搜索结果                                           │
│     ↓                                                        │
│  6. 更新表格内容                                              │
│     ↓                                                        │
│  7. 更新分页组件                                              │
│     ↓                                                        │
│  8. 滚动到表格顶部                                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 数据结构说明

### 5.1 搜索请求参数

```typescript
interface SearchBillingRequest {
  yearMonth?: string;        // YYYY-MM
  billingId?: string;         // 部分匹配
  status?: BillingStatus;     // 账单状态
  page?: number;              // 页码（从1开始）
  pageSize?: number;          // 每页大小（默认20）
  sort?: string;              // 排序字段
  sortOrder?: 'asc' | 'desc'; // 排序方向
}
```

### 5.2 搜索响应结构

```typescript
interface SearchBillingResponse {
  success: boolean;
  data: {
    billings: BillingItem[];
    pagination: {
      currentPage: number;
      pageSize: number;
      totalItems: number;
      totalPages: number;
    };
    summary: {
      totalCount: number;
      totalAmount: number;
      paidAmount: number;
      pendingAmount: number;
    };
  };
}

interface BillingItem {
  billingId: string;
  billingYearMonth: string;
  amount: number;
  status: BillingStatus;
  issueDate: string;
  createdAt: string;
}
```

---

## 6. 业务规则

### 6.1 搜索权限规则

- 合作伙伴只能查看自己相关的账单
- 账单按合作伙伴ID过滤
- 敏感信息不显示给合作伙伴

### 6.2 状态显示规则

- 未請求：橙色标签，显示"待发布"
- 請求済：蓝色标签，显示"已发布"
- 支払済：绿色标签，显示"已支付"
- キャンセル：灰色标签，显示"已取消"

### 6.3 分页规则

- 默认每页显示20条记录
- 最大每页100条记录
- 缓存搜索结果（5分钟）

---

## 7. 异常处理

### 7.1 异常场景

| 场景 | 处理方式 | 用户提示 |
|------|----------|----------|
| 搜索参数错误 | 前端验证，清除无效参数 | "検索条件を確認してください" |
| 网络错误 | 重试机制 | "ネットワークエラーが発生しました" |
| 服务器错误 | 显示错误页面 | "サーバーエラーが発生しました" |
| 无搜索结果 | 显示空状态 | "検索条件に一致する請求がありません" |
| 权限不足 | 显示错误提示 | "この操作の権限がありません" |

### 7.2 错误处理策略

```typescript
const handleSearchError = (error: AxiosError) => {
  if (error.response?.status === 400) {
    message.error('検索条件が無効です');
  } else if (error.response?.status === 403) {
    message.error('権限がありません');
  } else if (error.code === 'NETWORK_ERROR') {
    message.error('ネットワーク接続を確認してください');
  } else {
    message.error('検索に失敗しました');
  }
};
```

---

## 8. 性能要求

| 指标 | 要求 | 说明 |
|------|------|------|
| 搜索响应时间 | < 1秒 | 查询API响应 |
| 页面加载时间 | < 2秒 | 首屏渲染 |
| 表格渲染时间 | < 500ms | 结果展示 |
| 分页切换时间 | < 300ms | 页面切换 |

---

## 9. 兼容性要求

### 9.1 响应式设计

| 断点 | 布局 | 说明 |
|------|------|------|
| PC (≥1024px) | 完整表格 | 显示所有列 |
| 平板 (768-1023px) | 压缩表格 | 部分列隐藏 |
| 手机 (<768px) | 卡片列表 | 单列卡片展示 |

### 9.2 移动端适配

- 搜索条件垂直排列
- 表格转为卡片列表
- 简化操作按钮
- 优化触摸交互

---

## 10. 扩展功能

### 10.1 高级搜索

```typescript
interface AdvancedSearchRequest extends SearchBillingRequest {
  amountMin?: number;        // 最小金额
  amountMax?: number;        // 最大金额
  dateFrom?: string;         // 开始日期
  dateTo?: string;           // 结束日期
  hasInvoice?: boolean;      // 是否有发票
}
```

### 10.2 导出功能

```typescript
interface ExportRequest {
  searchConditions: SearchBillingRequest;
  format: 'csv' | 'excel' | 'pdf';
  includeDetails?: boolean;
}

// POST /api/v1/partners/billings/export
```

---

**文档编制**: -  
**编制时间**: 2026-02-XX 
**适用范围**: p5-請求検索 合作伙伴账单搜索页面