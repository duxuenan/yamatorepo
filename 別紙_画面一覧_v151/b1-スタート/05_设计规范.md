# b1-ã‚¹ã‚¿ãƒ¼ãƒˆ - è®¾è®¡è§„èŒƒ

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ–‡æ¡£ä¿¡æ¯
| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å·¥ä½œè¡¨åç§°** | b1-ã‚¹ã‚¿ãƒ¼ãƒˆ |
| **ç•Œé¢ç¼–å·** | b1 |
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0.1 |
| **æœ€åæ›´æ–°** | 2026-02-10|
| **æ–‡æ¡£çŠ¶æ€** | âœ… å·²å‘å¸ƒï¼ˆçº¯å‰ç«¯JWTæ–¹æ¡ˆï¼‰ |

### 1.2 åŠŸèƒ½æè¿°
b1-ã‚¹ã‚¿ãƒ¼ãƒˆ æ˜¯ç³»ç»Ÿçš„èµ·å§‹é¡µé¢ï¼Œæä¾›åŸºäº AzureAD çš„ç”¨æˆ·è®¤è¯å…¥å£ã€‚

### 1.3 æŠ€æœ¯æ¶æ„
æœ¬æ–‡æ¡£åŸºäº **å‰åç«¯åˆ†ç¦»æ¶æ„**ï¼Œè¯¦ç»†æŠ€æœ¯è§„èŒƒè¯·å‚è€ƒï¼š

ğŸ‘‰ **[\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md)**

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| å‰ç«¯ | React 18.x + TypeScript + Ant Design |
| åç«¯ | Spring Boot 3.x + Java 17 |
| è®¤è¯ | Azure Active Directory (OAuth 2.0 / OIDC) |

### 1.4 æ ¸å¿ƒåŠŸèƒ½
- æä¾›ç³»ç»Ÿè®¿é—®å…¥å£
- AzureAD ç™»å½•è®¤è¯è·³è½¬
- ä¼šè¯çŠ¶æ€ç®¡ç†

### 1.5 é€‚ç”¨èŒƒå›´
- å‰ç«¯å¼€å‘äººå‘˜ï¼ˆç™»å½•å…¥å£å®ç°ï¼‰
- åç«¯å¼€å‘äººå‘˜ï¼ˆè®¤è¯APIå¼€å‘ï¼‰
- æµ‹è¯•å·¥ç¨‹å¸ˆï¼ˆè®¤è¯æµç¨‹æµ‹è¯•ï¼‰

---

## 2. é¡µé¢å…ƒç´ 

### 2.1 å…ƒç´ æ¸…å•

| åºå· | å…ƒç´ åç§° | å…ƒç´ ç±»å‹ | åŠŸèƒ½è¯´æ˜ | äº¤äº’è§¦å‘ |
|------|----------|----------|----------|----------|
| â‘´ | AzureADã®IDï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ | æ–‡æœ¬æ ‡ç­¾ | ç™»å½•æ–¹å¼è¯´æ˜ | - |
| â‘µ | ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ | æŒ‰é’® | è§¦å‘AzureADè®¤è¯è·³è½¬ | ç‚¹å‡»â†’è·³è½¬åˆ°AzureADç™»å½•é¡µé¢ |

### 2.2 å…ƒç´ è¯¦ç»†è¯´æ˜

#### â‘´ AzureADã®IDï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å…ƒç´ ç±»å‹** | æ–‡æœ¬æ ‡ç­¾ |
| **åŠŸèƒ½æè¿°** | æ˜¾ç¤ºç™»å½•æ–¹å¼è¯´æ˜æ–‡æœ¬ |
| **å†…å®¹** | AzureADã®IDï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ |

#### â‘µ ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
| é¡¹ç›® | å†…å®¹ |
|------|------|
| **å…ƒç´ ç±»å‹** | æŒ‰é’® |
| **åŠŸèƒ½æè¿°** | è·³è½¬åˆ°AzureADç™»å½•é¡µé¢è¿›è¡Œè®¤è¯ |
| **è·³è½¬ç›®æ ‡** | AzureADç™»å½•é¡µé¢ |
| **å‰ç½®æ¡ä»¶** | æ—  |
| **ç‰¹æ®Šå¤„ç†** | è®¤è¯å…¨éƒ¨åœ¨AzureADä¾§å®Œæˆ |

---

## 3. äº¤äº’æµç¨‹

### 3.1 é¡µé¢åŠ è½½æµç¨‹
| æ­¥éª¤ | è¡Œä¸º | ç³»ç»Ÿå“åº” |
|------|------|----------|
| 1 | ç”¨æˆ·è®¿é—®ç³»ç»ŸURL | åŠ è½½b1-ã‚¹ã‚¿ãƒ¼ãƒˆé¡µé¢ |
| 2 | é¡µé¢åˆå§‹åŒ– | æ£€æŸ¥å½“å‰ä¼šè¯çŠ¶æ€ |
| 3 | ä¼šè¯æ£€æŸ¥ç»“æœ | å·²ç™»å½•â†’è·³è½¬ä¸»é¡µé¢ï¼›æœªç™»å½•â†’æ˜¾ç¤ºç™»å½•å…¥å£ |

### 3.2 ç™»å½•è®¤è¯æµç¨‹
| æ­¥éª¤ | ç”¨æˆ·æ“ä½œ | ç³»ç»Ÿå“åº” | è¯´æ˜ |
|------|----------|----------|------|
| 1 | ç‚¹å‡»ã€Œãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã€æŒ‰é’® | è·³è½¬åˆ°AzureADç™»å½•é¡µé¢ | OAuth 2.0 æˆæƒæµç¨‹ |
| 2 | åœ¨AzureADé¡µé¢è¾“å…¥å‡­è¯ | AzureADè¿›è¡Œèº«ä»½éªŒè¯ | è®¤è¯ç”±AzureADå¤„ç† |
| 3 | è®¤è¯æˆåŠŸ | AzureADé‡å®šå‘å›è°ƒ | è¿”å›æˆæƒç  |
| 4 | ç³»ç»Ÿæ¥æ”¶å›è°ƒ | äº¤æ¢æˆæƒç è·å–Token | åç«¯å¤„ç† |
| 5 | ç™»å½•æˆåŠŸ | è·³è½¬åˆ°ç³»ç»Ÿä¸»é¡µé¢ | å»ºç«‹ä¼šè¯ |

### 3.3 ä¼šè¯çŠ¶æ€å¤„ç†
| çŠ¶æ€ | æ¡ä»¶ | é¡µé¢è¡Œä¸º |
|------|------|----------|
| **å·²ç™»å½•** | å­˜åœ¨æœ‰æ•ˆä¼šè¯Token | è‡ªåŠ¨è·³è½¬åˆ°ä¸»é¡µé¢ |
| **æœªç™»å½•** | æ— æœ‰æ•ˆä¼šè¯Token | æ˜¾ç¤ºç™»å½•å…¥å£ |
| **ä¼šè¯è¿‡æœŸ** | Tokenæ— æ•ˆæˆ–è¿‡æœŸ | æ˜¾ç¤ºç™»å½•å…¥å£ |

---

## 4. ç•Œé¢è§„èŒƒ

### 4.1 é¡µé¢å¸ƒå±€
| å±æ€§ | PCç«¯å€¼ | SPç«¯å€¼ | è¯´æ˜ |
|------|--------|--------|------|
| **é¡µé¢ç±»å‹** | PC | ä¸æ”¯æŒ | â‰ªPCâ‰«æ ‡è¯† |
| **å¸ƒå±€æ–¹å¼** | å±…ä¸­æ˜¾ç¤º | - | ç®€æ´çš„ç™»å½•å…¥å£å¸ƒå±€ |
| **ä¸»è¦å†…å®¹** | ç™»å½•æŒ‰é’®åŒºåŸŸ | - | çªå‡ºæ˜¾ç¤ºè®¤è¯å…¥å£ |

### 4.2 è§†è§‰è§„èŒƒ

#### æŒ‰é’®æ ·å¼ï¼ˆb1ç‰¹å®šï¼‰
| çŠ¶æ€ | èƒŒæ™¯è‰² | æ–‡å­—é¢œè‰² | è¾¹æ¡† |
|------|--------|----------|------|
| **é»˜è®¤** | #1890FF | #FFFFFF | æ—  |
| **æ‚¬åœ** | #40A9FF | #FFFFFF | æ—  |
| **ç‚¹å‡»** | #096DD9 | #FFFFFF | æ—  |
| **ç¦ç”¨** | #D9D9D9 | #FFFFFF | æ—  |

### 4.3 é¡µé¢å†…å®¹

#### æ©Ÿèƒ½æ¦‚è¦
- æœ¬ã‚·ã‚¹ãƒ†ãƒ ã«URLã‚ˆã‚Šã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã€ã¯ã˜ã‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ç”»é¢
- æœ¬ç”»é¢ã‹ã‚‰AzureADå´ã®ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»ã§ãã‚‹

#### é‡è¦æç¤º
- ã“ã®ç”»é¢ã‹ã‚‰æœ¬ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã¯ã§ããšã€ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ã¯ã™ã¹ã¦AzureADå´ã§è¡Œã†

---

## 5. è®¤è¯é›†æˆ

### 5.1 AzureADè®¤è¯é…ç½®

#### OAuth 2.0 æµç¨‹
| å‚æ•° | å€¼ |
|------|-----|
| **æˆæƒç«¯ç‚¹** | Azure AD é…ç½®çš„æˆæƒURL |
| **ä»¤ç‰Œç«¯ç‚¹** | Azure AD é…ç½®çš„ä»¤ç‰ŒURL |
| **å®¢æˆ·ç«¯ID** | Azure AD æ³¨å†Œçš„åº”ç”¨ID |
| **é‡å®šå‘URI** | ç³»ç»Ÿé…ç½®çš„å›è°ƒURL |
| **ä½œç”¨åŸŸ** | openid profile email |

### 5.2 è®¤è¯çŠ¶æ€ç®¡ç†ï¼ˆçº¯å‰ç«¯JWTæ–¹æ¡ˆï¼‰

#### ä¼šè¯å¤„ç†
| çŠ¶æ€ | å¤„ç†æ–¹å¼ |
|------|----------|
| **ç™»å½•æˆåŠŸ** | å­˜å‚¨AccessTokenï¼ˆå†…å­˜ï¼‰å’ŒRefreshTokenï¼ˆHttpOnly Cookieï¼‰ |
| **ç”¨æˆ·ä¿¡æ¯è·å–** | ä»AccessTokenï¼ˆJWTï¼‰è§£æç”¨æˆ·ä¿¡æ¯ï¼Œæ— éœ€æŸ¥è¯¢æ•°æ®åº“ |
| **Tokenåˆ·æ–°** | ä½¿ç”¨RefreshTokenæ¢å–æ–°AccessToken |
| **ç™»å‡º** | å‰ç«¯æ¸…é™¤Tokenï¼Œåç«¯å¯é€‰æ¸…é™¤Redisé»‘åå• |
| **ä¼šè¯è¶…æ—¶** | æ£€æŸ¥JWTè¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸåè‡ªåŠ¨è·³è½¬ç™»å½• |

#### JWT Tokenç»“æ„
```json
{
  "sub": "user123",
  "unique_name": "user@example.com",
  "name": "å±±ç”°å¤ªéƒ",
  "role": "ç™ºæ³¨æ‹…å½“",
  "groups": ["base-users"],
  "exp": 1704067200,
  "aud": "your-client-id",
  "iss": "https://login.microsoftonline.com/your-tenant-id"
}
```

### 5.3 å®‰å…¨è§„èŒƒ

#### Tokenç®¡ç†
| é¡¹ç›® | è§„èŒƒ |
|------|------|
| **AccessToken** | å­˜å‚¨äºå†…å­˜ï¼ˆMemoryï¼‰ï¼Œé¡µé¢åˆ·æ–°åä»Cookieåˆ·æ–°è·å– |
| **RefreshToken** | å­˜å‚¨äºHttpOnly Cookieï¼Œé˜²æ­¢XSSæ”»å‡» |
| **Tokenæœ‰æ•ˆæœŸ** | æ ¹æ®AzureADé…ç½®ï¼ˆé€šå¸¸Access Token 1å°æ—¶ï¼ŒRefresh Token 90å¤©ï¼‰ |
| **HTTPS** | å…¨æµç¨‹å¼ºåˆ¶ä½¿ç”¨HTTPS |
| **JWTéªŒè¯** | åç«¯éªŒè¯ç­¾åã€è¿‡æœŸæ—¶é—´ã€ç­¾å‘è€… |

#### å‰ç«¯Tokenç®¡ç†ç­–ç•¥
```typescript
// AccessTokenå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆé¿å…XSSï¼‰
let accessToken: string | null = null;

// RefreshTokenå­˜å‚¨åœ¨HttpOnly Cookieä¸­ï¼ˆé˜²æ­¢XSSï¼‰
// é€šè¿‡åç«¯è®¾ç½® Cookie: refresh_token=xxx; HttpOnly; Secure; SameSite=Strict

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥Token
function checkAuthStatus(): boolean {
  const decoded = jwtDecode(accessToken);
  return decoded.exp > Date.now() / 1000;
}
```

---

## 6. è®¾å¤‡é€‚é…

### 6.1 PCç«¯é€‚é…
| ç‰¹æ€§ | å®ç°æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| **å®Œæ•´åŠŸèƒ½** | å®Œå…¨æ”¯æŒ | æä¾›å®Œæ•´ç™»å½•å…¥å£ |
| **å“åº”å¼å¸ƒå±€** | è‡ªé€‚åº” | å±…ä¸­æ˜¾ç¤º |
| **æµè§ˆå™¨å…¼å®¹** | ç°ä»£æµè§ˆå™¨ | Chrome/Edge/Firefox/Safari |

### 6.2 SPç«¯é€‚é…
| ç‰¹æ€§ | å®ç°æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| **ä¸æ”¯æŒ** | ä¸æ¸²æŸ“/éšè— | â‰ªPCâ‰«æ ‡è¯† |
| **æ›¿ä»£æ–¹æ¡ˆ** | å“åº”å¼è®¾è®¡ | ç§»åŠ¨ç«¯æµè§ˆå™¨è®¿é—®PCç‰ˆæœ¬ |

---

## 7. æ•°æ®åº“è®¾è®¡

### 7.1 ç”¨æˆ·è¡¨ç»“æ„

è¯¦ç»†æ•°æ®åº“è®¾è®¡è¯·å‚è€ƒï¼š

ğŸ‘‰ **[\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md#5-æ•°æ®åº“è®¾è®¡è§„èŒƒ)**

### 7.2 b1ç›¸å…³å­—æ®µ
```sql
-- ç”¨æˆ·è¡¨ï¼ˆç”¨äºå­˜å‚¨åŸºç¡€ç”¨æˆ·ä¿¡æ¯ï¼‰
CREATE TABLE m_user (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(20) NOT NULL UNIQUE,
    user_name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    role_id VARCHAR(20),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ³¨ï¼šæœ¬ç³»ç»Ÿé‡‡ç”¨çº¯å‰ç«¯ä¼šè¯ç®¡ç†æ–¹æ¡ˆï¼ˆJWTæ— çŠ¶æ€ï¼‰
-- ä¸éœ€è¦ s_session è¡¨ï¼Œç”¨æˆ·ä¿¡æ¯ä» AzureAD è¿”å›çš„ JWT Token ä¸­è§£æ
```

### 7.5 ç”»é¢-æ¥å£-æ•°æ®åº“å…³ç³»æ˜ å°„

| ç”»é¢å…ƒç´  | APIæ¥å£ | æ¥å£åŠŸèƒ½è¯´æ˜ | ç›¸å…³æ•°æ®åº“è¡¨ | å­—æ®µå…³ç³» |
|----------|---------|--------------|--------------|----------|
| **é¡µé¢åŠ è½½** | (å‰ç«¯ç›´æ¥æ£€æŸ¥) | ä»å†…å­˜ä¸­æ£€æŸ¥AccessTokenï¼Œè§£æJWTéªŒè¯æ˜¯å¦è¿‡æœŸ | æ—  | accessToken â†’ è§£æJWT (sub, name, role, exp) |
| **ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹æŒ‰é’®** | (å‰ç«¯ç›´æ¥è·³è½¬) | è·³è½¬åˆ°AzureADæˆæƒé¡µé¢ï¼Œæºå¸¦OAuthå‚æ•° | - | client_id, redirect_uri, scope, state |
| **AzureADå›è°ƒ** | POST /api/v1/auth/callback | æ¥æ”¶æˆæƒç ï¼Œäº¤æ¢Tokenï¼Œè®¾ç½®HttpOnly Cookie | m_user | code â†’ access_token, refresh_token â†’ è®¾ç½®Cookie |
| **è®¤è¯æˆåŠŸåè·³è½¬** | (å‰ç«¯JWTè§£æ) | ä»AccessTokenè§£æç”¨æˆ·ä¿¡æ¯ï¼Œè·³è½¬ä¸»é¡µé¢ | m_user (å¯é€‰) | JWTè§£æ: user_id, user_name, email, role_id |
| **ç™»å‡º** | POST /api/v1/auth/logout | æ¸…é™¤HttpOnly Cookieï¼ˆRefreshTokenï¼‰ï¼Œå‰ç«¯æ¸…é™¤å†…å­˜Token | æ—  | æ¸…é™¤Cookie refresh_tokenï¼Œæ¸…ç©ºå†…å­˜accessToken |
| **Tokenåˆ·æ–°** | POST /api/v1/auth/refresh | ä½¿ç”¨HttpOnly Cookieä¸­çš„RefreshTokenæ¢å–æ–°AccessToken | æ—  | refresh_token (Cookie) â†’ æ–°access_token |

#### å…³ç³»è¯´æ˜

1. **é¡µé¢åŠ è½½æµç¨‹ï¼ˆçº¯å‰ç«¯ï¼‰**
   - å‰ç«¯ä»å†…å­˜ä¸­è¯»å– `accessToken`
   - ä½¿ç”¨ `jwtDecode` è§£æJWTï¼Œæ£€æŸ¥ `exp` è¿‡æœŸæ—¶é—´
   - å¦‚æœTokenæœ‰æ•ˆï¼Œè·³è½¬ä¸»é¡µé¢
   - å¦‚æœTokenæ— æ•ˆæˆ–ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºç™»å½•å…¥å£
   - **æ— éœ€è°ƒç”¨åç«¯API**

2. **ç™»å½•è®¤è¯æµç¨‹**
   - ç‚¹å‡»æŒ‰é’® â†’ å‰ç«¯æ„é€ OAuth URLå¹¶è·³è½¬åˆ°AzureAD
   - AzureADå›è°ƒ â†’ `POST /api/v1/auth/callback`
   - åç«¯æ¥æ”¶ `code` å‚æ•°ï¼Œè°ƒç”¨AzureAD Tokenç«¯ç‚¹
   - è·å– `access_token` (JWT) å’Œ `refresh_token`
   - åç«¯å°† `refresh_token` è®¾ç½®ä¸º **HttpOnly Cookie**
   - åç«¯å°† `access_token` è¿”å›ç»™å‰ç«¯
   - å‰ç«¯å°† `access_token` å­˜å‚¨åœ¨ **å†…å­˜** ä¸­
   - å¯é€‰ï¼šåç«¯ä»AzureADè·å–ç”¨æˆ·ä¿¡æ¯ï¼ŒåŒæ­¥åˆ° `m_user` è¡¨

3. **ç”¨æˆ·ä¿¡æ¯è·å–ï¼ˆJWTè§£æï¼‰**
   - å‰ç«¯ä»å†…å­˜çš„ `accessToken` ä¸­è§£æJWT
   - JWTåŒ…å«ï¼š`sub` (userId), `name` (userName), `unique_name` (email), `role` (roleId)
   - **æ— éœ€è°ƒç”¨åç«¯API** æˆ–æŸ¥è¯¢æ•°æ®åº“
   - å¯é€‰ï¼šè°ƒç”¨ `GET /api/v1/auth/userinfo` è·å–é¢å¤–ä¿¡æ¯

4. **ç™»å‡ºæµç¨‹**
   - å‰ç«¯è°ƒç”¨ `POST /api/v1/auth/logout`
   - å‰ç«¯æ¸…é™¤å†…å­˜ä¸­çš„ `accessToken`
   - åç«¯æ¸…é™¤HttpOnly Cookieä¸­çš„ `refresh_token`
   - è·³è½¬å› b1-ã‚¹ã‚¿art

#### æ•°æ®æµç¤ºæ„

```
å‰ç«¯ (b1-ã‚¹ã‚¿ãƒ¼ãƒˆ - React)
    â”‚
    â”œâ”€ [åŠ è½½é¡µé¢] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ£€æŸ¥å†…å­˜ accessToken
    â”‚                              â”‚
    â”‚                              â””â”€â†’ jwtDecode(accessToken)
    â”‚                                  â””â”€â†’ æ£€æŸ¥ exp æ˜¯å¦è¿‡æœŸ
    â”‚                                      â”œâ”€ æœ‰æ•ˆ â†’ è·³è½¬ä¸»é¡µé¢
    â”‚                                      â””â”€ æ— æ•ˆ â†’ æ˜¾ç¤ºç™»å½•å…¥å£
    â”‚
    â”œâ”€ [ç‚¹å‡»ç™»å½•] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è·³è½¬ AzureAD
    â”‚                              â”‚
    â”‚                              â””â”€â†’ å‚æ•°: client_id, redirect_uri, scope, state
    â”‚
    â”œâ”€ [AzureADå›è°ƒ] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ POST /api/v1/auth/callback
    â”‚                              â”‚
    â”‚                              â”œâ”€â†’ æ¥æ”¶ code, state
    â”‚                              â”œâ”€â†’ äº¤æ¢ Token (AzureAD)
    â”‚                              â”œâ”€â†’ è¿”å› access_token (JWT)
    â”‚                              â””â”€â†’ è®¾ç½® HttpOnly Cookie (refresh_token)
    â”‚                                  å‰ç«¯å­˜å‚¨ access_token åˆ°å†…å­˜
    â”‚
    â”œâ”€ [è·å–ç”¨æˆ·ä¿¡æ¯] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è§£æ JWT (å‰ç«¯)
    â”‚                              â”‚
    â”‚                              â””â”€â†’ jwtDecode(accessToken)
    â”‚                                  â”œâ”€ sub: user_id
    â”‚                                  â”œâ”€ name: user_name
    â”‚                                  â”œâ”€ unique_name: email
    â”‚                                  â”œâ”€ role: role_id
    â”‚                                  â””â”€ exp: è¿‡æœŸæ—¶é—´
    â”‚
    â”œâ”€ [Tokenåˆ·æ–°] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ POST /api/v1/auth/refresh
    â”‚                              â”‚
    â”‚                              â”œâ”€â†’ Cookie: refresh_token
    â”‚                              â””â”€â†’ è¿”å› æ–° access_token
    â”‚
    â””â”€ [ç™»å‡º] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ POST /api/v1/auth/logout
                                   â”‚
                                   â”œâ”€â†’ å‰ç«¯æ¸…ç©ºå†…å­˜ accessToken
                                   â””â”€â†’ åç«¯æ¸…é™¤ Cookie refresh_token
```

#### JWTæ— çŠ¶æ€ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **æ— åç«¯ä¼šè¯** | ä¸éœ€è¦ `s_session` è¡¨ï¼Œåç«¯æ— çŠ¶æ€ |
| **é«˜æ€§èƒ½** | æ— éœ€æ¯æ¬¡è¯·æ±‚æŸ¥è¯¢æ•°æ®åº“ |
| **æ˜“äºæ‰©å±•** | åç«¯å¯ä»¥æ°´å¹³æ‰©å±•ï¼Œæ— éœ€å…±äº«ä¼šè¯çŠ¶æ€ |
| **æ ‡å‡†è®¾è®¡** | ç¬¦åˆOAuth 2.0 / OIDCæ ‡å‡† |
| **ç®€åŒ–æ¶æ„** | å‰ç«¯ç›´æ¥ä»JWTè·å–ç”¨æˆ·ä¿¡æ¯ |

---

## 8. APIæ¥å£è®¾è®¡

### 8.1 è®¤è¯API

è¯¦ç»†APIè®¾è®¡è¯·å‚è€ƒï¼š

ğŸ‘‰ **[\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md#4-apiæ¥å£è§„èŒƒ)**

### 8.2 b1ç‰¹å®šæ¥å£
```yaml
# AzureADå›è°ƒå¤„ç†ï¼ˆå‰ç«¯ç›´æ¥è°ƒç”¨AzureADï¼Œåç«¯å¤„ç†å›è°ƒï¼‰
POST /api/v1/auth/callback
Content-Type: application/x-www-form-urlencoded
Body: { code, state }
Response: { access_token, refresh_token, expires_in, user_info }

# Tokenåˆ·æ–°
POST /api/v1/auth/refresh
Content-Type: application/json
Body: { refresh_token }
Response: { access_token, expires_in }

# ç™»å‡ºï¼ˆå‰ç«¯æ¸…é™¤Tokenå³å¯ï¼Œåç«¯å¯é€‰å¤„ç†ï¼‰
POST /api/v1/auth/logout
Authorization: Bearer {token}
Response: { success: true }

# è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆä»JWTè§£æï¼Œæ­¤æ¥å£å¯é€‰ï¼‰
GET /api/v1/auth/userinfo
Authorization: Bearer {token}
Response: { user_id, user_name, email, role_id }
```

---

## 9. å‰ç«¯å®ç°

### 9.1 ç™»å½•ç»„ä»¶

è¯¦ç»†å‰ç«¯æ¶æ„è¯·å‚è€ƒï¼š

ğŸ‘‰ **[\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md#2-å‰ç«¯æ¶æ„è§„èŒƒ)**

### 9.2 b1ç‰¹å®šç»„ä»¶
```typescript
// b1ç™»å½•å…¥å£ç»„ä»¶
import React, { useEffect } from 'react';
import { Button } from 'antd';
import { LoginOutlined } from '@ant-design/icons';
import { useNavigate } from 'react-router-dom';
import { jwtDecode } from 'jwt-decode';
import { useAuthStore } from '@/stores/authStore';

export const B1StartPage: React.FC = () => {
  const navigate = useNavigate();
  const { setAccessToken, setUserInfo, logout } = useAuthStore();

  // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
  useEffect(() => {
    const checkAuth = () => {
      const accessToken = useAuthStore.getState().accessToken;

      if (accessToken) {
        try {
          const decoded: any = jwtDecode(accessToken);

          if (decoded.exp > Date.now() / 1000) {
            // Tokenæœ‰æ•ˆï¼Œè·³è½¬åˆ°ä¸»é¡µé¢
            navigate('/dashboard');
          } else {
            // Tokenè¿‡æœŸï¼Œæ¸…é™¤çŠ¶æ€
            logout();
          }
        } catch (error) {
          logout();
        }
      }
    };

    checkAuth();
  }, [navigate, logout]);

  // ç™»å½•æŒ‰é’®ç‚¹å‡»å¤„ç†
  const handleLogin = () => {
    const state = generateRandomString(32);
    sessionStorage.setItem('oauth_state', state);

    const authUrl = `${azureAdConfig.authorizationEndpoint}?` +
      `client_id=${azureAdConfig.clientId}&` +
      `redirect_uri=${encodeURIComponent(azureAdConfig.redirectUri)}&` +
      `response_type=code&` +
      `scope=${encodeURIComponent(azureAdConfig.scopes)}&` +
      `state=${state}`;

    window.location.href = authUrl;
  };

  return (
    <div className="b1-start-container">
      <div className="login-section">
        <h2>ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <p>AzureADã®IDï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</p>
        <Button
          type="primary"
          size="large"
          icon={<LoginOutlined />}
          onClick={handleLogin}
        >
          ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
        </Button>
      </div>
      <div className="notice">
        <p>ã“ã®ç”»é¢ã‹ã‚‰æœ¬ã‚·ã‚¹ãƒ†ãƒ ã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã¯ã§ããšã€</p>
        <p>ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ã¯ã™ã¹ã¦AzureADå´ã§è¡Œã„ã¾ã™</p>
      </div>
    </div>
  );
};

// JWTç”¨æˆ·ä¿¡æ¯è§£æ
interface JwtPayload {
  sub: string;
  unique_name: string;
  name: string;
  role: string;
  exp: number;
}

export function parseUserInfoFromToken(token: string) {
  const decoded = jwtDecode<JwtPayload>(token);
  return {
    userId: decoded.sub,
    email: decoded.unique_name,
    userName: decoded.name,
    roleId: decoded.role,
    expiresAt: decoded.exp
  };
}

function generateRandomString(length: number): string {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}
```

### 9.3 Tokenç®¡ç†Hook
```typescript
// useAuth.ts - è‡ªå®šä¹‰Hookç®¡ç†Token
import { useEffect, useState, useCallback } from 'react';
import { jwtDecode } from 'jwt-decode';

export function useAuth() {
  const [accessToken, setAccessToken] = useState<string | null>(null);
  const [userInfo, setUserInfo] = useState<any>(null);

  // è®¾ç½®Tokenå¹¶è§£æç”¨æˆ·ä¿¡æ¯
  const login = useCallback((token: string) => {
    setAccessToken(token);
    const decoded = jwtDecode(token);
    setUserInfo({
      userId: decoded.sub,
      userName: decoded.name,
      email: decoded.unique_name,
      role: decoded.role,
      expiresAt: decoded.exp
    });
  }, []);

  // ç™»å‡º
  const logout = useCallback(() => {
    setAccessToken(null);
    setUserInfo(null);
    // æ¸…é™¤HttpOnly Cookieä¸­çš„RefreshTokenï¼ˆéœ€è¦åç«¯é…åˆï¼‰
    fetch('/api/v1/auth/logout', { method: 'POST' });
  }, []);

  // Tokenè¿‡æœŸæ£€æµ‹
  useEffect(() => {
    if (!accessToken) return;

    const decoded = jwtDecode(accessToken);
    const expiresAt = decoded.exp * 1000;
    const timeUntilExpiry = expiresAt - Date.now();

    // æå‰5åˆ†é’Ÿåˆ·æ–°Token
    if (timeUntilExpiry < 5 * 60 * 1000) {
      refreshToken();
    }

    const timer = setTimeout(() => {
      logout();
    }, timeUntilExpiry);

    return () => clearTimeout(timer);
  }, [accessToken, logout]);

  // åˆ·æ–°Token
  const refreshToken = async () => {
    try {
      const response = await fetch('/api/v1/auth/refresh', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include'
      });
      const data = await response.json();
      if (data.access_token) {
        login(data.access_token);
      }
    } catch (error) {
      logout();
    }
  };

  return { accessToken, userInfo, login, logout, isAuthenticated: !!accessToken };
}
```

---

## 10. éªŒæ”¶æ ‡å‡†

### 10.1 åŠŸèƒ½éªŒæ”¶
- [ ] é¡µé¢æ­£ç¡®æ˜¾ç¤ºç™»å½•å…¥å£
- [ ] ç‚¹å‡»ç™»å½•æŒ‰é’®è·³è½¬åˆ°AzureAD
- [ ] AzureADè®¤è¯å®Œæˆåæ­£ç¡®å›è°ƒ
- [ ] è®¤è¯æˆåŠŸè·³è½¬åˆ°ä¸»é¡µé¢
- [ ] å·²ç™»å½•ç”¨æˆ·ä¸æ˜¾ç¤ºç™»å½•å…¥å£

### 10.2 è§†è§‰éªŒæ”¶
- [ ] å¸ƒå±€ä¸è®¾è®¡ç¨¿ä¸€è‡´
- [ ] æŒ‰é’®æ ·å¼æ­£ç¡®
- [ ] æç¤ºæ–‡å­—æ­£ç¡®æ˜¾ç¤º

### 10.3 æ€§èƒ½éªŒæ”¶
- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 1ç§’
- [ ] ç™»å½•è·³è½¬å“åº”æ—¶é—´ < 0.5ç§’
- [ ] æ— ç™½å±æˆ–é—ªçƒ

### 10.4 å®‰å…¨éªŒæ”¶
- [ ] å…¨æµç¨‹HTTPS
- [ ] Tokenå®‰å…¨å­˜å‚¨
- [ ] é˜²æ­¢CSRFæ”»å‡»
- [ ] é˜²æ­¢XSSæ”»å‡»

---

## 11. å˜æ›´æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2026-02-10| v1.0.1 | åˆå§‹ç‰ˆæœ¬ï¼Œé‡‡ç”¨çº¯å‰ç«¯JWTæ— çŠ¶æ€ä¼šè¯ç®¡ç†æ–¹æ¡ˆ | - |

---

## é™„å½•

### A.1 ç›¸å…³æ–‡æ¡£
| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ | [\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md) | å‰åç«¯æŠ€æœ¯æ¶æ„è¯¦ç»†è§„èŒƒ |
| b0-å¯¼èˆªèœå• | [../b0-å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³/05_è®¾è®¡è§„èŒƒ.md](../b0-å…±é€šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³/05_è®¾è®¡è§„èŒƒ.md) | å¯¼èˆªèœå•è®¾è®¡è§„èŒƒ |
| ç”»é¢é·ç§»å›³è®¾è®¡è§„èŒƒ | [../ç”»é¢é·ç§»å›³/05_è®¾è®¡è§„èŒƒ.md](../ç”»é¢é·ç§»å›³/05_è®¾è®¡è§„èŒƒ.md) | å¯¼èˆªæµç¨‹è®¾è®¡è§„èŒƒ |

### A.2 ä¸p1-ã‚¹ã‚¿ãƒ¼ãƒˆå¯¹æ¯”
| ç‰¹æ€§ | b1-ã‚¹ã‚¿ãƒ¼ãƒˆ | p1-ã‚¹ã‚¿ãƒ¼ãƒˆ |
|------|-------------|-------------|
| **ç”¨æˆ·ç±»å‹** | ãƒ™ãƒ¼ã‚¹ | è¼¸é€ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ |
| **è®¾å¤‡æ”¯æŒ** | PCã®ã¿ | PC/SP |
| **è®¤è¯æ–¹å¼** | AzureAD | AzureAD |

---

**æ–‡æ¡£ç¼–åˆ¶**: -  
**ç¼–åˆ¶æ—¶é—´**: 2026-02-XX 
**é€‚ç”¨èŒƒå›´**: åˆ¥ç´™_ç”»é¢ä¸€è¦§_v151.xlsx - b1-ã‚¹ã‚¿ãƒ¼ãƒˆ  
**äº¤å‰å¼•ç”¨**: [\_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md](../_å…¬å…±æŠ€æœ¯æ¶æ„è§„èŒƒ.md)
