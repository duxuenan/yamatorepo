# b6-被請求管理 - 设计规范

## 1. 功能概述

### 1.1 文档信息
| 项目 | 内容 |
|------|------|
| **工作表名称** | b6-被請求管理 |
| **界面编号** | b6 |
| **文档版本** | v1.0.1 |
| **最后更新** | 2026-02-10|
| **文档状态** | ✅ 已发布 |

### 1.2 功能描述
b6-被請求管理 是账单管理页面，提供被请求信息列表展示、账单下载和状态管理功能。

### 1.3 技术架构
本文档基于 **前后端分离架构**，详细技术规范请参考：

👉 **[\_公共技术架构规范.md](../_公共技术架构规范.md)**

| 层级 | 技术 |
|------|------|
| 前端 | React 18.x + TypeScript + Ant Design |
| 后端 | Spring Boot 3.x + Java 17 |

### 1.4 核心功能
- 被請求情報一覧表示
- 請求書ダウンロード
- ステータス管理
- 詳細ページ跳转

### 1.5 适用范围
- 前端开发人员（账单管理组件实现）
- 后端开发人员（账单API开发）
- 测试工程师（账单功能测试）

---

## 2. 页面元素

### 2.1 元素清单

| 序号 | 元素名称 | 元素类型 | 功能说明 | 交互触发 |
|------|----------|----------|----------|----------|
| ⑴ | 被請求年月 | プルダウン | 选择対象年月 | 选择触发 |
| ⑵ | 会社コード | 入力 | 会社コード | 文本输入 |
| ⑶ | 会社名 | 入力 | 会社名 | 文本输入 |
| ⑷ | ステータス | プルダウン | ステータス | 选择触发 |
| ⑸ | チェックボックス | Checkbox | 选择账单 | 批量操作 |
| ⑹ | 会社コード | リンク | 公司代码 | 点击→b7 |
| ⑺ | 会社名 | テキスト | 公司名称 | 显示 |
| ⑻ | ステータス | タグ | 請求状態 | 显示 |
| ⑼ | 金額チェック | タグ | OK/NG/- | 显示 |
| ⑽ | 実績合計金額 | テキスト | 金額 | 显示 |
| ⑾ | 請求書合計金額 | テキスト | 金額 | 显示 |
| ⑿ | 金額差分 | テキスト | 差分 | 显示 |
| ⒀ | ファイル名 | リンク | ファイル名 | プレビュー |
| ⒁ | プレビュー | リンク | 预览 | 点击→弹窗 |
| ⒂ | 請求書ダウンロード | ボタン | 下载账单 | 点击→下载 |

---

## 3. 交互流程

### 3.1 页面加载流程
| 步骤 | 行为 | 系统响应 |
|------|------|----------|
| 1 | 页面初始化 | 检查登录状态 |
| 2 | 获取账单数据 | 查询確定した実績 |
| 3 | 数据判断 | 有数据→显示列表；无数据→显示空提示 |

### 3.2 筛选流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 输入筛选条件 | 被請求年月/コード/名前/ステータス |
| 2 | 执行筛选 | 查询数据库 |
| 3 | 显示结果 | 列表展示匹配数据 |

### 3.3 下载流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 选中账单 | チェックボックス |
| 2 | 点击下载按钮 | 验证选中状态 |
| 3 | 生成文件 | 下载文件/打包ZIP |

### 3.4 状态变更流程
| 步骤 | 用户操作 | 系统响应 |
|------|----------|----------|
| 1 | 选中账单 | チェックボックス |
| 2 | 点击状态变更 | 验证状态条件 |
| 3 | 更新状态 | 更新数据库 |
| 4 | 刷新列表 | 显示更新结果 |

---

## 4. 界面规范

### 4.1 页面布局
| 属性 | PC端值 | SP端值 | 说明 |
|------|--------|--------|------|
| **页面类型** | PC | 不支持 | ≪PC≫标识 |
| **布局方式** | 上部筛选+中部列表+下部操作 | - | 三段式布局 |

### 4.2 状态颜色
| 状态 | 颜色 | 说明 |
|------|------|------|
| 未提出 | 灰色 | 未上传 |
| 要確認 | 橙色 | 需确认 |
| チェック未 | 黄色 | 未检查 |
| チェック済 | 蓝色 | 已检查 |
| 請求完了 | 绿色 | 完成 |

### 4.3 金额检查颜色
| 状态 | 颜色 | 说明 |
|------|------|------|
| OK | 绿色 | 金额一致 |
| NG | 红色 | 金额不一致 |
| - | 灰色 | 无账单 |

---

## 5. API接口设计

### 5.1 账单查询API
```yaml
# 被请求列表查询
GET /api/v1/billing/search
Authorization: Bearer {token}

# Query Parameters
- year_month: string (YYYY-MM)
- company_code: string
- company_name: string
- status: string
- page: integer
- page_size: integer
```

### 5.2 下载API
```yaml
# 单个账单预览
GET /api/v1/billing/{billingId}/preview
Authorization: Bearer {token}

# 选中账单下载
POST /api/v1/billing/download
Authorization: Bearer {token}
Body: { billingIds: [...] }

# 批量下载
POST /api/v1/billing/download/all
Authorization: Bearer {token}
Body: { status: "チェック済" }
```

### 5.3 状态变更API
```yaml
# 选中账单状态变更
POST /api/v1/billing/status
Authorization: Bearer {token}
Body: { billingIds: [...], status: "請求完了" }

# 批量状态变更
POST /api/v1/billing/status/all
Authorization: Bearer {token}
Body: { status: "請求完了" }
```

### 5.4 画面-API-数据库关系映射

#### 5.4.1 关系总览表

| 画面元素 | API接口 | 接口功能说明 | 相关数据库表 | 字段关系 |
|----------|---------|-------------|-------------|----------|
| **页面加载** | | | | |
| 页面初始化 | GET /api/v1/billing/search | 获取账单列表数据 | t_billing | year_month, company_code, company_name, status, amount_check, performance_total_amount, billing_total_amount, amount_difference, file_name |
| | | | m_partner | company_code → company_code, company_name |
| | | | t_billing_file | billing_id → file_name, file_path |
| | | | t_billing_action_log | billing_id → latest_action_datetime, latest_action_by |
| **筛选条件区** | | | | |
| ⑴ 被請求年月 | GET /api/v1/billing/search | 按年月筛选账单 | t_billing | year_month (YYYY-MM) |
| ⑵ 会社コード | GET /api/v1/billing/search | 按公司代码筛选 | t_billing | company_code (模糊匹配) |
| | | | m_partner | company_code → company_name |
| ⑶ 会社名 | GET /api/v1/billing/search | 按公司名筛选 | t_billing | company_name (模糊匹配) |
| | | | m_partner | company_name |
| ⑷ ステータス | GET /api/v1/billing/search | 按状态筛选 | t_billing | status (未提出/要確認/チェック未/チェック済/請求完了) |
| **被請求一覧区** | | | | |
| 列表数据加载 | GET /api/v1/billing/search | 分页查询账单列表 | t_billing | 所有显示字段 |
| | | | m_partner | partner_id → company_code, company_name |
| | | | t_billing_file | billing_id → file_name, file_path |
| | | | t_billing_action_log | billing_id → latest_action_datetime, latest_action_by |
| ⑸ チェックボックス | - | 选择账单（前端管理） | - | - |
| ⑹ 会社コード（リンク） | GET /api/v1/billing/search | 显示并可点击跳转 | t_billing | billing_id, company_code |
| | 点击跳转 | - | 跳转到b7-被請求詳細 | - | 携带billingId |
| ⑺ 会社名 | GET /api/v1/billing/search | 显示公司名称 | m_partner | company_name |
| ⑻ ステータス（タグ） | GET /api/v1/billing/search | 显示请求状态 | t_billing | status (带颜色Tag) |
| ⑼ 金額チェック（タグ） | GET /api/v1/billing/search | 显示金额核对结果 | t_billing | amount_check (OK/NG/-) |
| | | | t_performance_summary | performance_total_amount (実績合計金額) |
| | | | t_billing_ocr | billing_ocr_amount (OCR読み取り金額) |
| ⑽ 実績合計金額 | GET /api/v1/billing/search | 显示系统保持的实绩总额 | t_performance_summary | performance_total_amount |
| | | | t_billing | billing_id → t_performance_summary |
| ⑾ 請求書合計金額 | GET /api/v1/billing/search | 显示OCR读取的账单总额 | t_billing_ocr | billing_ocr_amount |
| | | | t_billing | billing_id → t_billing_ocr |
| ⑿ 金額差分 | GET /api/v1/billing/search | 显示金额差分 | t_billing | amount_difference (計算: 実績合計 - 請求書合計) |
| ⒀ ファイル名 | GET /api/v1/billing/search |显示上传的账单文件名 | t_billing_file | file_name |
| | | | t_billing | billing_id → t_billing_file |
| | プレビュー | GET /api/v1/billing/{billingId}/preview | 预览账单文件 | t_billing_file | file_path |
| ⒁ アクション履歴 | GET /api/v1/billing/search | 显示最新操作记录 | t_billing_action_log | action_datetime, action_type, action_by |
| | | | m_user | action_by → user_name |
| ⒂ 更新日時 | GET /api/v1/billing/search | 显示最后操作时间 | t_billing_action_log | latest_action_datetime |
| ⒃ 更新者 | GET /api/v1/billing/search | 显示最后操作用户 | t_billing_action_log | latest_action_by |
| | | | m_user | action_by → user_name |
| **下载功能区** | | | | |
| ⒄ チェックのみダウンロード | POST /api/v1/billing/download | 下载选中账单 | t_billing_file | file_path, file_name |
| | | | t_billing | billing_id (来自前端选中的billingIds) |
| | | | t_billing_ocr | billing_ocr_amount (若有OCR数据) |
| ⒅ 一括ダウンロード | POST /api/v1/billing/download/all | 批量下载チェック済账单 | t_billing_file | file_path, file_name |
| | | | t_billing | status = "チェック済" |
| | | | - | 前端打包ZIP |
| **ステータス变更区** | | | | |
| ⒆ チェックのみステータス変更 | POST /api/v1/billing/status | 选中项状态变更 | t_billing | billing_id (来自前端选中的billingIds) |
| | | | t_billing | status → "請求完了" |
| | | | t_billing_action_log | 插入状态变更记录 (action_type="ステータス変更", action_detail="チェック済→請求完了") |
| | | | t_bizintegral_upload | 插入ビズインテグラル上传记录 (status="手動アップロード") |
| ⒇ 一括ステータス変更 | POST /api/v1/billing/status/all | 批量状态变更 | t_billing | status = "チェック済" → "請求完了" |
| | | | t_billing_action_log | 批量插入状态变更记录 |
| | | | t_bizintegral_upload | 批量插入ビズインテグラル上传记录 |

#### 5.4.2 关系说明

**1. 页面加载流程**

```
页面初始化 (b6-被請求管理)
         ↓
GET /api/v1/billing/search
         ↓
后端查询: t_billing (主表)
         ↓
关联查询: m_partner (获取公司信息)
关联查询: t_billing_file (获取文件信息)
关联查询: t_billing_action_log (获取最新操作记录)
关联查询: t_billing_ocr (获取OCR金额)
关联查询: t_performance_summary (获取实绩金额)
         ↓
计算逻辑:
  - 金額チェック: IF(OCR金额 = 实绩金额, "OK", IF(OCR金额存在, "NG", "-"))
  - 金額差分: 実績合計金額 - OCR読み取り金額
         ↓
返回JSON给前端
         ↓
前端渲染:
  - 筛选条件区
  - 被請求一覧区（12字段）
  - 操作按钮区
```

**2. 筛选流程**

```
用户输入筛选条件
         ↓
[被請求年月] + [会社コード] + [会社名] + [ステータス]
         ↓
GET /api/v1/billing/search
Query Parameters:
  - year_month: "2026-02"
  - company_code: "0001"
  - company_name: "运输"
  - status: "チェック済"
         ↓
后端查询: t_billing (WHERE year_month = ? AND company_code LIKE ? AND company_name LIKE ? AND status = ?)
         ↓
关联查询: m_partner, t_billing_file, t_billing_action_log
         ↓
返回筛选结果
         ↓
前端更新列表
```

**3. 金額チェック逻辑**

```
金額チェック = 
  IF (請求書已上传):
    IF (OCR読み取り金額 = 実績合計金額):
      "OK" (绿色)
    ELSE:
      "NG" (红色)
  ELSE:
    "-" (灰色)

金額差分 = 実績合計金額 - OCR読み取り金額
```

**4. 下载流程（チェックのみ）**

```
用户选中账单（チェックボックス）
         ↓
点击【チェックのみダウンロード】按钮
         ↓
POST /api/v1/billing/download
Body: { billingIds: ["billing_001", "billing_002"] }
         ↓
后端处理:
  1. 验证选中状态
  2. 查询 t_billing_file (获取file_path)
  3. 读取文件内容
  4. 返回文件流（单个或打包ZIP）
         ↓
前端触发下载
```

**5. 下载流程（一括）**

```
点击【一括ダウンロード】按钮
         ↓
POST /api/v1/billing/download/all
Body: { status: "チェック済" }
         ↓
后端处理:
  1. 查询 t_billing (WHERE status = "チェック済")
  2. 关联查询 t_billing_file
  3. 批量读取文件
  4. 打包ZIP
  5. 返回ZIP文件流
         ↓
前端触发下载
```

**6. ステータス变更流程（チェックのみ）**

```
用户选中账单（チェックボックス）
         ↓
点击【チェックのみステータス変更】按钮
         ↓
显示确认对话框: "ステータスを「請求完了」に変更しますか？"
         ↓
用户确认
         ↓
POST /api/v1/billing/status
Body: { billingIds: ["billing_001", "billing_002"], status: "請求完了" }
         ↓
后端处理:
  1. 验证选中状态
  2. 更新 t_billing (status = "請求完了")
  3. 插入 t_billing_action_log (ステータス变更记录)
  4. 插入 t_bizintegral_upload (ビズインテグラル上传记录，status="手動アップロード")
  5. 返回成功响应
         ↓
前端更新列表
```

**7. ステータス变更流程（一括）**

```
点击【一括ステータス変更】按钮
         ↓
显示确认对话框: "チェック済の被請求情報を一括で「請求完了」に変更しますか？"
         ↓
用户确认
         ↓
POST /api/v1/billing/status/all
Body: { status: "請求完了" }
         ↓
后端处理:
  1. 查询 t_billing (WHERE status = "チェック済")
  2. 批量更新 t_billing (status = "請求完了")
  3. 批量插入 t_billing_action_log
  4. 批量插入 t_bizintegral_upload
  5. 返回成功响应
         ↓
前端更新列表
```

**8. プレビュー流程**

```
用户点击【ファイル名】或【プレビュー】リンク
         ↓
GET /api/v1/billing/{billingId}/preview
         ↓
后端处理:
  1. 查询 t_billing_file (获取file_path)
  2. 读取文件内容
  3. 返回文件流（PDF预览）
         ↓
前端显示预览弹窗
```

**9. 数据表关系**

```
t_billing（账单主表）
    ├─ id (主键)
    ├─ billing_id (账单ID，业务主键)
    ├─ year_month (年月，YYYY-MM)
    ├─ company_code (公司代码)
    │      └─→ m_partner.company_code (关联公司信息)
    ├─ company_name (公司名称)
    │      └─→ m_partner.company_name
    ├─ status (状态: 未提出/要確認/チェック未/チェック済/請求完了)
    ├─ amount_check (金额检查: OK/NG/-)
    ├─ amount_difference (金额差分)
    ├─ performance_total_amount (实绩合计金额)
    │      └─→ t_performance_summary.billing_id
    ├─ billing_total_amount (账单合计金额)
    │      └─→ t_billing_ocr.billing_id
    │
    ├─→ t_billing_file.billing_id (一对多)
    │      ├─ id (主键)
    │      ├─ file_id (文件ID)
    │      ├─ file_name (文件名)
    │      ├─ file_path (文件路径)
    │      ├─ uploaded_by (上传者)
    │      │      └─→ m_user.user_id
    │      └─ uploaded_datetime (上传时间)
    │
    ├─→ t_billing_action_log.billing_id (一对多)
    │      ├─ id (主键)
    │      ├─ log_id (日志ID)
    │      ├─ action_type (操作类型)
    │      ├─ action_detail (操作详情)
    │      ├─ action_datetime (操作时间)
    │      ├─ action_by (操作者)
    │      │      └─→ m_user.user_id
    │      └─ related_data (关联数据JSON)
    │
    ├─→ t_bizintegral_upload.billing_id (一对多)
    │      ├─ id (主键)
    │      ├─ upload_id (上传ID)
    │      ├─ upload_datetime (上传时间)
    │      ├─ status (上传状态: 手動アップロード)
    │      ├─ uploaded_by (上传者)
    │      │      └─→ m_user.user_id
    │      └─ is_success (是否成功)
    │
    └─→ t_billing_ocr.billing_id (一对一)
           ├─ id (主键)
           ├─ ocr_id (OCR ID)
           ├─ billing_ocr_amount (OCR读取金额)
           ├─ ocr_datetime (OCR识别时间)
           ├─ ocr_source (OCR来源: D-Just)
           └─ is_valid (是否有效)

m_partner（合作伙伴表）
    ├─ id (主键)
    ├─ partner_id (合作伙伴ID)
    ├─ company_code (公司代码)
    ├─ company_name (公司名称)
    └─ partner_type (合作伙伴类型: 輸送パートナー)

t_performance_summary（实绩汇总表）
    ├─ id (主键)
    ├─ billing_id (账单ID)
    │      └─→ t_billing.billing_id
    ├─ completed_order_id (实绩ID)
    │      └─→ t_completed_order.completed_order_id
    ├─ performance_total_amount (实绩合计金额)
    ├─ summary_datetime (汇总时间)
    └─ is_active (是否有效)

m_user（用户表）
    ├─ id (主键)
    ├─ user_id (用户ID)
    ├─ user_name (用户名)
    └─ role (角色)
```

**10. 字段映射关系**

| 画面元素 | 数据库表 | 源字段 | 目标字段 | 转换逻辑 |
|----------|---------|--------|---------|---------|
| 被請求年月 | t_billing | year_month | - | 直接映射 |
| 会社コード | m_partner | company_code | - | 直接映射 |
| 会社名 | m_partner | company_name | - | 直接映射 |
| ステータス | t_billing | status | - | 标签样式（颜色） |
| 金額チェック | t_billing | amount_check | - | 计算字段 + 标签样式 |
| | t_billing_ocr | billing_ocr_amount | - | OCR金额 |
| | t_performance_summary | performance_total_amount | - | 实绩金额 |
| 実績合計金額 | t_performance_summary | performance_total_amount | - | 直接映射 |
| 請求書合計金額 | t_billing_ocr | billing_ocr_amount | - | 直接映射 |
| 金額差分 | t_billing | amount_difference | - | 実績 - 請求書 |
| ファイル名 | t_billing_file | file_name | - | 直接映射 |
| アクション履歴 | t_billing_action_log | action_datetime, action_type, action_by | - | 列表显示 |
| 更新日時 | t_billing_action_log | latest_action_datetime | - | 日期时间格式化 |
| 更新者 | m_user | user_name | - | action_by → user_name |

#### 5.4.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           b6-被請求管理 画面                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑴ 絞り込み（筛选区域）                                                │ │
│  │  被請求年月: [プルダウン▼]  会社コード: [____]  会社名: [____]          │ │
│  │  ステータス: [プルダウン▼]                                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                   ↓                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  ⑵ 被請求一覧（列表区域）                                              │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │ │
│  │  │ ☐ │会社コード│会社名 │ステータス│金額チェック│実績合計 │請求書 │ │ │ │
│  │  │   │(リンク)  │       │(Tag)    │(Tag)      │金額    │合計   │ │ │ │
│  │  ├─────────────────────────────────────────────────────────────────┤ │ │
│  │  │ ☐ │  0001   │运输A  │チェック済│   OK     │ 100万  │ 100万 │ │ │ │
│  │  │   │          │       │(蓝色)    │(绿色)    │        │       │ │ │ │
│  │  └─────────────────────────────────────────────────────────────────┘ │ │
│  │       │         │       │           │           │        │        │ │ │
│  │       │         │       │           │           │        │        │ │ │
│  │   点击→b7   显示    显示     显示       显示       显示    显示       │ │ │
│  │   被請求詳細   公司名   状态     检查结果   系统金额  OCR金额   │ │ │
│  │                                                                      │ │ │
│  │  操作按钮区域                                                         │ │ │
│  │  ┌──────────────────┬──────────────────┬──────────────────────┐      │ │ │
│  │  │チェックのみ      │一括ダウンロード   │チェックのみステータス  │      │ │ │
│  │  │ダウンロード      │(チェック済のみ)  │変更                  │      │ │ │
│  │  └──────────────────┴──────────────────┴──────────────────────┘      │ │ │
│  │  ┌──────────────────────────────────────────────────────┐          │ │ │
│  │  │一括ステータス変更(チェック済→請求完了)               │          │ │ │
│  │  └──────────────────────────────────────────────────────┘          │ │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                    ↓                              ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET billing/    │           │ POST billing/  │
          │ search          │           │ download       │
          │ (页面加载/筛选)  │           │ (チェックのみ)  │
          └────────┬───────┘           └────────┬───────┘
                   ↓                            ↓
          ┌────────────────┐           ┌────────────────┐
          │ GET billing/    │           │ POST billing/  │
          │ {id}/preview    │           │ download/all   │
          │ (プレビュー)     │           │ (一括)          │
          └────────┬───────┘           └────────┬───────┘
                   ↓                            ↓
          ┌────────────────┐           ┌────────────────┐
          │ POST billing/   │           │ POST billing/  │
          │ status          │           │ status/all     │
          │ (チェックのみ)   │           │ (一括)          │
          └────────────────┘           └────────────────┘
```

#### 5.4.4 核心数据库表结构

**t_billing（账单主表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| billing_id | VARCHAR(50) | 账单ID（业务主键） | UNIQUE |
| year_month | VARCHAR(7) | 年月（YYYY-MM） | 用于筛选 |
| company_code | VARCHAR(20) | 公司代码 | → m_partner.company_code |
| company_name | VARCHAR(100) | 公司名称 | → m_partner.company_name |
| status | VARCHAR(20) | 状态 | 未提出/要確認/チェック未/チェック済/請求完了 |
| amount_check | VARCHAR(10) | 金额检查 | OK/NG/- |
| amount_difference | DECIMAL(12,2) | 金额差分 | 実績合計 - 請求書合計 |
| performance_total_amount | DECIMAL(12,2) | 实绩合计金额 | → t_performance_summary |
| billing_total_amount | DECIMAL(12,2) | 账单合计金额 | → t_billing_ocr |
| latest_action_datetime | TIMESTAMP | 最后操作时间 | → t_billing_action_log |
| latest_action_by | VARCHAR(20) | 最后操作者 | → m_user.user_id |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**m_partner（合作伙伴表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| partner_id | VARCHAR(20) | 合作伙伴ID | UNIQUE |
| company_code | VARCHAR(20) | 公司代码 | UNIQUE |
| company_name | VARCHAR(100) | 公司名称 | - |
| partner_type | VARCHAR(20) | 合作伙伴类型 | 輸送パートナー |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_billing_file（账单文件表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| file_id | VARCHAR(50) | 文件ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| file_name | VARCHAR(255) | 文件名 | - |
| file_path | VARCHAR(500) | 文件路径 | - |
| file_size | BIGINT | 文件大小（字节） | - |
| uploaded_by | VARCHAR(20) | 上传者 | → m_user.user_id |
| uploaded_datetime | TIMESTAMP | 上传时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_billing_action_log（账单操作日志表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| log_id | VARCHAR(50) | 日志ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| action_type | VARCHAR(50) | 操作类型 | ステータス変更/下载/プレビュー |
| action_detail | TEXT | 操作详情 | JSON格式 |
| action_datetime | TIMESTAMP | 操作时间 | - |
| action_by | VARCHAR(20) | 操作者 | → m_user.user_id |
| related_data | TEXT | 关联数据 | JSON格式 |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_billing_ocr（账单OCR表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| ocr_id | VARCHAR(50) | OCR ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| billing_ocr_amount | DECIMAL(12,2) | OCR读取金额 | - |
| ocr_datetime | TIMESTAMP | OCR识别时间 | - |
| ocr_source | VARCHAR(50) | OCR来源 | D-Just |
| is_valid | BOOLEAN | 是否有效 | DEFAULT TRUE |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |
| updated_at | TIMESTAMP | 更新时间 | - |

**t_performance_summary（实绩汇总表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| completed_order_id | VARCHAR(50) | 实绩ID | → t_completed_order.completed_order_id |
| performance_total_amount | DECIMAL(12,2) | 实绩合计金额 | - |
| summary_datetime | TIMESTAMP | 汇总时间 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

**t_bizintegral_upload（ビズインテグラル上传记录表）**

| 字段名 | 类型 | 说明 | 关联 |
|--------|------|------|------|
| id | BIGSERIAL | 主键 | - |
| upload_id | VARCHAR(50) | 上传ID | UNIQUE |
| billing_id | VARCHAR(50) | 账单ID | → t_billing.billing_id |
| upload_datetime | TIMESTAMP | 上传时间 | - |
| status | VARCHAR(50) | 上传状态 | 手動アップロード |
| uploaded_by | VARCHAR(20) | 上传者 | → m_user.user_id |
| is_success | BOOLEAN | 是否成功 | DEFAULT TRUE |
| remark | TEXT | 备注 | - |
| is_active | BOOLEAN | 是否有效 | DEFAULT TRUE |
| created_at | TIMESTAMP | 创建时间 | - |

---

## 6. 前端实现

### 6.1 账单列表组件
```typescript
// b6账单列表组件
import { Table, Button, Tag, Space } from 'antd';

export const B6BillingPage: React.FC = () => {
  const [selectedRowKeys, setSelectedRowKeys] = useState([]);

  const handleDownload = () => {
    // 下载选中账单
  };

  const handleStatusChange = () => {
    // 状态变更
  };

  return (
    <div className="b6-billing-container">
      <FilterSection />
      <Table
        rowSelection={{
          selectedRowKeys,
          onChange: setSelectedRowKeys,
        }}
        columns={columns}
        dataSource={billingList}
      />
      <ActionButtons
        onDownload={handleDownload}
        onStatusChange={handleStatusChange}
      />
    </div>
  );
};
```

---

## 7. 验收标准

### 7.1 功能验收
- [ ] 筛选条件可正常输入
- [ ] 列表正确显示账单数据
- [ ] 点击公司代码跳转到详情页
- [ ] プレビュー功能正常
- [ ] 下载功能正常
- [ ] 状态变更功能正常

### 7.2 视觉验收
- [ ] 布局与设计稿一致
- [ ] 列表字段顺序正确
- [ ] 状态颜色正确

### 7.3 性能验收
- [ ] 筛选响应时间 < 1秒
- [ ] 下载响应时间 < 3秒

---

## 8. 变更日志

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-10 | v1.0.1 | 新增5.4节：画面-API-数据库关系映射表，包含详细的关系总览、关系说明、数据流图和核心数据库表结构 | - |
| 2026-02-XX | v1.0 | 初始版本 | - |

---

## 附录

### A.1 相关文档
| 文档 | 路径 | 说明 |
|------|------|------|
| 公共技术架构规范 | [\_公共技术架构规范.md](../_公共技术架构规范.md) | 前后端技术架构详细规范 |
| b0-导航菜单 | [../b0-共通ナビゲーション/05_设计规范.md](../b0-共通ナビゲーション/05_设计规范.md) | 导航菜单设计规范 |

### A.2 与p6-被請求管理对比
| 特性 | b6-被請求管理 | p6-被請求管理 |
|------|---------------|---------------|
| **用户类型** | ベース | 輸送パートナー |
| **设备支持** | PCのみ | PC/SP |

---

**文档编制**: -  
**编制时间**: 2026-02-10 
**适用范围**: 別紙_画面一覧_v151.xlsx - b6-被請求管理  
**交叉引用**: [\_公共技术架构规范.md](../_公共技术架构规范.md)
