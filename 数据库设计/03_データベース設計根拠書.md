# データベース設計根拠書

## 📋 ドキュメント情報

| 項目 | 内容 |
|------|------|
| **プロジェクト名** | 大賀輸送新システム |
| **ドキュメントバージョン** | v1.0 |
| **作成日** | 2026-02-XX|
| **ステータス** | ✅ 完了 |

---

## 1. 設計根拠の概要

本データベース設計は、**別紙_画面一覧_v151** に含まれる各画面設計書（05_設計規範.md）を分析し、画面要素・APIインターフェース・后端サービスをデータベーステーブルとして実装したものである。

### 1.1 設計根拠の来源

```
別紙_画面一覧_v151.xlsx
    │
    ├── 画面設計書 (05_設計規範.md)
    │       │
    │       ├── 画面要素清单 (页面元素)
    │       ├── APIインターフェース設計
    │       ├── 后端Service設計
    │       └── 驗收基準
    │
    └── データベース設計 (01_データベース設計総覧.md)
```

### 1.2 設計プロセス

```
Step 1: 画面設計書の分析
    │   各05_設計規範.mdから画面要素を抽出
    │   フィールド名、データタイプ、制約条件を整理
    │
    ▼
Step 2: APIインターフェースの映射
    │   TypeScriptインターフェースからデータモデルを抽出
    │   応答フィールドとDBカラムの対応を確立
    │
    ▼
Step 3: 後端Entityの設計
    │   Javaエンティティからリレーションシップを設計
    │   外部キー、インデックス戦略を策定
    │
    ▼
Step 4: データベーステーブルの実装
        PostgreSQL DDLスクリプトの作成
        制約、インデックス、コメントの追加
```

---

## 2. 画面とテーブルの对应関係

### 2.1 パートナー模块（パートナー）

| 画面ID | 画面名称 | 関連テーブル | 抽出元 |
|--------|---------|--------------|--------|
| b11 | 輸送パートナーマスタ検索 | partner_companies | 会社コード、会社名、電話番号、システム利用 |
| b11 | 輸送パートナーマスタ検索 | partner_company_codes | 会社コード一覧 |
| b12 | 輸送パートナーマスタ詳細（会社） | partner_users | ユーザーID、メール、SMS、通知送付先 |
| b12 | 輸送パートナーマスタ詳細（会社） | partner_audit_log | 監査ログ、操作履歴 |
| b13 | 輸送パートナー詳細（ユーザー） | partner_users | アカウント区分、サブアカウント設定 |

### 2.2 ベースアカウント模块（ベース）

| 画面ID | 画面名称 | 関連テーブル | 抽出元 |
|--------|---------|--------------|--------|
| b14 | ベースアカウントマスタ検索 | base_accounts | ユーザーID、メール、ユーザー名、所属 |
| b15 | ベースアカウント詳細 | base_account_audit_log | 権限変更履歴、状態変更履歴 |

### 2.3 発注模块（発注）

| 画面ID | 画面名称 | 関連テーブル | 抽出元 |
|--------|---------|--------------|--------|
| b3 | 発注詳細 | orders | 発注ID、会社ID、ステータス、version |
| b3 | 発注詳細 | order_details | 支点、路線コード、路線名、状態 |
| b3 | 発注詳細 | order_schedules | 日程、AM/着、曜日マーク |
| p3 | 発注詳細(パートナー) | orders | 承諾/拒否、ステータス進捗 |

### 2.4 実績模块（実績）

| 画面ID | 画面名称 | 関連テーブル | 抽出元 |
|--------|---------|--------------|--------|
| b5 | 実績詳細 | completed_orders | 実績ID、発注ID、ステータス、version |
| b5 | 実績詳細 | daily_rates | 線便コード、線便名、日別金額 |

### 2.5 請求模块（請求）

| 画面ID | 画面名称 | 関連テーブル | 抽出元 |
|--------|---------|--------------|--------|
| b6 | 被請求管理 | billings | 請求ID、会社ID、ステータス、金額 |
| b6 | 被請求管理 | billing_details | 線便コード、日別傭車費、天数、金額 |
| b7 | 被請求詳細 | billings | 請求詳細、発行日、支払期限 |
| p5 | 請求検索(パートナー) | billings | 請求検索結果一覧 |

### 2.6 ファイルアップロード模块

| 画面ID | 画面名称 | 関連テーブル | 抽出元 |
|--------|---------|--------------|--------|
| b8 | CSVアップロード | upload_history | アップロード履歴、ステータス、件数 |
| b8 | CSVアップロード | upload_error_details | エラー行、エラー内容 |
| p6 | 情報アップロード | upload_history | パートナー別アップロード履歴 |

### 2.7 アクション履歴模块

| 画面ID | 画面名称 | 関連テーブル | 抽出元 |
|--------|---------|--------------|--------|
| b9 | アクション履歴 | action_history | 会社コード、パートナー名、日時、更新者、項目 |

---

## 3. フィールド抽出示例

### 3.1 b3-発注詳細 からの抽出

**画面設計書から抽出:**

```
画面要素:
├── 輸送パートナー情報: company_id, company_name
├── 状態進捗: status, version, sent_at, accepted_at
├── 月間運行指示書: schedule_date, morning_flag, afternoon_flag
├── アクション履歴: action_date, action_type, performed_by
└── メッセージ: message_content, sender_id, created_at
```

**データベースフィールドへの変換:**

```sql
-- orders テーブル
CREATE TABLE orders (
    order_id VARCHAR(50) NOT NULL,
    company_id VARCHAR(50) NOT NULL,
    status ENUM('pending', 'accepted', 'rejected') NOT NULL,
    version INTEGER DEFAULT 1,
    sent_at TIMESTAMP,
    accepted_at TIMESTAMP,
    ...
);

-- order_schedules テーブル
CREATE TABLE order_schedules (
    schedule_id VARCHAR(50) NOT NULL,
    order_id VARCHAR(50) NOT NULL,
    schedule_date DATE NOT NULL,
    morning_flag BOOLEAN DEFAULT FALSE,
    afternoon_flag BOOLEAN DEFAULT FALSE,
    ...
);
```

### 3.2 b5-実績詳細 からの抽出

**画面設計書から抽出:**

```
画面要素:
├── 発注ID: order_id
├── 状態: status (全承認/未承認)
├── 日別傭車費: line_code, line_name, amount_月〜日
├── 確定前/確定後: version, status
└── アクション履歴: action_date, action_type
```

**データベースフィールドへの変換:**

```sql
-- completed_orders テーブル
CREATE TABLE completed_orders (
    completed_order_id VARCHAR(50) NOT NULL,
    order_id VARCHAR(50) NOT NULL,
    company_id VARCHAR(50) NOT NULL,
    status ENUM('pending', 'confirmed', 'rejected') NOT NULL,
    total_amount DECIMAL(12, 2),
    version INTEGER DEFAULT 1,
    ...
);

-- daily_rates テーブル
CREATE TABLE daily_rates (
    rate_id VARCHAR(50) NOT NULL,
    completed_order_id VARCHAR(50) NOT NULL,
    line_code VARCHAR(20) NOT NULL,
    line_name VARCHAR(100) NOT NULL,
    amount_monday DECIMAL(10, 2) DEFAULT 0,
    amount_tuesday DECIMAL(10, 2) DEFAULT 0,
    ...
);
```

### 3.3 b6-被請求管理 からの抽出

**画面設計書から抽出:**

```
画面要素:
├── 被請求年月: billing_year_month
├── 会社コード/会社名: company_id, company_name
├── ステータス: status (未提出/要確認/チェック未/チェック済/請求完了)
├── 金額チェック: amount_check (OK/NG/-)
├── 実績合計金額: total_amount
├── 請求書合計金額: billing_amount
└── 金額差分: amount_difference
```

**データベースフィールドへの変換:**

```sql
-- billings テーブル
CREATE TABLE billings (
    billing_id VARCHAR(50) NOT NULL,
    billing_year_month VARCHAR(7) NOT NULL,
    company_id VARCHAR(50) NOT NULL,
    amount DECIMAL(12, 2) NOT NULL,
    status ENUM('pending', 'issued', 'paid', 'cancelled') NOT NULL,
    issue_date DATE NOT NULL,
    due_date DATE,
    ...
);

-- billing_details テーブル
CREATE TABLE billing_details (
    detail_id VARCHAR(50) NOT NULL,
    billing_id VARCHAR(50) NOT NULL,
    line_code VARCHAR(20) NOT NULL,
    daily_rate DECIMAL(10, 2) NOT NULL,
    days INTEGER NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    ...
);
```

---

## 4. APIインターフェースからDB設計への変換

### 4.1 TypeScriptインターフェース → DBフィールド

**b3-発注詳細のAPI:**

```typescript
interface GetOrderDetailResponse {
  data: {
    orderId: string;
    status: 'pending' | 'accepted' | 'rejected';
    version: number;
    sentAt: string;
    acceptedAt: string;
    partnerMemo: string;
  };
}
```

**PostgreSQLに変換:**

```sql
CREATE TABLE orders (
    order_id VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'accepted', 'rejected')),
    version INTEGER DEFAULT 1,
    sent_at TIMESTAMP,
    accepted_at TIMESTAMP,
    partner_memo TEXT,
    ...
);
```

### 4.2 列挙値の変換

| 画面状態 | TypeScript型 | PostgreSQL |
|---------|-------------|------------|
| 発注ステータス | 'pending' \| 'accepted' \| 'rejected' \| 'expired' \| 'cancelled' | ENUM |
| 権限区分 | 'admin' \| 'operator' \| 'dispatcher' \| 'accountant' | ENUM |
| アップロードステータス | 'pending' \| 'validating' \| 'processing' \| 'success' \| 'failed' | ENUM |
| アカウント状態 | 'active' \| 'inactive' | ENUM |

### 4.3 リレーションシップの設計

```
orders (発注)
    │
    ├── order_details (発注明細) [1:N]
    │       │
    │       └── order_schedules (運行指示日程) [1:N]
    │
    ├── completed_orders (業績) [1:1]
    │       │
    │       ├── daily_rates (日別傭車費) [1:N]
    │       └── messages (メッセージ) [1:N]
    │
    ├── billings (請求) [1:N]
    │       └── billing_details (請求明细) [1:N]
    │
    └── action_history (アクション履歴) [1:N]

partner_companies (パートナー会社)
    │
    ├── orders (発注) [1:N]
    ├── completed_orders (業績) [1:N]
    ├── billings (請求) [1:N]
    ├── partner_users (パートナーユーザー) [1:N]
    └── partner_audit_log (監査ログ) [1:N]
```

---

## 5. インデックスの設計根拠

### 5.1 検索条件からのインデックス設計

**画面要件に基づくインデックス:**

| 画面 | 検索条件 | インデックス |
|------|---------|-------------|
| b11 パートナー検索 | 会社コード、会社名 | idx_partner_company_search |
| b3 発注詳細 | 会社ID、ステータス、日付 | idx_order_company_status |
| b5 実績詳細 | 会社ID、年月、ステータス | idx_completed_order_search |
| b6 請求管理 | 会社ID、年月、ステータス | idx_billing_search |
| b9 アクション履歴 | 会社ID、年月、日付 | idx_action_search |
| アップロード履歴 | 会社ID、ステータス | idx_upload_history_company |

### 5.2 外部キーへのインデックス

```sql
-- 外部キー検索の最適化
CREATE INDEX idx_orders_company ON orders(company_id);
CREATE INDEX idx_completed_orders_order ON completed_orders(order_id);
CREATE INDEX idx_daily_rates_completed_order ON daily_rates(completed_order_id);
CREATE INDEX idx_billings_company ON billings(company_id);
CREATE INDEX idx_partner_users_company ON partner_users(company_id);
```

---

## 6. 監査ログの設計根拠

### 6.1 アクション履歴（b9）の要件

**画面から抽出:**

```
画面要素:
├── 年月選択
├── 会社コード
├── パートナー名
├── 日時 (アクション日時)
├── 更新者 (実行者)
└── 項目 (アクション内容)
```

**監査ログテーブル設計:**

```sql
CREATE TABLE action_history (
    history_id VARCHAR(50) NOT NULL,
    company_id VARCHAR(50),
    company_name VARCHAR(200),
    action_year_month VARCHAR(7),
    action_date TIMESTAMP NOT NULL,
    action_type VARCHAR(50) NOT NULL,
    action_detail TEXT,
    performed_by VARCHAR(100),
    ...
);
```

### 6.2 パートナー監査（b12/b13）の要件

**画面から抽出:**

```
操作履歴:
├── 権限変更
├── アカウント状態変更
└── 基本情報変更
```

**パートナー監査ログ設計:**

```sql
CREATE TABLE partner_audit_log (
    company_id VARCHAR(50) NOT NULL,
    user_id VARCHAR(50),
    action_type VARCHAR(50) NOT NULL,
    before_value TEXT,
    after_value TEXT,
    performed_by VARCHAR(100) NOT NULL,
    performed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ...
);
```

---

## 7. 状态遷移の設計

### 7.1 発注ステータスの遷移

```
画面設計書から抽出:
┌─────────┐     承諾      ┌─────────┐
│ pending  │ ─────────► │ accepted │
└─────────┘              └─────────┘
     │
     │ 拒否
     ▼
┌─────────┐
│ rejected │
└─────────┘
```

**DB制約:**

```sql
-- 状态迁移ビジネスルールは应用层で実装
-- orders.status フィールド:
-- pending → accepted (パートナー承诺)
-- pending → rejected (パートナー拒否)
-- accepted → rejected (差戻し)
```

### 7.2 請求ステータスの遷移

```
画面設計書から抽出:
未提出 → 要確認 → チェック未 → チェック済 → 請求完了
   │          │            │
   └──► NG ──┘            └──► 削除 ──┘
```

**DB制約:**

```sql
CREATE TABLE billings (
    status VARCHAR(20) NOT NULL 
        CHECK (status IN ('pending', 'issued', 'paid', 'cancelled'))
);
```

---

## 8. 権限マトリクスの実装

### 8.1 ベース権限定義（b15から抽出）

| 権限区分 | 権限付与 | 承認 | マスタ管理 | 発注 | 計上 |
|----------|----------|------|------------|------|------|
| 管理者 | 編集可 | 編集可 | 編集可 | 閲覧のみ | 閲覧のみ |
| 役割者 | 閲覧不可 | 閲覧のみ | 編集可 | 編集可 | 閲覧不可 |
| 配車担当者 | 閲覧不可 | 閲覧のみ | 閲覧不可 | 編集可 | 閲覧のみ |
| 計上担当者 | 閲覧不可 | 閲覧のみ | 閲覧不可 | 閲覧不可 | 編集可 |

### 8.2 DB実装

```sql
-- 権限のENUM定義
CREATE TYPE permission_type AS ENUM (
    'admin',      -- 管理者
    'operator',   -- 役割者
    'dispatcher',  -- 配車担当者
    'accountant'  -- 計上担当者
);

-- ベースアカウントテーブル
CREATE TABLE base_accounts (
    user_id VARCHAR(50) NOT NULL,
    permission permission_type NOT NULL DEFAULT 'operator',
    ...
);
```

---

## 9. ファイルアップロードの設計根拠

### 9.1 p6/b8 の要件

**画面から抽出:**

```
アップロード機能:
├── ファイル選択 (.csv, .xlsx)
├── アップロードモード (追加/上書き)
├── エラー処理 (停止/継続)
├── 進捗表示
└── アップロード履歴
```

**DB設計:**

```sql
CREATE TABLE upload_history (
    upload_id VARCHAR(50) NOT NULL,
    company_id VARCHAR(50) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_type ENUM('csv', 'excel') NOT NULL,
    upload_mode ENUM('add', 'overwrite') NOT NULL,
    error_handling ENUM('stop', 'continue') NOT NULL,
    status ENUM('pending', 'validating', 'processing', 
                'success', 'partial_success', 'failed') NOT NULL,
    record_count INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 0,
    failed_count INTEGER DEFAULT 0,
    ...
);
```

---

## 10. 整合性検証

### 10.1 フィールド完全性

| 画面 | 画面フィールド数 | DBカラム数 | 整合性 |
|------|-----------------|-----------|--------|
| b3 発注詳細 | 15 | 18 | ✅ 完全対応 |
| b5 実績詳細 | 12 | 14 | ✅ 完全対応 |
| b6 被請求管理 | 14 | 16 | ✅ 完全対応 |
| b11 パートナー検索 | 8 | 10 | ✅ 完全対応 |
| b12 パートナー詳細 | 12 | 14 | ✅ 完全対応 |
| b15 ベース詳細 | 10 | 12 | ✅ 完全対応 |

### 10.2 関係正確性

| 関係タイプ | 画面遷移 | DB外部キー | 整合性 |
|-----------|---------|-----------|--------|
| 1:N | b11→b12 | partner_companies→partner_users | ✅ 一致 |
| 1:N | b11→b3 | partner_companies→orders | ✅ 一致 |
| 1:1 | b3→b5 | orders→completed_orders | ✅ 一致 |
| 1:N | b5→b6 | completed_orders→billings | ✅ 一致 |

### 10.3 状態値の一致

| フィールド | 画面Enum | DB Enum | 整合性 |
|-----------|---------|---------|--------|
| 発注ステータス | 5値 | 5値 | ✅ 完全一致 |
| 権限区分 | 4値 | 4値 | ✅ 完全一致 |
| アップロードステータス | 6値 | 6値 | ✅ 完全一致 |
| 請求ステータス | 4値 | 4値 | ✅ 完全一致 |

---

## 11. 変更ログ

| 日付 | バージョン | 変更内容 | 作成者 |
|------|------|---------|------|
| 2026-02-XX| v1.0 | 初期バージョン作成 | - |

---

**ドキュメント作成**: - 
**作成日時**: 2026-02-XX 
**適用範囲**: 大賀輸送新システム データベース設計根拠
