# å¤§è³€è¼¸é€æ–°ã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

## ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå** | å¤§è³€è¼¸é€æ–°ã‚·ã‚¹ãƒ†ãƒ  |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—** | PostgreSQL 15.x |
| **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³** | v1.0 |
| **ä½œæˆæ—¥** | 2026-02-XX|
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | âœ… ãƒ‰ãƒ©ãƒ•ãƒˆ |

---

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒæ¦‚è¦

### 1.1 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒºåˆ†

```
å¤§è³€è¼¸é€æ–°ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
â”œâ”€â”€ å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”œâ”€â”€ m_screen (ç”»é¢ãƒ†ãƒ¼ãƒ–ãƒ«)
â”‚   â”œâ”€â”€ m_permission (æ¨©é™ãƒ†ãƒ¼ãƒ–ãƒ«)
â”‚   â”œâ”€â”€ m_role (ãƒ­ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«)
â”‚   â””â”€â”€ m_base (åŸºæœ¬æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«)
â”‚
â”œâ”€â”€ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¨¡å— (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼)
â”‚   â”œâ”€â”€ partner_companies (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼šç¤¾)
â”‚   â”œâ”€â”€ partner_users (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼)
â”‚   â””â”€â”€ partner_company_codes (ä¼šç¤¾ã‚³ãƒ¼ãƒ‰)
â”‚
â”œâ”€â”€ ãƒ™ãƒ¼ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (ãƒ™ãƒ¼ã‚¹)
â”‚   â”œâ”€â”€ base_accounts (ãƒ™ãƒ¼ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)
â”‚   â””â”€â”€ base_list (ãƒ™ãƒ¼ã‚¹ãƒªã‚¹ãƒˆ)
â”‚
â”œâ”€â”€ ç™ºæ³¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (ç™ºæ³¨)
â”‚   â”œâ”€â”€ orders (ç™ºæ³¨ãƒã‚¹ã‚¿)
â”‚   â”œâ”€â”€ order_details (ç™ºæ³¨æ˜ç»†)
â”‚   â””â”€â”€ order_instructions (é‹è¡ŒæŒ‡ç¤ºæ›¸)
â”‚
â”œâ”€â”€ å®Ÿç¸¾ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (å®Ÿç¸¾)
â”‚   â”œâ”€â”€ completed_orders (å®Ÿç¸¾ãƒã‚¹ã‚¿)
â”‚   â”œâ”€â”€ daily_rates (æ—¥åˆ¥å‚­è»Šè²»)
â”‚   â””â”€â”€ confirmed_instructions (ç¢ºå®šæŒ‡ç¤ºæ›¸)
â”‚
â”œâ”€â”€ è«‹æ±‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« (è«‹æ±‚)
â”‚   â”œâ”€â”€ billings (è«‹æ±‚ãƒã‚¹ã‚¿)
â”‚   â”œâ”€â”€ billing_details (è«‹æ±‚æ˜ç»†)
â”‚   â””â”€â”€ billing_attachments (è«‹æ±‚æ·»ä»˜)
â”‚
â”œâ”€â”€ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”œâ”€â”€ upload_history (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´)
â”‚   â””â”€â”€ upload_error_details (ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ†ãƒ¼ãƒ«)
â”‚
â””â”€â”€ ç›£æŸ»ãƒ­ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    â”œâ”€â”€ action_history (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´)
    â”œâ”€â”€ partner_audit_log (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç›£æŸ»)
    â””â”€â”€ base_audit_log (ãƒ™ãƒ¼ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç›£æŸ»)
```

### 1.2 å‘½åãƒ«ãƒ¼ãƒ«

| ã‚¿ã‚¤ãƒ— | ãƒ«ãƒ¼ãƒ« | ä¾‹ |
|------|------|------|
| ãƒ†ãƒ¼ãƒ–ãƒ«å | å°æ–‡å­—ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ | partner_companies |
| ä¸»ã‚­ãƒ¼ | id | id |
| å¤–éƒ¨ã‚­ãƒ¼ | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å_id | company_id |
| ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ | idx_ãƒ†ãƒ¼ãƒ–ãƒ«å_åˆ—å | idx_partner_name |
| åˆ—æŒ™å€¤ | å°æ–‡å­—ã‚¢ãƒ³ãƒ€ãƒ¼ãƒãƒ¼ | pending, accepted |
| ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— | _at | created_at, updated_at |

---

## 2. å…±é€šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 2.1 m_screen (ç”»é¢ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE m_screen (
    id BIGSERIAL PRIMARY KEY,
    screen_id VARCHAR(20) NOT NULL UNIQUE COMMENT 'ç”»é¢ID',
    screen_name VARCHAR(100) NOT NULL COMMENT 'ç”»é¢åç§°',
    category VARCHAR(50) COMMENT 'ã‚«ãƒ†ã‚´ãƒªãƒ¼',
    description TEXT COMMENT 'èª¬æ˜',
    route_path VARCHAR(100) COMMENT 'ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹',
    component_name VARCHAR(100) COMMENT 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå',
    device_pc BOOLEAN DEFAULT FALSE COMMENT 'PCå¯¾å¿œ',
    device_sp BOOLEAN DEFAULT FALSE COMMENT 'SPå¯¾å¿œ',
    sort_order INTEGER DEFAULT 0 COMMENT 'ä¸¦ã³é †',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æœ‰åŠ¹çŠ¶æ…‹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    created_by VARCHAR(50) COMMENT 'ä½œæˆè€…',
    updated_at TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    updated_by VARCHAR(50) COMMENT 'æ›´æ–°è€…',
    
    CONSTRAINT uk_screen_id UNIQUE (screen_id)
);

CREATE INDEX idx_screen_category ON m_screen(category);
CREATE INDEX idx_screen_route ON m_screen(route_path);
```

### 2.2 m_permission (æ¨©é™ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE m_permission (
    id BIGSERIAL PRIMARY KEY,
    role_id VARCHAR(20) NOT NULL COMMENT 'ãƒ­ãƒ¼ãƒ«ID',
    screen_id VARCHAR(20) NOT NULL COMMENT 'ç”»é¢ID',
    access_level INTEGER NOT NULL DEFAULT 0 
        CHECK (access_level IN (0, 1, 2)) 
        COMMENT 'ã‚¢ã‚¯ã‚»ã‚¹ãƒ¬ãƒ™ãƒ«: 0-ç„¡, 1-å‚ç…§ã®ã¿, 2-å‚ç…§æ›´æ–°',
    can_read BOOLEAN DEFAULT FALSE COMMENT 'å‚ç…§å¯',
    can_write BOOLEAN DEFAULT FALSE COMMENT 'æ›´æ–°å¯',
    can_delete BOOLEAN DEFAULT FALSE COMMENT 'å‰Šé™¤å¯',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æœ‰åŠ¹çŠ¶æ…‹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    
    CONSTRAINT uk_role_screen UNIQUE (role_id, screen_id)
);

CREATE INDEX idx_permission_role ON m_permission(role_id);
CREATE INDEX idx_permission_screen ON m_permission(screen_id);
```

### 2.3 m_role (ãƒ­ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE m_role (
    id BIGSERIAL PRIMARY KEY,
    role_id VARCHAR(20) NOT NULL UNIQUE COMMENT 'ãƒ­ãƒ¼ãƒ«ID',
    role_name VARCHAR(50) NOT NULL COMMENT 'ãƒ­ãƒ¼ãƒ«åç§°',
    role_name_ja VARCHAR(50) NOT NULL COMMENT 'ãƒ­ãƒ¼ãƒ«æ—¥æœ¬èªå',
    description VARCHAR(200) COMMENT 'èª¬æ˜',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æœ‰åŠ¹çŠ¶æ…‹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚'
);
```

---

## 3. ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 3.1 partner_companies (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼šç¤¾ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE partner_companies (
    id BIGSERIAL PRIMARY KEY,
    company_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ä¼šç¤¾ID',
    company_name VARCHAR(200) NOT NULL COMMENT 'ä¼šç¤¾å',
    company_phone VARCHAR(20) NOT NULL COMMENT 'ä¼šç¤¾é›»è©±ç•ªå·',
    system_use BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨',
    instruction_text VARCHAR(20) NOT NULL DEFAULT 'æ–‡è¨€1' COMMENT 'æŒ‡ç¤ºæ›¸è¡¨ç¤ºæ–‡è¨€',
    status ENUM('active', 'inactive') DEFAULT 'active' COMMENT 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    memo TEXT COMMENT 'å‚™è€ƒ',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    created_by VARCHAR(100) COMMENT 'ä½œæˆè€…',
    updated_by VARCHAR(100) COMMENT 'æ›´æ–°è€…',
    
    CONSTRAINT pk_partner_company PRIMARY KEY (company_id)
);

CREATE INDEX idx_partner_company_name ON partner_companies(company_name);
CREATE INDEX idx_partner_company_status ON partner_companies(status);
CREATE INDEX idx_partner_company_system_use ON partner_companies(system_use);
```

### 3.2 partner_company_codes (ä¼šç¤¾ã‚³ãƒ¼ãƒ‰ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE partner_company_codes (
    id BIGSERIAL PRIMARY KEY,
    company_id VARCHAR(50) NOT NULL COMMENT 'ä¼šç¤¾ID',
    company_code VARCHAR(50) NOT NULL COMMENT 'ä¼šç¤¾ã‚³ãƒ¼ãƒ‰',
    is_primary BOOLEAN DEFAULT FALSE COMMENT 'ä¸»ã‚³ãƒ¼ãƒ‰',
    effective_date DATE COMMENT 'æœ‰åŠ¹é–‹å§‹æ—¥',
    expiration_date DATE COMMENT 'æœ‰åŠ¹çµ‚äº†æ—¥',
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æœ‰åŠ¹çŠ¶æ…‹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    
    CONSTRAINT uk_company_code UNIQUE (company_id, company_code),
    FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE CASCADE
);

CREATE INDEX idx_company_code_code ON partner_company_codes(company_code);
```

### 3.3 partner_users (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE partner_users (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
    company_id VARCHAR(50) NOT NULL COMMENT 'æ‰€å±ä¼šç¤¾ID',
    email VARCHAR(200) NOT NULL COMMENT 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
    personal_sms VARCHAR(20) NOT NULL COMMENT 'å€‹äººé›»è©±ç•ªå·',
    notification_target ENUM('mail', 'sms') NOT NULL DEFAULT 'mail' COMMENT 'é€šçŸ¥é€ä»˜å…ˆ',
    account_type ENUM('main', 'sub') NOT NULL DEFAULT 'sub' COMMENT 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåŒºåˆ†',
    sub_account_notification ENUM('yes', 'no') COMMENT 'ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£çµ¡å—é ˜',
    branch_name VARCHAR(200) COMMENT 'æ”¯åº—ãƒ»å–¶æ¥­æ‰€å',
    account_status ENUM('active', 'inactive') NOT NULL DEFAULT 'active' COMMENT 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹',
    password_hash VARCHAR(255) COMMENT 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥',
    last_login_at TIMESTAMP COMMENT 'æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    
    CONSTRAINT fk_partner_user_company 
        FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE CASCADE,
    CONSTRAINT uk_partner_user_email UNIQUE (email)
);

CREATE INDEX idx_partner_user_company ON partner_users(company_id);
CREATE INDEX idx_partner_user_status ON partner_users(account_status);
CREATE INDEX idx_partner_user_type ON partner_users(account_type);
```

### 3.4 partner_audit_log (ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE partner_audit_log (
    id BIGSERIAL PRIMARY KEY,
    company_id VARCHAR(50) NOT NULL COMMENT 'ä¼šç¤¾ID',
    user_id VARCHAR(50) COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
    action_type VARCHAR(50) NOT NULL COMMENT 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—',
    action_detail TEXT COMMENT 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°',
    before_value TEXT COMMENT 'å¤‰æ›´å‰å€¤',
    after_value TEXT COMMENT 'å¤‰æ›´å¾Œå€¤',
    ip_address VARCHAR(45) COMMENT 'IPã‚¢ãƒ‰ãƒ¬ã‚¹',
    user_agent TEXT COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ',
    performed_by VARCHAR(100) NOT NULL COMMENT 'å®Ÿè¡Œè€…',
    performed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å®Ÿè¡Œæ—¥æ™‚',
    
    CONSTRAINT fk_audit_company 
        FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE CASCADE
);

CREATE INDEX idx_audit_partner_company ON partner_audit_log(company_id);
CREATE INDEX idx_audit_partner_user ON partner_audit_log(user_id);
CREATE INDEX idx_audit_partner_time ON partner_audit_log(performed_at);
```

---

## 4. ãƒ™ãƒ¼ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 4.1 base_accounts (ãƒ™ãƒ¼ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE base_accounts (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
    user_name VARCHAR(200) NOT NULL COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
    email VARCHAR(200) NOT NULL UNIQUE COMMENT 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
    affiliation VARCHAR(200) NOT NULL COMMENT 'æ‰€å±',
    permission ENUM('admin', 'operator', 'dispatcher', 'accountant') NOT NULL DEFAULT 'operator' COMMENT 'æ¨©é™',
    account_status ENUM('active', 'inactive') NOT NULL DEFAULT 'active' COMMENT 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ…‹',
    azure_ad_id VARCHAR(100) COMMENT 'AzureADã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆID',
    roles TEXT[] COMMENT 'ãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ',
    permissions TEXT[] COMMENT 'æ¨©é™ãƒªã‚¹ãƒˆ',
    last_login_at TIMESTAMP COMMENT 'æœ€çµ‚ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    created_by VARCHAR(100) COMMENT 'ä½œæˆè€…',
    updated_by VARCHAR(100) COMMENT 'æ›´æ–°è€…',
    
    CONSTRAINT pk_base_account PRIMARY KEY (user_id)
);

CREATE INDEX idx_base_account_email ON base_accounts(email);
CREATE INDEX idx_base_account_affiliation ON base_accounts(affiliation);
CREATE INDEX idx_base_account_permission ON base_accounts(permission);
CREATE INDEX idx_base_account_status ON base_accounts(account_status);
```

### 4.2 base_list (ãƒ™ãƒ¼ã‚¹ãƒªã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE base_list (
    id BIGSERIAL PRIMARY KEY,
    base_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ãƒ™ãƒ¼ã‚¹ID',
    base_name VARCHAR(200) NOT NULL COMMENT 'ãƒ™ãƒ¼ã‚¹å',
    base_type ENUM('base', 'headquarters') NOT NULL COMMENT 'ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—',
    address TEXT COMMENT 'ä½æ‰€',
    phone VARCHAR(20) COMMENT 'é›»è©±ç•ªå·',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'æœ‰åŠ¹çŠ¶æ…‹',
    sort_order INTEGER DEFAULT 0 COMMENT 'ä¸¦ã³é †',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    
    CONSTRAINT pk_base_list PRIMARY KEY (base_id)
);

CREATE INDEX idx_base_list_type ON base_list(base_type);
CREATE INDEX idx_base_list_active ON base_list(is_active);
```

### 4.3 base_account_audit_log (ãƒ™ãƒ¼ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE base_account_audit_log (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(50) NOT NULL COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
    changed_field VARCHAR(50) NOT NULL COMMENT 'å¤‰æ›´ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰',
    before_value TEXT COMMENT 'å¤‰æ›´å‰å€¤',
    after_value TEXT COMMENT 'å¤‰æ›´å¾Œå€¤',
    change_reason TEXT COMMENT 'å¤‰æ›´ç†ç”±',
    performed_by VARCHAR(100) NOT NULL COMMENT 'å®Ÿè¡Œè€…',
    performed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'å®Ÿè¡Œæ—¥æ™‚',
    
    CONSTRAINT fk_base_audit_user 
        FOREIGN KEY (user_id) REFERENCES base_accounts(user_id) ON DELETE CASCADE
);

CREATE INDEX idx_audit_base_user ON base_account_audit_log(user_id);
CREATE INDEX idx_audit_base_time ON base_account_audit_log(performed_at);
```

---

## 5. ç™ºæ³¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 5.1 orders (ç™ºæ³¨ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    order_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç™ºæ³¨ID',
    company_id VARCHAR(50) NOT NULL COMMENT 'ä¼šç¤¾ID',
    order_year_month VARCHAR(7) NOT NULL COMMENT 'ç™ºæ³¨å¹´æœˆ(YYYY-MM)',
    status ENUM('pending', 'accepted', 'rejected', 'expired', 'cancelled') NOT NULL DEFAULT 'pending' COMMENT 'ç™ºæ³¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    request_detail TEXT COMMENT 'ä¾é ¼è©³ç´°',
    request_date DATE NOT NULL COMMENT 'ä¾é ¼æ—¥',
    deadline DATE COMMENT 'æœŸé™æ—¥',
    partner_memo TEXT COMMENT 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ¡ãƒ¢',
    sent_at TIMESTAMP COMMENT 'é€ä»˜æ—¥æ™‚',
    accepted_at TIMESTAMP COMMENT 'æ‰¿è«¾æ—¥æ™‚',
    rejected_at TIMESTAMP COMMENT 'æ‹’å¦æ—¥æ™‚',
    rejected_reason TEXT COMMENT 'æ‹’å¦ç†ç”±',
    version INTEGER DEFAULT 1 COMMENT 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    created_by VARCHAR(100) COMMENT 'ä½œæˆè€…',
    updated_by VARCHAR(100) COMMENT 'æ›´æ–°è€…',
    
    CONSTRAINT fk_order_company 
        FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE RESTRICT
);

CREATE INDEX idx_order_company ON orders(company_id);
CREATE INDEX idx_order_year_month ON orders(order_year_month);
CREATE INDEX idx_order_status ON orders(status);
CREATE INDEX idx_order_date ON orders(request_date);
CREATE INDEX idx_order_company_status ON orders(company_id, status);
```

### 5.2 order_details (ç™ºæ³¨æ˜ç»†ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE order_details (
    id BIGSERIAL PRIMARY KEY,
    detail_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ˜ç»†ID',
    order_id VARCHAR(50) NOT NULL COMMENT 'ç™ºæ³¨ID',
    branch_code VARCHAR(20) NOT NULL COMMENT 'æ”¯ç‚¹ã‚³ãƒ¼ãƒ‰',
    branch_name VARCHAR(100) NOT NULL COMMENT 'æ”¯ç‚¹ãƒ»å–¶æ¥­æ‰€å',
    line_code VARCHAR(20) NOT NULL COMMENT 'ç·šä¾¿ã‚³ãƒ¼ãƒ‰',
    line_name VARCHAR(100) COMMENT 'ç·šä¾¿å',
    route_type VARCHAR(50) COMMENT 'ç³»çµ±',
    warehouse_location VARCHAR(200) COMMENT 'å…¥åº«å ´æ‰€',
    warehouse_time TIME COMMENT 'å…¥åº«æ™‚é–“',
    vehicle_type VARCHAR(100) COMMENT 'ä½¿ç”¨è»Šä¸¡',
    status ENUM('pending', 'confirmed', 'rejected') DEFAULT 'pending' COMMENT 'æ‰¿èªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    
    CONSTRAINT fk_detail_order 
        FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE
);

CREATE INDEX idx_detail_order ON order_details(order_id);
CREATE INDEX idx_detail_line ON order_details(line_code);
```

### 5.3 order_schedules (é‹è¡ŒæŒ‡ç¤ºæ—¥ç¨‹ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE order_schedules (
    id BIGSERIAL PRIMARY KEY,
    schedule_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ—¥ç¨‹ID',
    order_id VARCHAR(50) NOT NULL COMMENT 'ç™ºæ³¨ID',
    detail_id VARCHAR(50) COMMENT 'ç™ºæ³¨æ˜ç»†ID',
    version INTEGER NOT NULL DEFAULT 1 COMMENT 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³',
    schedule_date DATE NOT NULL COMMENT 'æ—¥ç¨‹æ—¥',
    morning_flag BOOLEAN DEFAULT FALSE COMMENT 'AMç™º',
    afternoon_flag BOOLEAN DEFAULT FALSE COMMENT 'ç€',
    week_monday BOOLEAN DEFAULT FALSE COMMENT 'æœˆ',
    week_tuesday BOOLEAN DEFAULT FALSE COMMENT 'ç«',
    week_wednesday BOOLEAN DEFAULT FALSE COMMENT 'æ°´',
    week_thursday BOOLEAN DEFAULT FALSE COMMENT 'æœ¨',
    week_friday BOOLEAN DEFAULT FALSE COMMENT 'é‡‘',
    week_saturday BOOLEAN DEFAULT FALSE COMMENT 'åœŸ',
    week_sunday BOOLEAN DEFAULT FALSE COMMENT 'æ—¥',
    is_holiday BOOLEAN DEFAULT FALSE COMMENT 'ç¥',
    change_flag BOOLEAN DEFAULT FALSE COMMENT 'å¤‰æ›´',
    change_detail TEXT COMMENT 'å¤‰æ›´å†…å®¹',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    
    CONSTRAINT fk_schedule_order 
        FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE CASCADE
);

CREATE INDEX idx_schedule_order ON order_schedules(order_id);
CREATE INDEX idx_schedule_date ON order_schedules(schedule_date);
CREATE INDEX idx_schedule_version ON order_schedules(order_id, version);
```

---

## 6. å®Ÿç¸¾ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 6.1 completed_orders (å®Ÿç¸¾ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE completed_orders (
    id BIGSERIAL PRIMARY KEY,
    completed_order_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'å®Ÿç¸¾ID',
    order_id VARCHAR(50) NOT NULL COMMENT 'é–¢é€£ç™ºæ³¨ID',
    company_id VARCHAR(50) NOT NULL COMMENT 'ä¼šç¤¾ID',
    completed_order_year_month VARCHAR(7) NOT NULL COMMENT 'å®Ÿç¸¾å¹´æœˆ(YYYY-MM)',
    total_amount DECIMAL(12, 2) NOT NULL DEFAULT 0 COMMENT 'åˆè¨ˆé‡‘é¡',
    status ENUM('pending', 'confirmed', 'rejected') NOT NULL DEFAULT 'pending' COMMENT 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    confirmed_at TIMESTAMP COMMENT 'ç¢ºå®šæ—¥æ™‚',
    sent_at TIMESTAMP COMMENT 'é€ä»˜æ—¥æ™‚',
    accepted_at TIMESTAMP COMMENT 'æ‰¿è«¾æ—¥æ™‚',
    version INTEGER DEFAULT 1 COMMENT 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    created_by VARCHAR(100) COMMENT 'ä½œæˆè€…',
    updated_by VARCHAR(100) COMMENT 'æ›´æ–°è€…',
    
    CONSTRAINT fk_completed_order_order 
        FOREIGN KEY (order_id) REFERENCES orders(order_id) ON DELETE RESTRICT,
    CONSTRAINT fk_completed_order_company 
        FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE RESTRICT
);

CREATE INDEX idx_completed_order_order ON completed_orders(order_id);
CREATE INDEX idx_completed_order_company ON completed_orders(company_id);
CREATE INDEX idx_completed_order_year_month ON completed_orders(completed_order_year_month);
CREATE INDEX idx_completed_order_status ON completed_orders(status);
```

### 6.2 daily_rates (æ—¥åˆ¥å‚­è»Šè²»ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE daily_rates (
    id BIGSERIAL PRIMARY KEY,
    rate_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'è²»ç”¨ID',
    completed_order_id VARCHAR(50) NOT NULL COMMENT 'å®Ÿç¸¾ID',
    line_code VARCHAR(20) NOT NULL COMMENT 'ç·šä¾¿ã‚³ãƒ¼ãƒ‰',
    line_name VARCHAR(100) NOT NULL COMMENT 'ç·šä¾¿å',
    version INTEGER DEFAULT 1 COMMENT 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³',
    amount_monday DECIMAL(10, 2) DEFAULT 0 COMMENT 'æœˆ',
    amount_tuesday DECIMAL(10, 2) DEFAULT 0 COMMENT 'ç«',
    amount_wednesday DECIMAL(10, 2) DEFAULT 0 COMMENT 'æ°´',
    amount_thursday DECIMAL(10, 2) DEFAULT 0 COMMENT 'æœ¨',
    amount_friday DECIMAL(10, 2) DEFAULT 0 COMMENT 'é‡‘',
    amount_saturday DECIMAL(10, 2) DEFAULT 0 COMMENT 'åœŸ',
    amount_sunday DECIMAL(10, 2) DEFAULT 0 COMMENT 'æ—¥',
    status ENUM('pending', 'confirmed', 'rejected') DEFAULT 'pending' COMMENT 'æ‰¿èªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    rejection_reason TEXT COMMENT 'å·®æˆ»ã—ç†ç”±',
    change_flag BOOLEAN DEFAULT FALSE COMMENT 'å¤‰æ›´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    
    CONSTRAINT fk_rate_completed_order 
        FOREIGN KEY (completed_order_id) REFERENCES completed_orders(completed_order_id) ON DELETE CASCADE
);

CREATE INDEX idx_daily_rate_completed_order ON daily_rates(completed_order_id);
CREATE INDEX idx_daily_rate_line ON daily_rates(line_code);
CREATE INDEX idx_daily_rate_version ON daily_rates(completed_order_id, version);
```

---

## 7. è«‹æ±‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 7.1 billings (è«‹æ±‚ãƒã‚¹ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE billings (
    id BIGSERIAL PRIMARY KEY,
    billing_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'è«‹æ±‚ID',
    billing_year_month VARCHAR(7) NOT NULL COMMENT 'è«‹æ±‚å¹´æœˆ(YYYY-MM)',
    company_id VARCHAR(50) NOT NULL COMMENT 'ä¼šç¤¾ID',
    amount DECIMAL(12, 2) NOT NULL DEFAULT 0 COMMENT 'è«‹æ±‚é‡‘é¡',
    status ENUM('pending', 'issued', 'paid', 'cancelled') NOT NULL DEFAULT 'pending' COMMENT 'è«‹æ±‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    issue_date DATE NOT NULL COMMENT 'ç™ºè¡Œæ—¥',
    due_date DATE COMMENT 'æ”¯æ‰•æœŸé™',
    paid_date DATE COMMENT 'æ”¯æ‰•æ—¥',
    base_name VARCHAR(200) NOT NULL COMMENT 'ãƒ™ãƒ¼ã‚¹å',
    memo TEXT COMMENT 'å‚™è€ƒ',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    created_by VARCHAR(100) COMMENT 'ä½œæˆè€…',
    updated_by VARCHAR(100) COMMENT 'æ›´æ–°è€…',
    
    CONSTRAINT fk_billing_company 
        FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE RESTRICT
);

CREATE INDEX idx_billing_company ON billings(company_id);
CREATE INDEX idx_billing_year_month ON billings(billing_year_month);
CREATE INDEX idx_billing_status ON billings(status);
CREATE INDEX idx_billing_issue_date ON billings(issue_date);
CREATE INDEX idx_billing_company_status ON billings(company_id, status);
```

### 7.2 billing_details (è«‹æ±‚æ˜ç»†ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE billing_details (
    id BIGSERIAL PRIMARY KEY,
    detail_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ˜ç»†ID',
    billing_id VARCHAR(50) NOT NULL COMMENT 'è«‹æ±‚ID',
    line_code VARCHAR(20) NOT NULL COMMENT 'ç·šä¾¿ã‚³ãƒ¼ãƒ‰',
    line_name VARCHAR(100) NOT NULL COMMENT 'ç·šä¾¿å',
    daily_rate DECIMAL(10, 2) NOT NULL COMMENT 'æ—¥åˆ¥å‚­è»Šè²»',
    days INTEGER NOT NULL COMMENT 'æ—¥æ•°',
    amount DECIMAL(10, 2) NOT NULL COMMENT 'é‡‘é¡(daily_rate Ã— days)',
    description TEXT COMMENT 'èª¬æ˜',
    sort_order INTEGER DEFAULT 0 COMMENT 'ä¸¦ã³é †',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¥æ™‚',
    
    CONSTRAINT fk_billing_detail 
        FOREIGN KEY (billing_id) REFERENCES billings(billing_id) ON DELETE CASCADE
);

CREATE INDEX idx_billing_detail ON billing_details(billing_id);
CREATE INDEX idx_billing_detail_line ON billing_details(line_code);
```

---

## 8. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 8.1 upload_history (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE upload_history (
    id BIGSERIAL PRIMARY KEY,
    upload_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ID',
    company_id VARCHAR(50) NOT NULL COMMENT 'ä¼šç¤¾ID',
    file_name VARCHAR(255) NOT NULL COMMENT 'ãƒ•ã‚¡ã‚¤ãƒ«å',
    file_type ENUM('csv', 'excel') NOT NULL COMMENT 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—',
    file_size BIGINT NOT NULL COMMENT 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º(bytes)',
    upload_mode ENUM('add', 'overwrite') NOT NULL DEFAULT 'add' COMMENT 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰',
    error_handling ENUM('stop', 'continue') NOT NULL DEFAULT 'stop' COMMENT 'ã‚¨ãƒ©ãƒ¼å‡¦ç†',
    status ENUM('pending', 'validating', 'processing', 'success', 'partial_success', 'failed') NOT NULL DEFAULT 'pending' COMMENT 'å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
    record_count INTEGER DEFAULT 0 COMMENT 'ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°',
    success_count INTEGER DEFAULT 0 COMMENT 'æˆåŠŸä»¶æ•°',
    failed_count INTEGER DEFAULT 0 COMMENT 'å¤±æ•—ä»¶æ•°',
    error_message TEXT COMMENT 'ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
    memo TEXT COMMENT 'å‚™è€ƒ',
    uploaded_by VARCHAR(100) NOT NULL COMMENT 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è€…',
    uploaded_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚',
    processed_at TIMESTAMP COMMENT 'å‡¦ç†å®Œäº†æ—¥æ™‚',
    processing_time INTEGER COMMENT 'å‡¦ç†æ™‚é–“(ç§’)',
    
    CONSTRAINT fk_upload_company 
        FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE RESTRICT
);

CREATE INDEX idx_upload_company ON upload_history(company_id);
CREATE INDEX idx_upload_status ON upload_history(status);
CREATE INDEX idx_uploaded_at ON upload_history(uploaded_at);
```

### 8.2 upload_error_details (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒ‡ãƒ†ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«)

```sql
CREATE TABLE upload_error_details (
    id BIGSERIAL PRIMARY KEY,
    error_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ã‚¨ãƒ©ãƒ¼ID',
    upload_id VARCHAR(50) NOT NULL COMMENT 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ID',
    row_number INTEGER NOT NULL COMMENT 'ã‚¨ãƒ©ãƒ¼è¡Œç•ªå·',
    column_name VARCHAR(100) COMMENT 'ã‚¨ãƒ©ãƒ¼åˆ—å',
    error_type VARCHAR(50) NOT NULL COMMENT 'ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—',
    error_message TEXT NOT NULL COMMENT 'ã‚¨ãƒ©ãƒ¼å†…å®¹',
    original_value TEXT COMMENT 'å…ƒã®å€¤',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    
    CONSTRAINT fk_error_upload 
        FOREIGN KEY (upload_id) REFERENCES upload_history(upload_id) ON DELETE CASCADE
);

CREATE INDEX idx_error_upload ON upload_error_details(upload_id);
```

---

## 9. ç›£æŸ»ãƒ­ã‚°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### 9.1 action_history (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¹ãƒˆãƒªã‚¢ãƒ–ãƒ«)

```sql
CREATE TABLE action_history (
    id BIGSERIAL PRIMARY KEY,
    history_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'å±¥æ­´ID',
    company_id VARCHAR(50) COMMENT 'ä¼šç¤¾ID',
    company_name VARCHAR(200) COMMENT 'ä¼šç¤¾å',
    action_year_month VARCHAR(7) COMMENT 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å¹´æœˆ(YYYY-MM)',
    action_date TIMESTAMP NOT NULL COMMENT 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ—¥æ™‚',
    action_type VARCHAR(50) NOT NULL COMMENT 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—',
    action_detail TEXT COMMENT 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è©³ç´°',
    performed_by VARCHAR(100) COMMENT 'å®Ÿè¡Œè€…',
    remarks TEXT COMMENT 'å‚™è€ƒ',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'ä½œæˆæ—¥æ™‚',
    
    CONSTRAINT fk_action_company 
        FOREIGN KEY (company_id) REFERENCES partner_companies(company_id) ON DELETE SET NULL
);

CREATE INDEX idx_action_company ON action_history(company_id);
CREATE INDEX idx_action_date ON action_history(action_date);
CREATE INDEX idx_action_year_month ON action_history(action_year_month);
CREATE INDEX idx_action_performer ON action_history(performed_by);
```

---

## 10. æ¨©é™ãƒãƒˆãƒªã‚¯ã‚¹è¨­è¨ˆ

### 10.1 ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¨©é™å®šç¾©

| æ¨©é™é …ç›® | ç®¡ç†è€… | å½¹å‰²è€… | é…è»Šæ‹…å½“è€… | è¨ˆä¸Šæ‹…å½“è€… |
|----------|--------|--------|------------|------------|
| æ¨©é™ä»˜ä¸ | ç·¨é›†å¯ | é–²è¦§ä¸å¯ | é–²è¦§ä¸å¯ | é–²è¦§ä¸å¯ |
| æ‰¿èª | ç·¨é›†å¯ | é–²è¦§ã®ã¿ | é–²è¦§ã®ã¿ | é–²è¦§ã®ã¿ |
| ãƒã‚¹ã‚¿ç®¡ç† | ç·¨é›†å¯ | ç·¨é›†å¯ | é–²è¦§ä¸å¯ | é–²è¦§ä¸å¯ |
| ç™ºæ³¨ | é–²è¦§ã®ã¿ | ç·¨é›†å¯ | ç·¨é›†å¯ | é–²è¦§ä¸å¯ |
| è¨ˆä¸Š | é–²è¦§ã®ã¿ | é–²è¦§ä¸å¯ | é–²è¦§ã®ã¿ | ç·¨é›†å¯ |

### 10.2 ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ã‚¹ãƒ†ãƒ æ©Ÿèƒ½æ¨©é™

| æ©Ÿèƒ½ | ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ |
|------|-----------|
| ç™ºæ³¨æ¤œç´¢ | é–²è¦§ã®ã¿ |
| ç™ºæ³¨è©³ç´° | é–²è¦§ã®ã¿/æ‰¿è«¾/å´ä¸‹ |
| å®Ÿç¸¾ç¢ºèª | é–²è¦§ã®ã¿ |
| è«‹æ±‚æ¤œç´¢ | é–²è¦§ã®ã¿ |
| è«‹æ±‚è©³ç´° | é–²è¦§ã®ã¿ |
| æƒ…å ±ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ | ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯ |

---

## 11. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–æˆ¦ç•¥

### 11.1 å¸¸ç”¨ã‚¯ã‚¨ãƒªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
-- ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_partner_company_search ON partner_companies(company_name, company_phone, system_use);

-- ç™ºæ³¨æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_order_search ON orders(company_id, order_year_month, status, request_date);

-- å®Ÿç¸¾æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_completed_order_search ON completed_orders(company_id, completed_order_year_month, status);

-- è«‹æ±‚æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_billing_search ON billings(company_id, billing_year_month, status, issue_date);

-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¹ãƒˆãƒªã‚¢æ¤œç´¢ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_action_search ON action_history(company_id, action_year_month, action_date);
```

---

## 12. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 12.1 ãƒ‡ãƒ¼ã‚¿ãƒã‚¹ã‚­ãƒ³ã‚°æˆ¦ç•¥

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | ãƒã‚¹ã‚­ãƒ³ãƒ«ãƒ¼ãƒ« | ä¾‹ |
|------|------|------|
| email | å‰2æ–‡å­— + *** + @domain | ab***@example.com |
| phone | å‰3æ–‡å­— + **** + å¾Œ4æ–‡å­— | 090****1234 |
| personal_sms | å‰3æ–‡å­— + **** + å¾Œ4æ–‡å­— | 090****1234 |

### 12.2 ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ãƒ«ãƒ¼ãƒ«

| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ— | è¨˜éŒ²å†…å®¹ |
|------|------|
| CREATE | ä½œæˆãƒ‡ãƒ¼ã‚¿ã€ä½œæˆè€…ã€ä½œæˆæ—¥æ™‚ |
| UPDATE | å¤‰æ›´å‰å¾Œã®å€¤ã€æ›´æ–°è€…ã€æ›´æ–°æ—¥æ™‚ |
| DELETE | å‰Šé™¤ãƒ‡ãƒ¼ã‚¿ã€å‰Šé™¤è€…ã€å‰Šé™¤æ—¥æ™‚ |
| LOGIN | ãƒ­ã‚°ã‚¤ãƒ³IPã€ãƒ­ã‚°ã‚¤ãƒ³æ—¥æ™‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ |
| LOGOUT | ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ—¥æ™‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ |
| EXPORT | ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç¯„å›²ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè€…ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥æ™‚ |

---

## 13. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

### 13.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™

| æŒ‡æ¨™ | è¦ä»¶ |
|------|------|
| ã‚·ãƒ³ãƒ—ãƒ«ã‚¯ã‚¨ãƒªå¿œç­”æ™‚é–“ | < 100ms |
| è¤‡é›‘ã‚¯ã‚¨ãƒªå¿œç­”æ™‚é–“ | < 1s |
| ãƒãƒƒãƒã‚¤ãƒ³ã‚µãƒ¼ãƒˆé€Ÿåº¦ | > 1000 rows/s |
| å¸³ç¥¨ã‚¯ã‚¨ãƒªå¿œç­”æ™‚é–“ | < 5s |
| æœ€å¤§åŒæ™‚æ¥ç¶šæ•° | > 500 |

### 13.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

| ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ— | ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ | æœ‰åŠ¹æœŸé™ |
|------|------|------|
| ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¸€è¦§ | Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ | 5åˆ† |
| ãƒ™ãƒ¼ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸€è¦§ | Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ | 5åˆ† |
| ç”»é¢è¨­å®š | Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ | 30åˆ† |
| æ¨©é™è¨­å®š | Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ | 30åˆ† |
| ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ã‚¹ãƒˆãƒªã‚¢ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã— | - |

---

## 14. å¤‰æ›´ãƒ­ã‚°

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | ä½œæˆè€… |
|------|------|---------|------|
| 2026-02-XX| v1.0 | åˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ | - |

---

**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ**: -  
**ä½œæˆæ—¥æ™‚**: 2026-02-XX 
**é©ç”¨ç¯„å›²**: å¤§è³€è¼¸é€æ–°ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ  
**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**: PostgreSQL 15.x
