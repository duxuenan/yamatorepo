# 大贺运输新系统 - 数据库设计摘要

## 一、数据库概览

| 数据库 | PostgreSQL 15.x |
|--------|-----------------|
| 字符集 | UTF-8 |
| 排序规则 | ja_JP.UTF-8 |

---

## 二、核心业务表

### 1. m_user - 合作伙伴用户表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| user_id | VARCHAR(50) | UNIQUE, NOT NULL | 用户ID |
| user_name | VARCHAR(200) | NOT NULL | 用户名 |
| email | VARCHAR(200) | UNIQUE, NOT NULL | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| partner_id | VARCHAR(50) | FK -> partner_companies | 所属合作伙伴 |
| role | VARCHAR(20) | DEFAULT 'user' | 角色 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |
| last_login_at | TIMESTAMP | | 最后登录时间 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

> 注：合作伙伴用户使用 `partner_users` 表（DDL: partner_users）

### 2. m_screen - 画面表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| screen_id | VARCHAR(20) | UNIQUE | 画面ID |
| screen_name | VARCHAR(100) | NOT NULL | 画面名称 |
| category | VARCHAR(50) | | 分类 |
| route_path | VARCHAR(100) | | 路由路径 |
| device_pc | BOOLEAN | DEFAULT FALSE | PC对应 |
| device_sp | BOOLEAN | DEFAULT FALSE | SP对应 |
| sort_order | INTEGER | DEFAULT 0 | 排序 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

### 3. m_permission - 权限表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| role_id | VARCHAR(20) | NOT NULL | 角色ID |
| screen_id | VARCHAR(20) | NOT NULL | 画面ID |
| access_level | INTEGER | DEFAULT 0 | 访问级别(0-无,1-只读,2-可写) |
| can_read | BOOLEAN | DEFAULT FALSE | 可读 |
| can_write | BOOLEAN | DEFAULT FALSE | 可写 |
| can_delete | BOOLEAN | DEFAULT FALSE | 可删 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

### 4. partner_companies - 合作伙伴公司表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| company_id | VARCHAR(50) | UNIQUE, NOT NULL | 公司ID |
| company_name | VARCHAR(200) | NOT NULL | 公司名称 |
| company_phone | VARCHAR(20) | NOT NULL | 联系电话 |
| system_use | BOOLEAN | DEFAULT TRUE | 系统使用 |
| instruction_text | VARCHAR(20) | DEFAULT '文言1' | 指示文 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态 |
| memo | TEXT | | 备注 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 5. partner_company_codes - 合作伙伴公司代码表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| code_id | VARCHAR(50) | NOT NULL | 代码ID |
| company_id | VARCHAR(50) | FK | 所属公司 |
| code_type | VARCHAR(20) | NOT NULL | 代码类型 |
| code_value | VARCHAR(100) | NOT NULL | 代码值 |
| display_order | INTEGER | DEFAULT 0 | 显示顺序 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |

### 6. base_accounts - 基础账户表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| user_id | VARCHAR(50) | UNIQUE, NOT NULL | 用户ID |
| user_name | VARCHAR(200) | NOT NULL | 用户名 |
| email | VARCHAR(200) | UNIQUE, NOT NULL | 邮箱 |
| affiliation | VARCHAR(200) | NOT NULL | 所属 |
| permission | VARCHAR(20) | DEFAULT 'operator' | 权限(admin/operator/dispatcher/accountant) |
| account_status | VARCHAR(20) | DEFAULT 'active' | 账户状态 |
| azure_ad_id | VARCHAR(100) | | AzureAD ID |
| roles | TEXT[] | | 角色列表 |
| permissions | TEXT[] | | 权限列表 |
| last_login_at | TIMESTAMP | | 最后登录 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 7. base_list - 基地列表表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| base_id | VARCHAR(50) | UNIQUE, NOT NULL | 基地ID |
| base_name | VARCHAR(200) | NOT NULL | 基地名称 |
| base_type | VARCHAR(20) | NOT NULL | 基地类型 |
| address | TEXT | | 地址 |
| phone | VARCHAR(20) | | 电话 |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |
| sort_order | INTEGER | DEFAULT 0 | 排序 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 8. orders - 订单表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| order_id | VARCHAR(50) | UNIQUE, NOT NULL | 订单ID |
| company_id | VARCHAR(50) | FK -> partner_companies | 公司ID |
| order_year_month | VARCHAR(7) | NOT NULL | 订单年月 |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态 |
| request_detail | TEXT | | 请求详情 |
| request_date | DATE | NOT NULL | 请求日 |
| deadline | DATE | | 期限日 |
| partner_memo | TEXT | | 合作伙伴备注 |
| sent_at | TIMESTAMP | | 发送时间 |
| accepted_at | TIMESTAMP | | 接受时间 |
| rejected_at | TIMESTAMP | | 拒绝时间 |
| rejected_reason | TEXT | | 拒绝理由 |
| version | INTEGER | DEFAULT 1 | 版本号 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 9. order_details - 订单明细表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| detail_id | VARCHAR(50) | UNIQUE, NOT NULL | 明细ID |
| order_id | VARCHAR(50) | FK -> orders | 订单ID |
| line_code | VARCHAR(20) | NOT NULL | 线路代码 |
| line_name | VARCHAR(100) | NOT NULL | 线路名称 |
| work_type | VARCHAR(50) | | 工作类型 |
| cargo_type | VARCHAR(50) | | 货物类型 |
| weight | DECIMAL(10,2) | | 重量(kg) |
| volume | DECIMAL(10,3) | | 体积(m³) |
| pickup_address | TEXT | | 提货地址 |
| delivery_address | TEXT | | 送货地址 |
| scheduled_pickup | TIMESTAMP | | 计划提货时间 |
| scheduled_delivery | TIMESTAMP | | 计划送货时间 |
| unit_price | DECIMAL(10,2) | | 单价 |
| quantity | INTEGER | DEFAULT 1 | 数量 |
| amount | DECIMAL(12,2) | | 金额 |
| remark | TEXT | | 备注 |

### 10. completed_orders - 实绩表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| completed_order_id | VARCHAR(50) | UNIQUE, NOT NULL | 实绩ID |
| order_id | VARCHAR(50) | FK -> orders | 关联订单ID |
| company_id | VARCHAR(50) | FK -> partner_companies | 公司ID |
| completed_order_year_month | VARCHAR(7) | NOT NULL | 实绩年月 |
| total_amount | DECIMAL(12,2) | DEFAULT 0 | 合计金额 |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态 |
| confirmed_at | TIMESTAMP | | 确认时间 |
| sent_at | TIMESTAMP | | 发送时间 |
| accepted_at | TIMESTAMP | | 接受时间 |
| version | INTEGER | DEFAULT 1 | 版本号 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 11. daily_rates - 日别傭车费表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| rate_id | VARCHAR(50) | UNIQUE, NOT NULL | 费用ID |
| completed_order_id | VARCHAR(50) | FK -> completed_orders | 实绩ID |
| line_code | VARCHAR(20) | NOT NULL | 线路代码 |
| line_name | VARCHAR(100) | NOT NULL | 线路名称 |
| version | INTEGER | DEFAULT 1 | 版本号 |
| amount_monday | DECIMAL(10,2) | DEFAULT 0 | 周一 |
| amount_tuesday | DECIMAL(10,2) | DEFAULT 0 | 周二 |
| amount_wednesday | DECIMAL(10,2) | DEFAULT 0 | 周三 |
| amount_thursday | DECIMAL(10,2) | DEFAULT 0 | 周四 |
| amount_friday | DECIMAL(10,2) | DEFAULT 0 | 周五 |
| amount_saturday | DECIMAL(10,2) | DEFAULT 0 | 周六 |
| amount_sunday | DECIMAL(10,2) | DEFAULT 0 | 周日 |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态 |
| rejection_reason | TEXT | | 拒绝理由 |
| change_flag | BOOLEAN | DEFAULT FALSE | 变更标志 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 12. billings - 账单表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| billing_id | VARCHAR(50) | UNIQUE, NOT NULL | 账单ID |
| billing_year_month | VARCHAR(7) | NOT NULL | 账单年月 |
| company_id | VARCHAR(50) | FK -> partner_companies | 公司ID |
| amount | DECIMAL(12,2) | DEFAULT 0 | 金额 |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态 |
| issue_date | DATE | NOT NULL | 发布日 |
| due_date | DATE | | 到期日 |
| paid_date | DATE | | 支付日 |
| remark | TEXT | | 备注 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 13. billing_details - 账单明细表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| detail_id | VARCHAR(50) | UNIQUE, NOT NULL | 明细ID |
| billing_id | VARCHAR(50) | FK -> billings | 账单ID |
| completed_order_id | VARCHAR(50) | FK -> completed_orders | 实绩ID |
| description | VARCHAR(200) | | 说明 |
| amount | DECIMAL(12,2) | NOT NULL | 金额 |
| tax_rate | DECIMAL(5,2) | | 税率 |
| tax_amount | DECIMAL(12,2) | | 税额 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

### 14. upload_history - CSV上传历史表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| upload_id | VARCHAR(50) | UNIQUE, NOT NULL | 上传ID |
| company_id | VARCHAR(50) | FK -> partner_companies | 公司ID |
| file_name | VARCHAR(255) | NOT NULL | 文件名 |
| file_type | VARCHAR(20) | NOT NULL | 文件类型 |
| upload_mode | VARCHAR(20) | DEFAULT 'add' | 上传模式 |
| error_handling | VARCHAR(20) | DEFAULT 'stop' | 错误处理 |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态 |
| record_count | INTEGER | | 记录数 |
| success_count | INTEGER | | 成功数 |
| failed_count | INTEGER | | 失败数 |
| uploaded_by | VARCHAR(100) | | 上传人 |
| uploaded_at | TIMESTAMP | DEFAULT NOW() | 上传时间 |
| processed_at | TIMESTAMP | | 处理完成时间 |
| processing_time | INTEGER | | 处理时间(秒) |

### 15. upload_error_details - 上传错误详情表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| error_id | VARCHAR(50) | UNIQUE, NOT NULL | 错误ID |
| upload_id | VARCHAR(50) | FK -> upload_history | 上传ID |
| row_number | INTEGER | NOT NULL | 行号 |
| column_name | VARCHAR(100) | | 列名 |
| error_type | VARCHAR(50) | | 错误类型 |
| error_message | TEXT | | 错误信息 |
| original_value | TEXT | | 原始值 |

### 16. action_history - 操作历史表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| action_id | VARCHAR(50) | UNIQUE, NOT NULL | 操作ID |
| action_type | VARCHAR(50) | NOT NULL | 操作类型 |
| action_name | VARCHAR(200) | NOT NULL | 操作名称 |
| module_type | VARCHAR(50) | NOT NULL | 模块类型 |
| related_id | VARCHAR(50) | | 关联ID |
| before_value | JSONB | | 修改前值 |
| after_value | JSONB | | 修改后值 |
| ip_address | VARCHAR(45) | | IP地址 |
| user_agent | TEXT | | 用户代理 |
| performed_by | VARCHAR(100) | | 操作人 |
| performed_at | TIMESTAMP | DEFAULT NOW() | 操作时间 |

### 17. messages - 消息表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| message_id | VARCHAR(50) | UNIQUE, NOT NULL | 消息ID |
| related_type | VARCHAR(50) | | 关联类型 |
| related_id | VARCHAR(50) | | 关联ID |
| content | TEXT | NOT NULL | 消息内容 |
| sender_id | VARCHAR(50) | | 发送者ID |
| sender_name | VARCHAR(100) | | 发送者名称 |
| sender_type | VARCHAR(20) | | 发送者类型 |
| recipient_id | VARCHAR(50) | | 接收者ID |
| is_read | BOOLEAN | DEFAULT FALSE | 已读标志 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

### 18. t_invoice_file - 請求書文件表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| invoice_id | VARCHAR(50) | UNIQUE, NOT NULL | 請求書ID |
| partner_id | VARCHAR(50) | FK -> partner_companies | 合作伙伴ID |
| base_id | VARCHAR(50) | FK -> base_list | 基地ID |
| company_code | VARCHAR(20) | NOT NULL | 公司代码 |
| file_name | VARCHAR(255) | NOT NULL | 文件名 |
| file_path | VARCHAR(500) | NOT NULL | 文件路径 |
| file_size | BIGINT | NOT NULL | 文件大小 |
| target_month | VARCHAR(7) | NOT NULL |対象月 |
| status | VARCHAR(20) | NOT NULL | 状态 |
| last_action | VARCHAR(100) | | 最后操作 |
| uploaded_by | VARCHAR(50) | NOT NULL | 上传人 |
| uploaded_at | TIMESTAMP | NOT NULL | 上传时间 |
| updated_by | VARCHAR(50) | | 更新人 |
| updated_at | TIMESTAMP | | 更新时间 |
| deleted_at | TIMESTAMP | | 删除时间 |

### 19. t_invoice_send_log - 請求書发送日志表

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| log_id | VARCHAR(50) | UNIQUE, NOT NULL | 日志ID |
| invoice_id | VARCHAR(50) | FK -> t_invoice_file | 請求書ID |
| base_id | VARCHAR(50) | FK -> base_list | 基地ID |
| partner_id | VARCHAR(50) | FK -> partner_companies | 合作伙伴ID |
| sent_at | TIMESTAMP | NOT NULL | 发送时间 |
| sent_by | VARCHAR(50) | NOT NULL | 发送者 |
| status | VARCHAR(20) | NOT NULL | 发送状态 |
| notification_sent | BOOLEAN | DEFAULT FALSE | 通知发送 |
| remarks | TEXT | | 备注 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

---

## 三、关联表

### r_partner_base - 合作伙伴-基地关联

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| partner_id | VARCHAR(50) | FK -> partner_companies | 合作伙伴ID |
| base_id | VARCHAR(50) | FK -> base_list | 基地ID |
| is_active | BOOLEAN | DEFAULT TRUE | 是否激活 |
| created_at | TIMESTAMP | DEFAULT NOW() | 创建时间 |

### partner_audit_log - 合作伙伴审计日志

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| log_id | VARCHAR(50) | UNIQUE, NOT NULL | 日志ID |
| company_id | VARCHAR(50) | FK -> partner_companies | 公司ID |
| action_type | VARCHAR(50) | | 操作类型 |
| before_value | JSONB | | 修改前值 |
| after_value | JSONB | | 修改后值 |
| performed_by | VARCHAR(100) | | 操作人 |
| performed_at | TIMESTAMP | DEFAULT NOW() | 操作时间 |

### base_account_audit_log - 基础账户审计日志

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | BIGSERIAL | PK | 主键 |
| log_id | VARCHAR(50) | UNIQUE, NOT NULL | 日志ID |
| user_id | VARCHAR(50) | FK -> base_accounts | 用户ID |
| action_type | VARCHAR(50) | | 操作类型 |
| before_value | JSONB | | 修改前值 |
| after_value | JSONB | | 修改后值 |
| ip_address | VARCHAR(45) | | IP地址 |
| performed_by | VARCHAR(100) | | 操作人 |
| performed_at | TIMESTAMP | DEFAULT NOW() | 操作时间 |

---

## 四、枚举值参考

### 订单状态 (orders.status)
- `pending` - 待处理
- `accepted` - 已接受
- `rejected` - 已拒绝
- `expired` - 已过期
- `cancelled` - 已取消

### 实绩状态 (completed_orders.status)
- `pending` - 未确定
- `confirmed` - 已确认
- `rejected` - 已拒绝

### 日别傭车费状态 (daily_rates.status)
- `pending` - 未确认
- `confirmed` - 已确认
- `rejected` - 有异议

### 账单状态 (billings.status)
- `pending` - 待处理
- `issued` - 已发布
- `paid` - 已支付
- `cancelled` - 已取消

### 請求書状态 (t_invoice_file.status)
- `uploaded` - 已上传
- `sent` - 已发送
- `deleted` - 已删除

### 账户权限 (base_accounts.permission)
- `admin` - 管理者
- `operator` - 操作员
- `dispatcher` - 调度员
- `accountant` - 会计

### 账户状态 (base_accounts.account_status)
- `active` - 有效
- `inactive` - 无效

### 基地类型 (base_list.base_type)
- `base` - 基地
- `headquarters` - 本社

### 消息发送者类型 (messages.sender_type)
- `partner` - 合作伙伴
- `base` - 基地

---

## 五、索引设计

### 主键索引
```sql
CREATE UNIQUE INDEX uk_user_id ON m_user(user_id);
CREATE UNIQUE INDEX uk_screen_id ON m_screen(screen_id);
CREATE UNIQUE INDEX uk_company_id ON partner_companies(company_id);
CREATE UNIQUE INDEX uk_order_id ON orders(order_id);
CREATE UNIQUE INDEX uk_completed_order_id ON completed_orders(completed_order_id);
CREATE UNIQUE INDEX uk_billing_id ON billings(billing_id);
```

### 搜索索引
```sql
CREATE INDEX idx_order_status ON orders(status);
CREATE INDEX idx_order_company ON orders(company_id);
CREATE INDEX idx_completed_order ON completed_orders(order_id);
CREATE INDEX idx_completed_order_company ON completed_orders(company_id);
CREATE INDEX idx_completed_order_month ON completed_orders(completed_order_year_month);
CREATE INDEX idx_billing_company ON billings(company_id);
CREATE INDEX idx_billing_status ON billings(status);
CREATE INDEX idx_base_accounts_email ON base_accounts(email);
CREATE INDEX idx_base_accounts_affiliation ON base_accounts(affiliation);
CREATE INDEX idx_upload_history_company ON upload_history(company_id);
CREATE INDEX idx_upload_history_status ON upload_history(status);
CREATE INDEX idx_daily_rates_completed_order ON daily_rates(completed_order_id);
```

### 复合索引
```sql
CREATE INDEX idx_order_status_date ON orders(status, created_at DESC);
CREATE INDEX idx_completed_order_partner_month ON completed_orders(company_id, completed_order_year_month);
CREATE INDEX idx_daily_rates_version ON daily_rates(completed_order_id, version);
```

---

## 六、软删除与审计

### 软删除字段
主要表包含：
```sql
is_active BOOLEAN DEFAULT TRUE
deleted_at TIMESTAMP
```

### 时间戳字段
所有表包含：
```sql
created_at TIMESTAMP DEFAULT NOW()
updated_at TIMESTAMP
```

---

*文档版本: 2.0*
*更新时间: 2026-02-10*
*数据来源: 別紙_画面一覧_v151 各页面设计规范文档 + 02_DDLスクリプト.sql*
